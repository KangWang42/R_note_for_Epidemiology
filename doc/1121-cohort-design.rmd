---
title: é˜Ÿåˆ—ç ”ç©¶è®¾è®¡ä¸åˆ†æå®Œå…¨æŒ‡å—
date: '2026-01-25'
categories:
- ç»Ÿè®¡åˆ†ææ–¹æ³•
- ç ”ç©¶è®¾è®¡
- æµè¡Œç—…å­¦
image: images/cohort-design-cover.svg
description: é˜Ÿåˆ—ç ”ç©¶çš„è®¾è®¡åŸç†ã€äººæ—¶è®¡ç®—ã€å‘ç—…ç‡ä¼°è®¡ä¸Coxå›å½’åˆ†æå®Œæ•´æ•™ç¨‹
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 8,
  fig.height = 5,
  fig.retina = 2,
  out.width = "100%",
  dpi = 150
)
```

## æ–¹æ³•èƒŒæ™¯ä¸é€‚ç”¨åœºæ™¯

**é˜Ÿåˆ—ç ”ç©¶ï¼ˆCohort Studyï¼‰** æ˜¯æµè¡Œç—…å­¦ä¸­æœ€é‡è¦çš„åˆ†ææ€§ç ”ç©¶è®¾è®¡ä¹‹ä¸€ã€‚å®ƒé€‰æ‹©ä¸€ç»„æš´éœ²äºæŸå› ç´ çš„äººç¾¤å’Œä¸€ç»„æœªæš´éœ²çš„äººç¾¤ï¼Œ**éšæ—¶é—´è¿½è¸ª**è§‚å¯Ÿä¸¤ç»„çš„å‘ç—…æƒ…å†µï¼Œä»è€Œè¯„ä¼°æš´éœ²ä¸ç–¾ç—…çš„å› æœå…³ç³»ã€‚

### é€‚ç”¨åœºæ™¯

| ç ”ç©¶ç›®çš„ | å…¸å‹åº”ç”¨ |
|---------|---------|
| å› æœå…³ç³»éªŒè¯ | å¸çƒŸä¸è‚ºç™Œçš„å…³ç³» |
| å‘ç—…ç‡ä¼°è®¡ | æŸèŒä¸šäººç¾¤çš„èŒä¸šç—…å‘ç—…ç‡ |
| é¢„åå› ç´ ç ”ç©¶ | å½±å“ç™Œç—‡ç”Ÿå­˜çš„å› ç´  |
| æ²»ç–—æ•ˆæœè¯„ä¼° | çœŸå®ä¸–ç•Œä¸­è¯ç‰©çš„é•¿æœŸæ•ˆæœ |
| è‡ªç„¶å²ç ”ç©¶ | ç–¾ç—…ä»å‘ç”Ÿåˆ°ç»“å±€çš„è¿›ç¨‹ |

### é˜Ÿåˆ—ç ”ç©¶ç±»å‹

| ç±»å‹ | å®šä¹‰ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|------|
| **å‰ç»æ€§é˜Ÿåˆ—** | ä»ç°åœ¨å¼€å§‹è¿½è¸ªåˆ°æœªæ¥ | æš´éœ²ä¿¡æ¯å‡†ç¡®ï¼Œåå€šå° | è€—æ—¶é•¿ï¼Œè´¹ç”¨é«˜ |
| **å›é¡¾æ€§é˜Ÿåˆ—** | åˆ©ç”¨å†å²èµ„æ–™è¿½è¸ª | çœæ—¶çœåŠ› | ä¿¡æ¯è´¨é‡ä¾èµ–å†å²è®°å½• |
| **åŒå‘æ€§é˜Ÿåˆ—** | ç»“åˆå‰ç»ä¸å›é¡¾ | å¹³è¡¡æ•ˆç‡ä¸è´¨é‡ | è®¾è®¡å¤æ‚ |

### ä¸å…¶ä»–ç ”ç©¶è®¾è®¡çš„å¯¹æ¯”

| ç‰¹å¾ | é˜Ÿåˆ—ç ”ç©¶ | æ¨ªæˆªé¢ç ”ç©¶ | ç—…ä¾‹å¯¹ç…§ç ”ç©¶ | RCT |
|------|---------|-----------|-------------|-----|
| æ—¶é—´æ–¹å‘ | å‰ç»/å›é¡¾ | åŒä¸€æ—¶ç‚¹ | å›é¡¾æ€§ | å‰ç»æ€§ |
| ä¸»è¦æŒ‡æ ‡ | RR/HR/å‘ç—…ç‡ | æ‚£ç—…ç‡/PR | OR | RR |
| å› æœæ¨æ–­ | å¼º | å¼± | ä¸­ç­‰ | æœ€å¼º |
| éšæœºåˆ†é… | å¦ | å¦ | å¦ | æ˜¯ |
| é€‚ç”¨äºç½•è§æš´éœ² | æ˜¯ | å¦ | å¦ | å¯èƒ½ |
| é€‚ç”¨äºç½•è§ç–¾ç—… | å¦ | å¦ | æ˜¯ | å¦ |

---

## æ ¸å¿ƒæ¦‚å¿µä¸æ¨¡å‹å…¥é—¨

### é€šä¿—ç†è§£ï¼šç”¨æ—¥å¸¸ä¾‹å­è§£é‡Šé˜Ÿåˆ—ç ”ç©¶

> ğŸ’¡ **æƒ³è±¡ä½ æ˜¯ä¸€ä½å›­ä¸ï¼Œæƒ³çŸ¥é“"æ–½è‚¥æ˜¯å¦èƒ½è®©æ¤ç‰©é•¿å¾—æ›´é«˜"**
> 
> ä½ æŠŠ100ç›†èŠ±åˆ†æˆä¸¤ç»„ï¼š50ç›†æ–½è‚¥ï¼Œ50ç›†ä¸æ–½è‚¥ã€‚ç„¶å**æ¯å‘¨æµ‹é‡**å®ƒä»¬çš„é«˜åº¦ï¼Œ**æŒç»­è¿½è¸ª3ä¸ªæœˆ**ã€‚æœ€åæ¯”è¾ƒä¸¤ç»„çš„ç”Ÿé•¿æƒ…å†µã€‚
> 
> é˜Ÿåˆ—ç ”ç©¶å°±åƒ**æ‹ä¸€éƒ¨ç”µå½±**è€Œä¸æ˜¯**æ‹ä¸€å¼ ç…§ç‰‡**ï¼š
> - ğŸ¬ **æ—¶é—´è·¨åº¦**ï¼šä»å¼€å§‹è¿½è¸ªåˆ°ç»“å±€å‘ç”Ÿï¼ˆæˆ–ç ”ç©¶ç»“æŸï¼‰
> - â±ï¸ **æ—¶é—´å…ˆå**ï¼šå…ˆæœ‰æš´éœ²ï¼ˆæ–½è‚¥ï¼‰ï¼Œåè§‚å¯Ÿç»“å±€ï¼ˆç”Ÿé•¿ï¼‰
> - ğŸ“Š **æ¯”è¾ƒ**ï¼šæš´éœ²ç»„vséæš´éœ²ç»„çš„ç»“å±€å·®å¼‚
>
> **å›åˆ°æµè¡Œç—…å­¦**ï¼šé˜Ÿåˆ—ç ”ç©¶è¿½è¸ª"å¥åº·äººç¾¤"éšæ—¶é—´å‘å±•ï¼Œè§‚å¯Ÿæš´éœ²å› ç´ æ˜¯å¦å¢åŠ äº†å‘ç—…é£é™©ã€‚å› ä¸ºæš´éœ²åœ¨å‰ã€å‘ç—…åœ¨åï¼Œæ‰€ä»¥èƒ½æ›´å¥½åœ°æ¨æ–­å› æœå…³ç³»ã€‚

### æ ¸å¿ƒæœ¯è¯­

| æ¦‚å¿µ | è‹±æ–‡ | å®šä¹‰ | å…¬å¼ |
|------|------|------|------|
| å‘ç—…ç‡ | Incidence Rate | å•ä½äººæ—¶å†…çš„æ–°å‘ç—…ä¾‹æ•° | $IR = \frac{\text{æ–°å‘ç—…ä¾‹æ•°}}{\text{äººæ—¶}}$ |
| ç´¯ç§¯å‘ç—…ç‡ | Cumulative Incidence | éšè®¿æœŸå†…å‘ç—…çš„æ¦‚ç‡ | $CI = \frac{\text{æ–°å‘ç—…ä¾‹æ•°}}{\text{é£é™©äººç¾¤æ•°}}$ |
| ç›¸å¯¹å±é™©åº¦ | Relative Risk (RR) | æš´éœ²ç»„ä¸éæš´éœ²ç»„å‘ç—…ç‡ä¹‹æ¯” | $RR = \frac{IR_{æš´éœ²}}{IR_{éæš´éœ²}}$ |
| é£é™©æ¯” | Hazard Ratio (HR) | ä»»æ„æ—¶ç‚¹æš´éœ²ç»„ç›¸å¯¹é£é™© | Coxæ¨¡å‹ä¼°è®¡ |
| å½’å› å±é™©åº¦ | Attributable Risk | æš´éœ²å¯¼è‡´çš„è¶…é¢å‘ç—…ç‡ | $AR = IR_{æš´éœ²} - IR_{éæš´éœ²}$ |
| äººæ—¶ | Person-time | æ‰€æœ‰ç ”ç©¶å¯¹è±¡çš„éšè®¿æ—¶é—´ä¹‹å’Œ | $\sum_{i=1}^{n} T_i$ |

### äººæ—¶ï¼ˆPerson-timeï¼‰è®¡ç®—

![äººæ—¶è®¡ç®—ç¤ºæ„å›¾](images/diagrams/stat-cohort-person-time.svg)

äººæ—¶æ˜¯é˜Ÿåˆ—ç ”ç©¶çš„æ ¸å¿ƒè®¡ç®—å•ä½ï¼Œåæ˜ äº†"é£é™©æš´éœ²"çš„æ€»é‡ã€‚

**è®¡ç®—æ–¹æ³•**ï¼š
- æ¯ä¸ªäººçš„éšè®¿æ—¶é—´ = ç»“å±€å‘ç”Ÿæ—¶é—´ï¼ˆæˆ–åˆ å¤±æ—¶é—´ï¼‰ - è¿›å…¥ç ”ç©¶æ—¶é—´
- æ€»äººæ—¶ = æ‰€æœ‰ä¸ªä½“éšè®¿æ—¶é—´ä¹‹å’Œ

**ç¤ºä¾‹**ï¼š
- æ‚£è€…Aï¼šéšè®¿2å¹´åå‘ç—… â†’ è´¡çŒ®2äººå¹´
- æ‚£è€…Bï¼šéšè®¿5å¹´æœªå‘ç—…ï¼Œç ”ç©¶ç»“æŸ â†’ è´¡çŒ®5äººå¹´
- æ‚£è€…Cï¼šéšè®¿3å¹´åå¤±è®¿ â†’ è´¡çŒ®3äººå¹´ï¼ˆåˆ å¤±ï¼‰

---

## æ¨¡å‹å‡è®¾ä¸å‰ææ¡ä»¶

### å‡è®¾1ï¼šæ—¶åºæ˜ç¡®

**å«ä¹‰**: æš´éœ²å‘ç”Ÿåœ¨ç»“å±€ä¹‹å‰ã€‚

**æ£€éªŒæ–¹æ³•**: 
- ä»”ç»†è®¾è®¡åŸºçº¿è°ƒæŸ¥æ—¶ç‚¹
- æ’é™¤åŸºçº¿æ—¶å·²å‘ç—…è€…

**è¿èƒŒåæœ**: æ— æ³•åŒºåˆ†å› æœæ–¹å‘ã€‚

**åº”å¯¹ç­–ç•¥**: ä¸¥æ ¼å®šä¹‰ç ”ç©¶èµ·ç‚¹ï¼Œä½¿ç”¨"æ´—è„±æœŸ"æ’é™¤æ—©æœŸç—…ä¾‹ã€‚

### å‡è®¾2ï¼šåˆ å¤±ç‹¬ç«‹

**å«ä¹‰**: åˆ å¤±ï¼ˆå¤±è®¿ã€é€€å‡ºï¼‰ä¸ç»“å±€å‘ç”Ÿç‹¬ç«‹ã€‚

**æ£€éªŒæ–¹æ³•**: 
- æ¯”è¾ƒå®Œæˆéšè®¿è€…ä¸å¤±è®¿è€…çš„åŸºçº¿ç‰¹å¾
- æ•æ„Ÿæ€§åˆ†æ

**è¿èƒŒåæœ**: å‘ç—…ç‡ä¼°è®¡åå€šã€‚

**åº”å¯¹ç­–ç•¥**: å°½é‡å‡å°‘å¤±è®¿ï¼Œä½¿ç”¨å¤šç§æ–¹æ³•å¤„ç†åˆ å¤±ã€‚

### å‡è®¾3ï¼šæ¯”ä¾‹é£é™©ï¼ˆCoxæ¨¡å‹ï¼‰

**å«ä¹‰**: æš´éœ²ç»„ä¸éæš´éœ²ç»„çš„é£é™©æ¯”éšæ—¶é—´æ’å®šã€‚

**æ£€éªŒæ–¹æ³•**: 
- Schoenfeldæ®‹å·®æ£€éªŒ
- ç»˜åˆ¶log(-log(S(t)))å›¾

**è¿èƒŒåæœ**: HRä¼°è®¡ä¸å‡†ç¡®ã€‚

**åº”å¯¹ç­–ç•¥**: ä½¿ç”¨åˆ†å±‚Coxæ¨¡å‹æˆ–æ—¶å˜åå˜é‡ã€‚

### å‡è®¾4ï¼šæ— æµ‹é‡è¯¯å·®

**å«ä¹‰**: æš´éœ²å’Œç»“å±€æµ‹é‡å‡†ç¡®ã€‚

**æ£€éªŒæ–¹æ³•**: ä½¿ç”¨ç»è¿‡éªŒè¯çš„æµ‹é‡å·¥å…·ã€‚

**è¿èƒŒåæœ**: ä¿¡æ¯åå€šï¼Œå¯èƒ½å¯¼è‡´RRåå‘1ã€‚

**åº”å¯¹ç­–ç•¥**: æ ‡å‡†åŒ–æ•°æ®æ”¶é›†ï¼Œç›²æ³•è¯„ä¼°ç»“å±€ã€‚

---

## æ•°æ®å‡†å¤‡

### å®‰è£…ä¸åŠ è½½RåŒ…

```{r}
# æ ¸å¿ƒåŒ…
library(tidyverse)     # æ•°æ®å¤„ç†
library(survival)      # ç”Ÿå­˜åˆ†æ
library(survminer)     # ç”Ÿå­˜æ›²çº¿å¯è§†åŒ–
library(gtsummary)     # ä¸“ä¸šè¡¨æ ¼
library(ggsurvfit)     # ç°ä»£ç”Ÿå­˜æ›²çº¿

# è¾…åŠ©åŒ…
library(epiR)          # æµè¡Œç—…å­¦åˆ†æ
library(broom)         # æ¨¡å‹æ•´ç†
library(gt)            # è¡¨æ ¼ç¾åŒ–
library(lubridate)     # æ—¥æœŸå¤„ç†
```

### æ¨¡æ‹Ÿé˜Ÿåˆ—ç ”ç©¶æ•°æ®

æˆ‘ä»¬æ¨¡æ‹Ÿä¸€é¡¹èŒä¸šæš´éœ²ä¸å¿ƒè¡€ç®¡ç–¾ç—…çš„å‰ç»æ€§é˜Ÿåˆ—ç ”ç©¶ï¼š

```{r}
# è®¾ç½®éšæœºç§å­
set.seed(2026)
n <- 500

# ç”ŸæˆåŸºçº¿æ•°æ®
cohort_data <- tibble(
  id = 1:n,
  
  # æš´éœ²å˜é‡ï¼šèŒä¸šæš´éœ²
  exposure = factor(sample(c("æš´éœ²ç»„", "éæš´éœ²ç»„"), n, 
                           replace = TRUE, prob = c(0.4, 0.6))),
  
  # åŸºçº¿åå˜é‡
  age_baseline = round(rnorm(n, 45, 10)),
  sex = factor(sample(c("ç”·", "å¥³"), n, replace = TRUE, prob = c(0.55, 0.45))),
  bmi = round(rnorm(n, 25, 4), 1),
  smoking = factor(sample(c("ä»ä¸", "æ›¾ç»", "ç°åœ¨"), n, 
                          replace = TRUE, prob = c(0.45, 0.25, 0.30))),
  hypertension = rbinom(n, 1, prob = 0.30),
  diabetes = rbinom(n, 1, prob = 0.12),
  
  # å…¥é˜Ÿæ—¶é—´ï¼ˆ2015-2018å¹´é—´éšæœºå…¥é˜Ÿï¼‰
  entry_date = as.Date("2015-01-01") + sample(0:1095, n, replace = TRUE),
  
  # ç ”ç©¶ç»“æŸæ—¥æœŸ
  study_end = as.Date("2025-12-31")
)

# ç”Ÿæˆç”Ÿå­˜æ—¶é—´å’Œäº‹ä»¶
cohort_data <- cohort_data |> 
  mutate(
    # åŸºçº¿é£é™©
    log_hr = 0.03 * (age_baseline - 45) +
             0.4 * (sex == "ç”·") +
             0.05 * (bmi - 25) +
             0.5 * (smoking == "ç°åœ¨") +
             0.3 * (smoking == "æ›¾ç»") +
             0.6 * hypertension +
             0.5 * diabetes +
             0.7 * (exposure == "æš´éœ²ç»„"),  # æš´éœ²æ•ˆåº”
    
    # ç”Ÿå­˜æ—¶é—´ï¼ˆWeibullåˆ†å¸ƒï¼Œå•ä½ï¼šå¹´ï¼‰
    true_survival = rweibull(n, shape = 1.5, scale = 15 * exp(-log_hr / 1.5)),
    true_survival = pmax(true_survival, 0.1),  # æœ€å°0.1å¹´
    
    # æœ€å¤§éšè®¿æ—¶é—´
    max_followup = as.numeric(study_end - entry_date) / 365.25,
    
    # åˆ å¤±ï¼šè¡Œæ”¿åˆ å¤± + éšæœºå¤±è®¿
    censor_time = pmin(max_followup, 
                       rexp(n, rate = 0.02)),  # æ¯å¹´2%å¤±è®¿ç‡
    
    # è§‚å¯Ÿæ—¶é—´å’Œäº‹ä»¶çŠ¶æ€
    followup_years = pmin(true_survival, censor_time),
    event = as.integer(true_survival <= censor_time),
    
    # ç»“å±€æ—¥æœŸ
    exit_date = entry_date + days(round(followup_years * 365.25)),
    exit_date = pmin(exit_date, study_end)
  ) |> 
  select(id, exposure, age_baseline, sex, bmi, smoking, hypertension, diabetes,
         entry_date, exit_date, followup_years, event)

# æŸ¥çœ‹æ•°æ®
glimpse(cohort_data)

# åŸºæœ¬ç»Ÿè®¡
cat("æ ·æœ¬é‡:", nrow(cohort_data), "\n")
cat("äº‹ä»¶æ•°:", sum(cohort_data$event), "\n")
cat("äº‹ä»¶ç‡:", round(mean(cohort_data$event) * 100, 1), "%\n")
cat("æ€»éšè®¿äººå¹´:", round(sum(cohort_data$followup_years), 1), "\n")
```

### æ•°æ®è´¨é‡æ£€æŸ¥

```{r}
# åŸºçº¿ç‰¹å¾è¡¨ï¼ˆæŒ‰æš´éœ²åˆ†ç»„ï¼‰
cohort_data |> 
  tbl_summary(
    by = exposure,
    include = c(age_baseline, sex, bmi, smoking, hypertension, diabetes,
                followup_years, event),
    label = list(
      age_baseline ~ "åŸºçº¿å¹´é¾„",
      sex ~ "æ€§åˆ«",
      bmi ~ "BMI",
      smoking ~ "å¸çƒŸçŠ¶æ€",
      hypertension ~ "é«˜è¡€å‹",
      diabetes ~ "ç³–å°¿ç—…",
      followup_years ~ "éšè®¿æ—¶é—´(å¹´)",
      event ~ "å‘ç”Ÿäº‹ä»¶"
    ),
    statistic = list(
      all_continuous() ~ "{mean} Â± {sd}",
      all_categorical() ~ "{n} ({p}%)"
    )
  ) |> 
  add_p() |> 
  add_overall() |> 
  modify_header(label = "**å˜é‡**") |> 
  modify_spanning_header(c("stat_1", "stat_2") ~ "**æš´éœ²çŠ¶æ€**") |> 
  bold_labels()
```

---

## å®Œæ•´åˆ†ææµç¨‹

### æ­¥éª¤1ï¼šäººæ—¶è®¡ç®—

```{r}
# æŒ‰æš´éœ²ç»„è®¡ç®—äººæ—¶
person_time <- cohort_data |> 
  group_by(exposure) |> 
  summarise(
    n = n(),
    events = sum(event),
    person_years = sum(followup_years),
    incidence_rate = events / person_years * 1000,  # æ¯åƒäººå¹´
    median_followup = median(followup_years),
    .groups = "drop"
  )

person_time |> 
  gt() |> 
  tab_header(
    title = "é˜Ÿåˆ—éšè®¿æ‘˜è¦",
    subtitle = "æŒ‰æš´éœ²çŠ¶æ€åˆ†å±‚"
  ) |> 
  cols_label(
    exposure = "æš´éœ²çŠ¶æ€",
    n = "äººæ•°",
    events = "äº‹ä»¶æ•°",
    person_years = "äººå¹´",
    incidence_rate = "å‘ç—…ç‡(/åƒäººå¹´)",
    median_followup = "ä¸­ä½éšè®¿(å¹´)"
  ) |> 
  fmt_number(columns = c(person_years, median_followup), decimals = 1) |> 
  fmt_number(columns = incidence_rate, decimals = 2)
```

### æ­¥éª¤2ï¼šå‘ç—…ç‡ä¸ç›¸å¯¹å±é™©åº¦

```{r}
# åˆ›å»º2x2è¡¨è®¡ç®—RR
# éœ€è¦ç´¯ç§¯å‘ç—…ç‡ï¼ˆä¸è€ƒè™‘æ—¶é—´ï¼‰
tab_cohort <- cohort_data |> 
  group_by(exposure) |> 
  summarise(
    n = n(),
    events = sum(event),
    .groups = "drop"
  ) |> 
  arrange(desc(exposure))  # æš´éœ²ç»„åœ¨å‰

# ä½¿ç”¨epiRè®¡ç®—RR
rr_data <- matrix(
  c(tab_cohort$events[1], tab_cohort$n[1] - tab_cohort$events[1],
    tab_cohort$events[2], tab_cohort$n[2] - tab_cohort$events[2]),
  nrow = 2, byrow = TRUE
)
rownames(rr_data) <- c("æš´éœ²ç»„", "éæš´éœ²ç»„")
colnames(rr_data) <- c("å‘ç—…", "æœªå‘ç—…")

rr_result <- epi.2by2(rr_data, method = "cohort.count", 
                       conf.level = 0.95, outcome = "as.columns")
print(rr_result)
```

### æ­¥éª¤3ï¼šå‘ç—…ç‡æ¯”ï¼ˆåŸºäºäººæ—¶ï¼‰

```{r}
# ä½¿ç”¨Poissonå›å½’è®¡ç®—å‘ç—…ç‡æ¯”ï¼ˆIRRï¼‰
# éœ€è¦å…ˆè®¡ç®—æ¯ä¸ªäººçš„äººæ—¶
irr_model <- glm(event ~ exposure + offset(log(followup_years)),
                  data = cohort_data, family = poisson)

# æå–IRR
irr_result <- tidy(irr_model, exponentiate = TRUE, conf.int = TRUE) |> 
  filter(term != "(Intercept)")

irr_result |> 
  gt() |> 
  tab_header(title = "å‘ç—…ç‡æ¯” (IRR)") |> 
  cols_label(
    term = "å˜é‡",
    estimate = "IRR",
    conf.low = "95%CIä¸‹é™",
    conf.high = "95%CIä¸Šé™",
    p.value = "På€¼"
  ) |> 
  fmt_number(columns = c(estimate, conf.low, conf.high), decimals = 2) |> 
  fmt_number(columns = p.value, decimals = 4)
```

### æ­¥éª¤4ï¼šKaplan-Meierç”Ÿå­˜æ›²çº¿

```{r}
#| fig-height: 7
# åˆ›å»ºç”Ÿå­˜å¯¹è±¡
surv_obj <- Surv(time = cohort_data$followup_years, 
                  event = cohort_data$event)

# Kaplan-Meieræ‹Ÿåˆ
km_fit <- survfit(surv_obj ~ exposure, data = cohort_data)

# ä½¿ç”¨survminerç»‘åˆ¶
ggsurvplot(
  km_fit,
  data = cohort_data,
  pval = TRUE,
  pval.method = TRUE,
  conf.int = TRUE,
  risk.table = TRUE,
  risk.table.col = "strata",
  surv.median.line = "hv",
  palette = c("#ef4444", "#2563eb"),
  legend.labs = c("æš´éœ²ç»„", "éæš´éœ²ç»„"),
  legend.title = "æš´éœ²çŠ¶æ€",
  xlab = "éšè®¿æ—¶é—´ (å¹´)",
  ylab = "æ— äº‹ä»¶ç”Ÿå­˜æ¦‚ç‡",
  title = "èŒä¸šæš´éœ²ä¸å¿ƒè¡€ç®¡äº‹ä»¶çš„Kaplan-Meieræ›²çº¿"
)
```

```{r}
# ç°ä»£é£æ ¼ç”Ÿå­˜æ›²çº¿
survfit2(Surv(followup_years, event) ~ exposure, data = cohort_data) |> 
  ggsurvfit() +
  add_confidence_interval() +
  add_risktable() +
  add_quantile(y_value = 0.5, color = "gray50", linetype = "dashed") +
  scale_color_manual(values = c("#ef4444", "#2563eb")) +
  scale_fill_manual(values = c("#ef4444", "#2563eb")) +
  labs(
    title = "ç´¯ç§¯å‘ç—…æ›²çº¿",
    subtitle = "1 - Kaplan-Meierç”Ÿå­˜æ›²çº¿",
    x = "éšè®¿æ—¶é—´ (å¹´)",
    y = "ç´¯ç§¯å‘ç—…æ¦‚ç‡"
  ) +
  theme_minimal(base_size = 12)
```

### æ­¥éª¤5ï¼šLog-rankæ£€éªŒ

```{r}
# Log-rankæ£€éªŒ
logrank_test <- survdiff(Surv(followup_years, event) ~ exposure, 
                          data = cohort_data)
print(logrank_test)

# æå–på€¼
logrank_p <- 1 - pchisq(logrank_test$chisq, df = 1)
cat("Log-rankæ£€éªŒ på€¼:", format.pval(logrank_p, digits = 3), "\n")
```

### æ­¥éª¤6ï¼šCoxæ¯”ä¾‹é£é™©å›å½’

#### 6.1 å•å› ç´ Coxå›å½’

```{r}
# å•å› ç´ åˆ†æ
cox_univar <- coxph(Surv(followup_years, event) ~ exposure, data = cohort_data)
summary(cox_univar)
```

#### 6.2 å¤šå› ç´ Coxå›å½’

```{r}
# å¤šå› ç´ Coxå›å½’
cox_multi <- coxph(
  Surv(followup_years, event) ~ exposure + age_baseline + sex + bmi + 
    smoking + hypertension + diabetes,
  data = cohort_data
)

# ä½¿ç”¨gtsummaryè¾“å‡º
tbl_regression(cox_multi, exponentiate = TRUE) |> 
  add_global_p() |> 
  modify_header(label = "**å˜é‡**") |> 
  bold_p(t = 0.05) |> 
  bold_labels()
```

### æ­¥éª¤7ï¼šæ¯”ä¾‹é£é™©å‡è®¾æ£€éªŒ

```{r}
# Schoenfeldæ®‹å·®æ£€éªŒ
ph_test <- cox.zph(cox_multi)
print(ph_test)

# å¯è§†åŒ–æ®‹å·®
par(mfrow = c(2, 2))
plot(ph_test[1])  # exposure
plot(ph_test[2])  # age
plot(ph_test[3])  # sex
plot(ph_test[4])  # bmi
par(mfrow = c(1, 1))
```

```{r}
# æ›´å¥½çš„å¯è§†åŒ–
ggcoxzph(ph_test, var = "exposure", font.main = 12)
```

### æ­¥éª¤8ï¼šæ£®æ—å›¾å¯è§†åŒ–

```{r}
#| fig-height: 7
# æå–HRåŠ95%CI
hr_data <- tidy(cox_multi, exponentiate = TRUE, conf.int = TRUE) |> 
  mutate(
    term = case_when(
      term == "exposureéæš´éœ²ç»„" ~ "éæš´éœ²ç»„ vs æš´éœ²ç»„",
      term == "age_baseline" ~ "å¹´é¾„(æ¯å¢åŠ 1å²)",
      term == "sexå¥³" ~ "å¥³æ€§ vs ç”·æ€§",
      term == "bmi" ~ "BMI(æ¯å¢åŠ 1)",
      term == "smokingæ›¾ç»" ~ "æ›¾ç»å¸çƒŸ vs ä»ä¸",
      term == "smokingç°åœ¨" ~ "ç°åœ¨å¸çƒŸ vs ä»ä¸",
      term == "hypertension" ~ "é«˜è¡€å‹",
      term == "diabetes" ~ "ç³–å°¿ç—…",
      TRUE ~ term
    ),
    significant = ifelse(p.value < 0.05, "æ˜¾è‘—", "ä¸æ˜¾è‘—")
  )

ggplot(hr_data, aes(x = estimate, y = reorder(term, estimate))) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "gray50") +
  geom_point(aes(color = significant), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high, color = significant),
                 height = 0.2) +
  scale_color_manual(values = c("æ˜¾è‘—" = "#ef4444", "ä¸æ˜¾è‘—" = "#94a3b8")) +
  scale_x_log10() +
  labs(
    title = "å¿ƒè¡€ç®¡äº‹ä»¶å±é™©å› ç´ æ£®æ—å›¾",
    subtitle = "å¤šå› ç´ Coxå›å½’ç»“æœ",
    x = "é£é™©æ¯” HR (95% CI)",
    y = "",
    color = "ç»Ÿè®¡æ˜¾è‘—æ€§"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold")
  )
```

### æ­¥éª¤9ï¼šå½’å› å±é™©åº¦è®¡ç®—

```{r}
# è®¡ç®—å½’å› åˆ†æ•°
# AR = (RR - 1) / RR (æš´éœ²ç»„)
# PAR = p(RR - 1) / [p(RR - 1) + 1] (äººç¾¤)

# è·å–æš´éœ²çš„HR
hr_exposure <- exp(coef(cox_multi)["exposureéæš´éœ²ç»„"])
# æ³¨æ„ï¼šè¿™é‡Œæ˜¯éæš´éœ²ç»„vsæš´éœ²ç»„ï¼Œæ‰€ä»¥éœ€è¦å–å€’æ•°
hr_exposed <- 1 / hr_exposure

# æš´éœ²æ¯”ä¾‹
p_exposed <- mean(cohort_data$exposure == "æš´éœ²ç»„")

# è®¡ç®—å½’å› åˆ†æ•°
af_exposed <- (hr_exposed - 1) / hr_exposed  # æš´éœ²è€…ä¸­å½’å› äºæš´éœ²çš„æ¯”ä¾‹
paf <- p_exposed * (hr_exposed - 1) / (p_exposed * (hr_exposed - 1) + 1)  # äººç¾¤å½’å› åˆ†æ•°

cat("æš´éœ²ç»„å½’å› åˆ†æ•° (AF%):", round(af_exposed * 100, 1), "%\n")
cat("äººç¾¤å½’å› åˆ†æ•° (PAF%):", round(paf * 100, 1), "%\n")
```

### æ­¥éª¤10ï¼šæ¨¡å‹é¢„æµ‹ä¸éªŒè¯

```{r}
# é¢„æµ‹ç”Ÿå­˜æ¦‚ç‡
# åˆ›å»ºæ–°æ•°æ®è¿›è¡Œé¢„æµ‹
new_data <- tibble(
  exposure = factor(c("æš´éœ²ç»„", "éæš´éœ²ç»„"), levels = c("æš´éœ²ç»„", "éæš´éœ²ç»„")),
  age_baseline = c(50, 50),
  sex = factor(c("ç”·", "ç”·"), levels = c("ç”·", "å¥³")),
  bmi = c(25, 25),
  smoking = factor(c("ä»ä¸", "ä»ä¸"), levels = c("ä»ä¸", "æ›¾ç»", "ç°åœ¨")),
  hypertension = c(0, 0),
  diabetes = c(0, 0)
)

# é¢„æµ‹5å¹´å’Œ10å¹´ç”Ÿå­˜æ¦‚ç‡
surv_pred <- survfit(cox_multi, newdata = new_data)

# æå–ç‰¹å®šæ—¶é—´ç‚¹çš„ç”Ÿå­˜æ¦‚ç‡
summary(surv_pred, times = c(5, 10))
```

```{r}
# C-indexè¯„ä¼°æ¨¡å‹åŒºåˆ†åº¦
c_index <- concordance(cox_multi)
cat("C-index:", round(c_index$concordance, 3), "\n")
cat("95% CI:", round(c_index$concordance - 1.96 * sqrt(c_index$var), 3), "-",
    round(c_index$concordance + 1.96 * sqrt(c_index$var), 3), "\n")
```

---

## ç»“æœè§£è¯»ä¸æŠ¥å‘Š

### STROBEæŠ¥å‘Šè§„èŒƒè¦ç‚¹

| æ¡ç›® | é˜Ÿåˆ—ç ”ç©¶ç‰¹æ®Šè¦æ±‚ |
|------|----------------|
| ç ”ç©¶è®¾è®¡ | æ˜ç¡®è¯´æ˜å‰ç»æ€§/å›é¡¾æ€§ï¼Œæè¿°é˜Ÿåˆ—å…¥é€‰æ ‡å‡† |
| éšè®¿ | æŠ¥å‘Šéšè®¿æ—¶é—´ï¼ˆä¸­ä½æ•°ã€å››åˆ†ä½è·ï¼‰ï¼Œæè¿°éšè®¿æ–¹æ³• |
| å¤±è®¿ | æŠ¥å‘Šå¤±è®¿ç‡ï¼Œæ¯”è¾ƒå¤±è®¿è€…ä¸å®Œæˆè€…ç‰¹å¾ |
| äººæ—¶ | æŠ¥å‘Šæ€»äººæ—¶ï¼Œè¯´æ˜äººæ—¶è®¡ç®—æ–¹æ³• |
| å‘ç—…ç‡ | æŠ¥å‘Šå‘ç—…ç‡åŠ95%CIï¼ˆæ¯åƒäººå¹´ï¼‰ |
| ç›¸å¯¹å±é™©åº¦ | æŠ¥å‘Šç²—RRå’Œè°ƒæ•´åRR/HR |

### ç»“æœæŠ¥å‘Šæ¨¡æ¿

> æœ¬ç ”ç©¶çº³å…¥ `r nrow(cohort_data)` åç ”ç©¶å¯¹è±¡ï¼Œä¸­ä½éšè®¿æ—¶é—´ä¸º `r round(median(cohort_data$followup_years), 1)` å¹´ï¼ˆIQR: `r round(quantile(cohort_data$followup_years, 0.25), 1)` - `r round(quantile(cohort_data$followup_years, 0.75), 1)` å¹´ï¼‰ï¼Œç´¯ç§¯ `r round(sum(cohort_data$followup_years), 0)` äººå¹´ã€‚éšè®¿æœŸé—´å…±å‘ç”Ÿ `r sum(cohort_data$event)` ä¾‹å¿ƒè¡€ç®¡äº‹ä»¶ã€‚
>
> æš´éœ²ç»„å‘ç—…ç‡ä¸º `r round(person_time$incidence_rate[person_time$exposure == "æš´éœ²ç»„"], 2)` /åƒäººå¹´ï¼Œéæš´éœ²ç»„ä¸º `r round(person_time$incidence_rate[person_time$exposure == "éæš´éœ²ç»„"], 2)` /åƒäººå¹´ã€‚
>
> å¤šå› ç´ Coxå›å½’åˆ†ææ˜¾ç¤ºï¼Œåœ¨æ§åˆ¶å¹´é¾„ã€æ€§åˆ«ã€BMIã€å¸çƒŸçŠ¶æ€ã€é«˜è¡€å‹å’Œç³–å°¿ç—…åï¼ŒèŒä¸šæš´éœ²æ˜¾è‘—å¢åŠ å¿ƒè¡€ç®¡äº‹ä»¶é£é™©ï¼ˆHR = X.XX, 95% CI: X.XX-X.XX, P = X.XXXï¼‰ã€‚

---

## å¸¸è§é”™è¯¯ä¸çº å

### é”™è¯¯1ï¼šå¿½è§†å¤±è®¿åå€š

**é”™è¯¯è¡¨ç°**: ä¸æŠ¥å‘Šå¤±è®¿ç‡ï¼Œä¸åˆ†æå¤±è®¿è€…ç‰¹å¾

**æ­£ç¡®åšæ³•**: 
- æŠ¥å‘Šå¤±è®¿ç‡ï¼ˆå»ºè®® < 20%ï¼‰
- æ¯”è¾ƒå¤±è®¿è€…ä¸å®Œæˆè€…çš„åŸºçº¿ç‰¹å¾
- è¿›è¡Œæ•æ„Ÿæ€§åˆ†æï¼ˆå¦‚å°†å¤±è®¿è€…è§†ä¸ºå‘ç—…/æœªå‘ç—…ï¼‰

### é”™è¯¯2ï¼šä¸æ£€éªŒæ¯”ä¾‹é£é™©å‡è®¾

**é”™è¯¯è¡¨ç°**: ç›´æ¥ä½¿ç”¨Coxå›å½’è€Œä¸éªŒè¯PHå‡è®¾

**æ­£ç¡®åšæ³•**: 
- ä½¿ç”¨Schoenfeldæ®‹å·®æ£€éªŒ
- è‹¥è¿åï¼Œä½¿ç”¨åˆ†å±‚Coxæˆ–æ—¶å˜åå˜é‡

```{r eval=FALSE}
# è‹¥PHå‡è®¾è¿åï¼Œå¯ä»¥ä½¿ç”¨åˆ†å±‚Cox
cox_strat <- coxph(
  Surv(followup_years, event) ~ exposure + strata(age_group),
  data = cohort_data
)
```

### é”™è¯¯3ï¼šæ··æ·†ç´¯ç§¯å‘ç—…ç‡ä¸å‘ç—…ç‡

**é”™è¯¯è¡¨ç°**: å°†ç´¯ç§¯å‘ç—…ç‡ç§°ä¸º"å‘ç—…ç‡"

**æ­£ç¡®åšæ³•**: 
- ç´¯ç§¯å‘ç—…ç‡ï¼ˆCumulative Incidenceï¼‰= äº‹ä»¶æ•° / åˆå§‹äººæ•°
- å‘ç—…ç‡ï¼ˆIncidence Rateï¼‰= äº‹ä»¶æ•° / äººæ—¶
- å½“éšè®¿æ—¶é—´ä¸åŒæ—¶ï¼Œä½¿ç”¨å‘ç—…ç‡æ›´å‡†ç¡®

### é”™è¯¯4ï¼šå¿½è§†ç«äº‰é£é™©

**é”™è¯¯è¡¨ç°**: å­˜åœ¨ç«äº‰äº‹ä»¶æ—¶ä»ä½¿ç”¨æ ‡å‡†ç”Ÿå­˜åˆ†æ

**æ­£ç¡®åšæ³•**: ä½¿ç”¨ç«äº‰é£é™©åˆ†æï¼ˆFine-Grayæ¨¡å‹ï¼‰

```{r eval=FALSE}
# ç«äº‰é£é™©åˆ†æ
library(cmprsk)
# å‡è®¾event = 1æ˜¯ç›®æ ‡äº‹ä»¶ï¼Œevent = 2æ˜¯ç«äº‰äº‹ä»¶
fg_model <- crr(cohort_data$followup_years, 
                cohort_data$event,
                cohort_data$exposure)
```

### é”™è¯¯5ï¼šæ—¶é—´åŸç‚¹ä¸ä¸€è‡´

**é”™è¯¯è¡¨ç°**: ä¸åŒä¸ªä½“çš„"æ—¶é—´é›¶ç‚¹"ä¸ä¸€è‡´

**æ­£ç¡®åšæ³•**: 
- æ˜ç¡®å®šä¹‰ç ”ç©¶èµ·ç‚¹ï¼ˆå¦‚è¯Šæ–­æ—¥æœŸã€æš´éœ²å¼€å§‹æ—¥æœŸï¼‰
- å·¦æˆªæ–­å¤„ç†å»¶è¿Ÿå…¥é˜Ÿ

---

## è¿›é˜¶æ‰©å±•

### æ—¶å˜æš´éœ²åˆ†æ

å½“æš´éœ²çŠ¶æ€éšæ—¶é—´å˜åŒ–æ—¶ï¼š

```{r eval=FALSE}
# è½¬æ¢ä¸ºè®¡æ•°è¿‡ç¨‹æ ¼å¼
library(survSplit)

# å‡è®¾æš´éœ²åœ¨ç¬¬3å¹´å‘ç”Ÿå˜åŒ–
cohort_tv <- survSplit(
  Surv(followup_years, event) ~ .,
  data = cohort_data,
  cut = c(3),
  episode = "interval"
)

# æ—¶å˜Coxæ¨¡å‹
cox_tv <- coxph(
  Surv(tstart, followup_years, event) ~ exposure + age_baseline + sex,
  data = cohort_tv
)
```

### åŠ é€Ÿå¤±æ•ˆæ—¶é—´æ¨¡å‹

ä½œä¸ºCoxæ¨¡å‹çš„æ›¿ä»£ï¼š

```{r}
# Weibull AFTæ¨¡å‹
aft_weibull <- survreg(
  Surv(followup_years, event) ~ exposure + age_baseline + sex,
  data = cohort_data,
  dist = "weibull"
)

# æå–ç»“æœ
tidy(aft_weibull, conf.int = TRUE) |> 
  filter(term != "(Intercept)" & term != "Log(scale)")
```

### åŠ¨æ€é¢„æµ‹

```{r}
# ä½¿ç”¨ggsurvfitè¿›è¡Œåˆ†ç»„é¢„æµ‹
survfit2(Surv(followup_years, event) ~ exposure, data = cohort_data) |> 
  tidy_survfit() |> 
  ggplot(aes(x = time, y = estimate, color = strata)) +
  geom_step(size = 1) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = strata), 
              alpha = 0.2, color = NA) +
  scale_color_manual(values = c("#ef4444", "#2563eb"),
                     labels = c("æš´éœ²ç»„", "éæš´éœ²ç»„")) +
  scale_fill_manual(values = c("#ef4444", "#2563eb"),
                    labels = c("æš´éœ²ç»„", "éæš´éœ²ç»„")) +
  labs(
    title = "ç”Ÿå­˜æ¦‚ç‡åŠ¨æ€å˜åŒ–",
    x = "éšè®¿æ—¶é—´ (å¹´)",
    y = "ç”Ÿå­˜æ¦‚ç‡",
    color = "æš´éœ²çŠ¶æ€",
    fill = "æš´éœ²çŠ¶æ€"
  ) +
  theme_minimal(base_size = 12)
```

---

## æ€»ç»“

### é˜Ÿåˆ—ç ”ç©¶è¦ç‚¹å›é¡¾

1. **è®¾è®¡ç‰¹ç‚¹**ï¼šæŒ‰æš´éœ²çŠ¶æ€åˆ†ç»„ï¼Œå‰ç»æ€§è¿½è¸ªè§‚å¯Ÿç»“å±€
2. **æ ¸å¿ƒä¼˜åŠ¿**ï¼šæ—¶åºæ˜ç¡®ï¼Œå¯ç›´æ¥è®¡ç®—å‘ç—…ç‡å’ŒRR
3. **ä¸»è¦æŒ‡æ ‡**ï¼šå‘ç—…ç‡ã€RRã€HRã€å½’å› å±é™©åº¦
4. **åˆ†ææ–¹æ³•**ï¼šKaplan-Meierã€Log-rankæ£€éªŒã€Coxå›å½’
5. **å…³é”®å‡è®¾**ï¼šæ¯”ä¾‹é£é™©å‡è®¾ã€åˆ å¤±ç‹¬ç«‹
6. **æŠ¥å‘Šè§„èŒƒ**ï¼šéµå¾ªSTROBEå£°æ˜ï¼ŒæŠ¥å‘Šäººæ—¶å’Œå¤±è®¿ç‡

### ç ”ç©¶è®¾è®¡æ£€æŸ¥æ¸…å•

- [ ] æ˜ç¡®å®šä¹‰æš´éœ²å’Œç»“å±€
- [ ] ç¡®ä¿æ—¶é—´é¡ºåºï¼ˆæš´éœ²â†’ç»“å±€ï¼‰
- [ ] æ’é™¤åŸºçº¿æ—¶å·²å‘ç—…è€…
- [ ] åˆ¶å®šéšè®¿è®¡åˆ’å’Œå¤±è®¿æ§åˆ¶ç­–ç•¥
- [ ] é¢„ä¼°æ ·æœ¬é‡å’Œç»Ÿè®¡æ•ˆèƒ½
- [ ] è®¡åˆ’ç«äº‰é£é™©çš„å¤„ç†
- [ ] éªŒè¯æ¯”ä¾‹é£é™©å‡è®¾

---

## å‚è€ƒæ–‡çŒ®

1. Rothman KJ, Greenland S, Lash TL. Modern Epidemiology. 3rd ed. Lippincott Williams & Wilkins; 2008.

2. Therneau TM, Grambsch PM. Modeling Survival Data: Extending the Cox Model. Springer; 2000.

3. Vandenbroucke JP, et al. Strengthening the Reporting of Observational Studies in Epidemiology (STROBE): Explanation and Elaboration. PLoS Med. 2007;4(10):e297.

4. HernÃ¡n MA, Robins JM. Causal Inference: What If. Chapman & Hall/CRC; 2020.

5. è©¹æ€å»¶. æµè¡Œç—…å­¦ï¼ˆç¬¬8ç‰ˆï¼‰. äººæ°‘å«ç”Ÿå‡ºç‰ˆç¤¾; 2017.

6. Kleinbaum DG, Klein M. Survival Analysis: A Self-Learning Text. 3rd ed. Springer; 2012.
