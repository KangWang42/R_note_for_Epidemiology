<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2026-01-14">
<meta name="description" content="使用观察性数据模拟随机对照试验，遵循TARGET报告指南进行严谨的因果推断。">

<title>目标试验模拟 (Target Trial Emulation) – R 语言学习笔记</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-234273d1456647dabc34a594ac50e507.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-374967827064a263f620006ef06629b3.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">R 语言学习笔记</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">主页</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-r-包" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">实用 R 包</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-r-包">    
        <li>
    <a class="dropdown-item" href="./sections/packages.html#表格制作">
 <span class="dropdown-text">📊 表格制作</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./sections/packages.html#数据处理">
 <span class="dropdown-text">🔄 数据处理</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./sections/packages.html#模型整理">
 <span class="dropdown-text">📈 模型整理</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">可视化教程</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-">    
        <li>
    <a class="dropdown-item" href="./sections/visualization.html#图形基础">
 <span class="dropdown-text">🏗️ 图形基础</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./sections/visualization.html#图形组合">
 <span class="dropdown-text">🔀 图形组合</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./sections/visualization.html#统计图表">
 <span class="dropdown-text">📊 统计图表</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./sections/visualization.html#专题图类">
 <span class="dropdown-text">🗺️ 专题图类</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./sections/visualization.html#进阶美化">
 <span class="dropdown-text">✨ 进阶美化</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-r-语言方法" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">R 语言方法</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-r-语言方法">    
        <li>
    <a class="dropdown-item" href="./sections/methods.html#回归分析">
 <span class="dropdown-text">🔢 回归分析</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./sections/methods.html#生存分析">
 <span class="dropdown-text">⏱️ 生存分析</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./sections/methods.html#因果推断">
 <span class="dropdown-text">🎯 因果推断</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./sections/methods.html#高级建模">
 <span class="dropdown-text">📐 高级建模</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./sections/methods.html#机器学习">
 <span class="dropdown-text">🤖 机器学习</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./sections/methods.html#数据预处理">
 <span class="dropdown-text">📋 数据预处理</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./sections/methods.html#综述方法">
 <span class="dropdown-text">📚 综述方法</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./sections/methods.html#特殊方法">
 <span class="dropdown-text">🔬 特殊方法</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu--1" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">实用操作</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu--1">    
        <li>
    <a class="dropdown-item" href="./sections/operation.html#数据输入输出">
 <span class="dropdown-text">📥 数据输入输出</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./sections/operation.html#文档写作">
 <span class="dropdown-text">📝 文档写作</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./sections/operation.html#开发环境">
 <span class="dropdown-text">💻 开发环境</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/KangWang42/R_note_for_Epidemiology"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">R 语言方法</li><li class="breadcrumb-item"><a href="./1018-psm.html">🎯 因果推断</a></li><li class="breadcrumb-item"><a href="./1057-target-trial.html">目标试验模拟</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">实用 R 包</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">📊 表格制作</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1011-rpac_brucer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">bruceR - 统计分析工具</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1012-comparegroups.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">compareGroups - 描述性表</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1013-scitb.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">scitb - 快速基线表</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1053-gtsummary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">gtsummary - 发表级表格</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">🔄 数据处理</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1014-purrr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">purrr - 函数式编程</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1014-future.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">future - 并行计算</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1045-rstatix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">rstatix - 管道式统计</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false">
 <span class="menu-text">📈 模型整理</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1043-broom.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">broom - 模型整理</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">可视化教程</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false">
 <span class="menu-text">🏗️ 图形基础</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2032-ggplot2-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ggplot2 可视化入门</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2033-ggplot2-styling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ggplot2 样式设置详解</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2011-viscolor.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">配色方案</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2013-legend.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">图例自定义</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="false">
 <span class="menu-text">🔀 图形组合</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2012-patchwork.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">patchwork - 图片拼接</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2021-cowplot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">cowplot - 图形组合</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2031-bindcomplex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">复杂组合图</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="false">
 <span class="menu-text">📊 统计图表</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2025-bindboxplot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">箱线图与小提琴图</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2026-bindscatterplot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">散点图与趋势线</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2027-bindhistogram.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">直方图与密度图</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2028-bindbarchart.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">柱状图与饼图</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2029-bindlineplot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">折线图与时间序列</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2030-bindareaplot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">面积图与堆叠图</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="false">
 <span class="menu-text">🗺️ 专题图类</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2015-map.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">地图绑制</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2014-sankey.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">桑基图</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2016-forestplot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">森林图</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2020-heatmap.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">热图绑制完全指南</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2024-venn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">韦恩图</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2023-radar.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">雷达图</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" role="navigation" aria-expanded="false">
 <span class="menu-text">✨ 进阶美化</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-10" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2017-ggtext.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ggtext - 中英文字体混合</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2018-tidyplots.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">tidyplots - 极简可视化</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2022-ggally.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">GGally - 可视化扩展</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2019-dualaxis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">双坐标轴</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2034-ggguides.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ggguides - 图例简化</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" role="navigation" aria-expanded="true">
 <span class="menu-text">R 语言方法</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-11" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-12" role="navigation" aria-expanded="false">
 <span class="menu-text">🔢 回归分析</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-12" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-12" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1019-logistic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Logistic 回归</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1021-linear-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">多元线性回归</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1026-poisson.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Poisson/负二项回归</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1036-anova.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">方差分析 (ANOVA)</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-13" role="navigation" aria-expanded="false">
 <span class="menu-text">⏱️ 生存分析</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-13" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-13" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1020-survival.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">生存分析</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1050-competing-risks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">竞争风险分析</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1027-rcs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">限制性立方样条 (RCS)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1017-timeseries.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">时间序列分析</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1055-tx-effects-survival.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">治疗效果分析 (TxEffects)</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-14" role="navigation" aria-expanded="true">
 <span class="menu-text">🎯 因果推断</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-14" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-14" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1018-psm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">倾向性得分匹配</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1028-did.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">双重差分法 (DiD)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1023-mediation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">中介效应分析</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1054-subgroup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">亚组分析与交互作用</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1056-dag.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DAG 因果图</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1057-target-trial.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">目标试验模拟</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1058-mendelian-randomization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">孟德尔随机化</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1059-evalue.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">E值敏感性分析</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-15" role="navigation" aria-expanded="false">
 <span class="menu-text">📐 高级建模</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-15" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-15" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1024-multilevel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">多水平模型</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1025-gam.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">广义加性模型 (GAM)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1032-sem.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">结构方程模型 (SEM)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1031-lca.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">潜类别分析 (LCA)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1039-pca.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">主成分分析 (PCA)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1038-efa-cfa.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">因子分析 (EFA/CFA)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1037-plspm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">PLS-PM 路径模型</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-16" role="navigation" aria-expanded="false">
 <span class="menu-text">🤖 机器学习</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-16" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-16" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1016-mlr3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">mlr3 机器学习</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1042-tidymodels.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">tidymodels 机器学习</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1044-lstm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">LSTM 深度学习</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1052-bootstrap.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bootstrap与置换检验</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1051-bayesian.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">贝叶斯统计入门</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-17" role="navigation" aria-expanded="false">
 <span class="menu-text">📋 数据预处理</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-17" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-17" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1046-missing-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">缺失值处理</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1047-roc-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ROC 分析</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1048-power-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">样本量计算</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1049-eda.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">探索性数据分析</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-18" role="navigation" aria-expanded="false">
 <span class="menu-text">📚 综述方法</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-18" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-18" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1022-meta-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Meta 分析</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1041-network-meta.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">网状 Meta 分析</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1029-umbrella-review.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">伞状综述</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1040-scoping-review.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">范围综述</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-19" role="navigation" aria-expanded="false">
 <span class="menu-text">🔬 特殊方法</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-19" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-19" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1015-health-economics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">卫生经济学分析</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1030-qualitative-research.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">质性研究与文本挖掘</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1033-dlnm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">分布滞后非线性模型 (DLNM)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1034-nvmd.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">变分模态分解 (VMD)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1035-fft-nvmd-gmm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">FFT + VMD + GMM</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-20" role="navigation" aria-expanded="true">
 <span class="menu-text">实用操作</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-20" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-20" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-21" role="navigation" aria-expanded="false">
 <span class="menu-text">📥 数据输入输出</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-21" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-21" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./3001-imports.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">数据导入导出</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./3002-datatable.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">data.table 完全指南</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./3003-dplyr-tidyr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">dplyr/tidyr 数据处理</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./3004-web-scraping.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">网络爬虫入门</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./3005-pdf-reading.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">PDF文件读取</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-22" role="navigation" aria-expanded="false">
 <span class="menu-text">📝 文档写作</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-22" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-22" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./0011-rmarkdown.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">RMarkdown 入门</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./0012-quarto-vs-rmd.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Quarto vs RMarkdown</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-23" role="navigation" aria-expanded="false">
 <span class="menu-text">💻 开发环境</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-23" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-23" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./0013-positron.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Positron IDE 教程</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./4001-shiny.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Shiny Web 应用</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./3006-reproducible-research.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">可重复研究工作流</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">目录</h2>
   
  <ul>
  <li><a href="#什么是目标试验模拟" id="toc-什么是目标试验模拟" class="nav-link active" data-scroll-target="#什么是目标试验模拟">什么是目标试验模拟</a>
  <ul class="collapse">
  <li><a href="#为什么需要目标试验模拟" id="toc-为什么需要目标试验模拟" class="nav-link" data-scroll-target="#为什么需要目标试验模拟">为什么需要目标试验模拟</a></li>
  </ul></li>
  <li><a href="#安装与加载" id="toc-安装与加载" class="nav-link" data-scroll-target="#安装与加载">安装与加载</a></li>
  <li><a href="#目标试验协议的7个组成部分" id="toc-目标试验协议的7个组成部分" class="nav-link" data-scroll-target="#目标试验协议的7个组成部分">目标试验协议的7个组成部分</a></li>
  <li><a href="#案例研究他汀类药物与心血管事件" id="toc-案例研究他汀类药物与心血管事件" class="nav-link" data-scroll-target="#案例研究他汀类药物与心血管事件">案例研究：他汀类药物与心血管事件</a>
  <ul class="collapse">
  <li><a href="#研究问题" id="toc-研究问题" class="nav-link" data-scroll-target="#研究问题">研究问题</a></li>
  <li><a href="#步骤1定义目标试验协议" id="toc-步骤1定义目标试验协议" class="nav-link" data-scroll-target="#步骤1定义目标试验协议">步骤1：定义目标试验协议</a></li>
  </ul></li>
  <li><a href="#模拟数据准备" id="toc-模拟数据准备" class="nav-link" data-scroll-target="#模拟数据准备">模拟数据准备</a></li>
  <li><a href="#步骤2检查入组标准" id="toc-步骤2检查入组标准" class="nav-link" data-scroll-target="#步骤2检查入组标准">步骤2：检查入组标准</a></li>
  <li><a href="#步骤3倾向评分加权" id="toc-步骤3倾向评分加权" class="nav-link" data-scroll-target="#步骤3倾向评分加权">步骤3：倾向评分加权</a>
  <ul class="collapse">
  <li><a href="#估计倾向评分" id="toc-估计倾向评分" class="nav-link" data-scroll-target="#估计倾向评分">估计倾向评分</a></li>
  <li><a href="#检验协变量平衡" id="toc-检验协变量平衡" class="nav-link" data-scroll-target="#检验协变量平衡">检验协变量平衡</a></li>
  </ul></li>
  <li><a href="#步骤4加权生存分析" id="toc-步骤4加权生存分析" class="nav-link" data-scroll-target="#步骤4加权生存分析">步骤4：加权生存分析</a>
  <ul class="collapse">
  <li><a href="#kaplan-meier曲线" id="toc-kaplan-meier曲线" class="nav-link" data-scroll-target="#kaplan-meier曲线">Kaplan-Meier曲线</a></li>
  <li><a href="#加权cox回归" id="toc-加权cox回归" class="nav-link" data-scroll-target="#加权cox回归">加权Cox回归</a></li>
  <li><a href="#结果解读" id="toc-结果解读" class="nav-link" data-scroll-target="#结果解读">结果解读</a></li>
  </ul></li>
  <li><a href="#处理时间相关偏倚" id="toc-处理时间相关偏倚" class="nav-link" data-scroll-target="#处理时间相关偏倚">处理时间相关偏倚</a>
  <ul class="collapse">
  <li><a href="#不朽时间偏倚" id="toc-不朽时间偏倚" class="nav-link" data-scroll-target="#不朽时间偏倚">不朽时间偏倚</a></li>
  <li><a href="#使用克隆-审查-加权法" id="toc-使用克隆-审查-加权法" class="nav-link" data-scroll-target="#使用克隆-审查-加权法">使用克隆-审查-加权法</a></li>
  </ul></li>
  <li><a href="#target报告清单" id="toc-target报告清单" class="nav-link" data-scroll-target="#target报告清单">TARGET报告清单</a></li>
  <li><a href="#完整分析流程" id="toc-完整分析流程" class="nav-link" data-scroll-target="#完整分析流程">完整分析流程</a>
  <ul class="collapse">
  <li><a href="#第1步定义并记录目标试验" id="toc-第1步定义并记录目标试验" class="nav-link" data-scroll-target="#第1步定义并记录目标试验">第1步：定义并记录目标试验</a></li>
  <li><a href="#第2步选择符合条件的观察数据" id="toc-第2步选择符合条件的观察数据" class="nav-link" data-scroll-target="#第2步选择符合条件的观察数据">第2步：选择符合条件的观察数据</a></li>
  <li><a href="#第3步倾向评分加权" id="toc-第3步倾向评分加权" class="nav-link" data-scroll-target="#第3步倾向评分加权">第3步：倾向评分加权</a></li>
  <li><a href="#第4步加权cox回归" id="toc-第4步加权cox回归" class="nav-link" data-scroll-target="#第4步加权cox回归">第4步：加权Cox回归</a></li>
  <li><a href="#第5步敏感性分析" id="toc-第5步敏感性分析" class="nav-link" data-scroll-target="#第5步敏感性分析">第5步：敏感性分析</a></li>
  </ul></li>
  <li><a href="#总结" id="toc-总结" class="nav-link" data-scroll-target="#总结">总结</a>
  <ul class="collapse">
  <li><a href="#推荐资源" id="toc-推荐资源" class="nav-link" data-scroll-target="#推荐资源">推荐资源</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">R 语言方法</li><li class="breadcrumb-item"><a href="./1018-psm.html">🎯 因果推断</a></li><li class="breadcrumb-item"><a href="./1057-target-trial.html">目标试验模拟</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">目标试验模拟 (Target Trial Emulation)</h1>
  <div class="quarto-categories">
    <div class="quarto-category">R语言方法</div>
    <div class="quarto-category">因果推断</div>
    <div class="quarto-category">观察性研究</div>
  </div>
  </div>

<div>
  <div class="description">
    使用观察性数据模拟随机对照试验，遵循TARGET报告指南进行严谨的因果推断。
  </div>
</div>


<div class="quarto-title-meta column-body">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 14, 2026</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="什么是目标试验模拟" class="level2">
<h2 class="anchored" data-anchor-id="什么是目标试验模拟">什么是目标试验模拟</h2>
<p><strong>目标试验模拟（Target Trial Emulation, TTE）</strong> 是一种利用观察性数据来模拟假想的随机对照试验（RCT）的方法框架。其核心思想是：</p>
<blockquote class="blockquote">
<p>在分析观察性数据之前，首先明确描述一个理想的RCT（目标试验），然后使用观察数据尽可能地模拟这个试验。</p>
</blockquote>
<section id="为什么需要目标试验模拟" class="level3">
<h3 class="anchored" data-anchor-id="为什么需要目标试验模拟">为什么需要目标试验模拟</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>传统观察性研究</th>
<th>目标试验模拟</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>容易产生时间相关偏倚</td>
<td>明确定义时间零点</td>
</tr>
<tr class="even">
<td>选择偏倚难以识别</td>
<td>清晰的入组标准</td>
</tr>
<tr class="odd">
<td>因果解释模糊</td>
<td>明确的因果问题</td>
</tr>
<tr class="even">
<td>报告不规范</td>
<td>遵循TARGET指南</td>
</tr>
</tbody>
</table>
<blockquote class="blockquote">
<p><strong>2025年JAMA发布了TARGET报告指南</strong>，包含21条报告清单，推动了目标试验模拟的标准化。</p>
</blockquote>
<hr>
</section>
</section>
<section id="安装与加载" class="level2">
<h2 class="anchored" data-anchor-id="安装与加载">安装与加载</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载必要的包</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survminer)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tableone)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(WeightIt)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cobalt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="目标试验协议的7个组成部分" class="level2">
<h2 class="anchored" data-anchor-id="目标试验协议的7个组成部分">目标试验协议的7个组成部分</h2>
<p>一个完整的目标试验协议包含以下7个部分：</p>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>目标试验协议组成</caption>
<colgroup>
<col style="width: 35%">
<col style="width: 30%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">组成部分</th>
<th style="text-align: left;">说明</th>
<th style="text-align: left;">模拟策略</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1. 入组标准 (Eligibility)</td>
<td style="text-align: left;">谁可以入组试验？</td>
<td style="text-align: left;">使用观察数据中符合条件的患者</td>
</tr>
<tr class="even">
<td style="text-align: left;">2. 治疗策略 (Treatment)</td>
<td style="text-align: left;">比较哪些治疗方案？</td>
<td style="text-align: left;">基于实际治疗记录定义</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3. 分配策略 (Assignment)</td>
<td style="text-align: left;">如何分配到治疗组？</td>
<td style="text-align: left;">使用统计方法调整混杂</td>
</tr>
<tr class="even">
<td style="text-align: left;">4. 随访起点 (Time zero)</td>
<td style="text-align: left;">何时开始随访（基线）？</td>
<td style="text-align: left;">治疗开始时作为时间零点</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5. 结局 (Outcome)</td>
<td style="text-align: left;">主要和次要结局是什么？</td>
<td style="text-align: left;">从电子健康记录提取</td>
</tr>
<tr class="even">
<td style="text-align: left;">6. 因果对比 (Causal contrast)</td>
<td style="text-align: left;">ITT还是Per-protocol效应？</td>
<td style="text-align: left;">调整依从性偏离</td>
</tr>
<tr class="odd">
<td style="text-align: left;">7. 分析计划 (Analysis)</td>
<td style="text-align: left;">统计分析方法</td>
<td style="text-align: left;">IPW、克隆-审查-加权等</td>
</tr>
</tbody>
</table>
</div>
</div>
<hr>
</section>
<section id="案例研究他汀类药物与心血管事件" class="level2">
<h2 class="anchored" data-anchor-id="案例研究他汀类药物与心血管事件">案例研究：他汀类药物与心血管事件</h2>
<section id="研究问题" class="level3">
<h3 class="anchored" data-anchor-id="研究问题">研究问题</h3>
<p><strong>在有高血压的成年人中，启动他汀治疗与不使用他汀相比，是否降低5年内心血管事件风险？</strong></p>
</section>
<section id="步骤1定义目标试验协议" class="level3">
<h3 class="anchored" data-anchor-id="步骤1定义目标试验协议">步骤1：定义目标试验协议</h3>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>他汀研究的目标试验协议</caption>
<colgroup>
<col style="width: 11%">
<col style="width: 54%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">组成部分</th>
<th style="text-align: left;">目标试验</th>
<th style="text-align: left;">模拟方案</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">入组标准</td>
<td style="text-align: left;">40-75岁；有高血压；无CVD史；未使用他汀</td>
<td style="text-align: left;">选择符合条件的电子健康记录</td>
</tr>
<tr class="even">
<td style="text-align: left;">治疗策略</td>
<td style="text-align: left;">策略A：启动他汀并持续使用</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">策略B：不使用他汀</td>
<td style="text-align: left;">基于处方记录定义</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">分配策略</td>
<td style="text-align: left;">随机分配</td>
<td style="text-align: left;">IPW调整混杂</td>
</tr>
<tr class="odd">
<td style="text-align: left;">随访起点</td>
<td style="text-align: left;">随机化当天</td>
<td style="text-align: left;">首次满足入组标准的日期</td>
</tr>
<tr class="even">
<td style="text-align: left;">结局</td>
<td style="text-align: left;">首次CVD事件或心血管死亡</td>
<td style="text-align: left;">诊断代码识别CVD事件</td>
</tr>
<tr class="odd">
<td style="text-align: left;">因果对比</td>
<td style="text-align: left;">ITT效应</td>
<td style="text-align: left;">使用IPW估计ITT效应</td>
</tr>
<tr class="even">
<td style="text-align: left;">分析计划</td>
<td style="text-align: left;">Kaplan-Meier + Cox回归</td>
<td style="text-align: left;">加权Cox回归</td>
</tr>
</tbody>
</table>
</div>
</div>
<hr>
</section>
</section>
<section id="模拟数据准备" class="level2">
<h2 class="anchored" data-anchor-id="模拟数据准备">模拟数据准备</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 模拟观察性队列数据</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2024</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">2000</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 基线协变量</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>data_obs <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(n, <span class="dv">55</span>, <span class="dv">10</span>)),</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">male =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.45</span>),</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">diabetes =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.25</span>),</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">smoking =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.30</span>),</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">sbp =</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(n, <span class="dv">145</span>, <span class="dv">15</span>)),</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">ldl =</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(n, <span class="dv">140</span>, <span class="dv">30</span>)),</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">bmi =</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(n, <span class="dv">27</span>, <span class="dv">5</span>), <span class="dv">1</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 限制年龄范围</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(age <span class="sc">&gt;=</span> <span class="dv">40</span>, age <span class="sc">&lt;=</span> <span class="dv">75</span>)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 治疗分配（基于协变量的选择偏倚）</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>data_obs <span class="ot">&lt;-</span> data_obs <span class="sc">%&gt;%</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 治疗倾向（高风险更可能使用他汀）</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">ps_logit =</span> <span class="sc">-</span><span class="dv">3</span> <span class="sc">+</span> <span class="fl">0.05</span> <span class="sc">*</span> age <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> diabetes <span class="sc">+</span> <span class="fl">0.2</span> <span class="sc">*</span> smoking <span class="sc">+</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>            <span class="fl">0.02</span> <span class="sc">*</span> ldl <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> male,</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">ps =</span> <span class="fu">plogis</span>(ps_logit),</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">statin =</span> <span class="fu">rbinom</span>(<span class="fu">n</span>(), <span class="dv">1</span>, ps)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 生成结局</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>data_obs <span class="ot">&lt;-</span> data_obs <span class="sc">%&gt;%</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 事件风险</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">risk_logit =</span> <span class="sc">-</span><span class="dv">5</span> <span class="sc">+</span> <span class="fl">0.05</span> <span class="sc">*</span> age <span class="sc">+</span> <span class="fl">0.8</span> <span class="sc">*</span> diabetes <span class="sc">+</span> <span class="fl">0.6</span> <span class="sc">*</span> smoking <span class="sc">+</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>            <span class="fl">0.02</span> <span class="sc">*</span> sbp <span class="sc">+</span> <span class="fl">0.01</span> <span class="sc">*</span> ldl <span class="sc">-</span> <span class="fl">0.4</span> <span class="sc">*</span> statin,</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">event_prob =</span> <span class="fu">plogis</span>(risk_logit),</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>        <span class="at">event =</span> <span class="fu">rbinom</span>(<span class="fu">n</span>(), <span class="dv">1</span>, event_prob),</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 随访时间</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">time =</span> <span class="fu">ifelse</span>(event <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rexp</span>(<span class="fu">n</span>(), <span class="at">rate =</span> <span class="fl">0.3</span>) <span class="sc">*</span> <span class="dv">12</span>, <span class="co"># 事件时间</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>            <span class="fu">runif</span>(<span class="fu">n</span>(), <span class="dv">36</span>, <span class="dv">60</span>)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>        ), <span class="co"># 删失时间</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>        <span class="at">time =</span> <span class="fu">pmin</span>(time, <span class="dv">60</span>) <span class="co"># 最长5年</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>ps_logit, <span class="sc">-</span>risk_logit, <span class="sc">-</span>event_prob, <span class="sc">-</span>ps)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data_obs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 11
     id   age  male diabetes smoking   sbp   ldl   bmi statin event   time
  &lt;int&gt; &lt;dbl&gt; &lt;int&gt;    &lt;int&gt;   &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;int&gt; &lt;int&gt;  &lt;dbl&gt;
1     1    65     1        0       1   155   137  23.8      1     0 43.2  
2     2    60     0        0       1   146   116  30.9      1     1  0.911
3     3    54     0        0       0   126   170  32        1     1 16.5  
4     4    53     0        0       0   150   163  26.7      1     1 37.9  
5     5    67     0        0       0   150   122  27.3      1     1 37.2  
6     6    68     0        0       1   152   120  17.8      1     1 24.4  </code></pre>
</div>
</div>
<hr>
</section>
<section id="步骤2检查入组标准" class="level2">
<h2 class="anchored" data-anchor-id="步骤2检查入组标准">步骤2：检查入组标准</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 基线特征表</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>baseline_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"male"</span>, <span class="st">"diabetes"</span>, <span class="st">"smoking"</span>, <span class="st">"sbp"</span>, <span class="st">"ldl"</span>, <span class="st">"bmi"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>table1 <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">vars =</span> baseline_vars,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">strata =</span> <span class="st">"statin"</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data_obs,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">test =</span> <span class="cn">TRUE</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(table1, <span class="at">smd =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                      Stratified by statin
                       0              1              p      test SMD   
  n                       126           1713                           
  age (mean (SD))       52.29 (7.00)   56.04 (8.08)  &lt;0.001       0.496
  male (mean (SD))       0.34 (0.48)    0.46 (0.50)   0.013       0.234
  diabetes (mean (SD))   0.22 (0.42)    0.24 (0.43)   0.643       0.043
  smoking (mean (SD))    0.31 (0.46)    0.30 (0.46)   0.780       0.026
  sbp (mean (SD))      146.66 (16.15) 144.62 (14.76)  0.137       0.132
  ldl (mean (SD))      125.55 (30.05) 140.48 (30.34) &lt;0.001       0.495
  bmi (mean (SD))       27.08 (5.24)   26.98 (5.03)   0.822       0.020</code></pre>
</div>
</div>
<p><strong>观察</strong>：治疗组和对照组存在基线差异（SMD &gt; 0.1），说明存在选择偏倚，需要调整。</p>
<hr>
</section>
<section id="步骤3倾向评分加权" class="level2">
<h2 class="anchored" data-anchor-id="步骤3倾向评分加权">步骤3：倾向评分加权</h2>
<section id="估计倾向评分" class="level3">
<h3 class="anchored" data-anchor-id="估计倾向评分">估计倾向评分</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 拟合倾向评分模型</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>ps_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    statin <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> diabetes <span class="sc">+</span> smoking <span class="sc">+</span> sbp <span class="sc">+</span> ldl <span class="sc">+</span> bmi,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data_obs,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> binomial</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算倾向评分和权重</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>data_obs <span class="ot">&lt;-</span> data_obs <span class="sc">%&gt;%</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">ps =</span> <span class="fu">predict</span>(ps_model, <span class="at">type =</span> <span class="st">"response"</span>),</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ATE权重</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">ipw =</span> <span class="fu">ifelse</span>(statin <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span> <span class="sc">/</span> ps, <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps)),</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 截断极端权重</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">ipw_truncated =</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(ipw, <span class="fu">quantile</span>(ipw, <span class="fl">0.01</span>)), <span class="fu">quantile</span>(ipw, <span class="fl">0.99</span>))</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="检验协变量平衡" class="level3">
<h3 class="anchored" data-anchor-id="检验协变量平衡">检验协变量平衡</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用WeightIt检验平衡</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>bal_tab <span class="ot">&lt;-</span> <span class="fu">bal.tab</span>(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    statin <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> diabetes <span class="sc">+</span> smoking <span class="sc">+</span> sbp <span class="sc">+</span> ldl <span class="sc">+</span> bmi,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data_obs,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> data_obs<span class="sc">$</span>ipw_truncated,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"weighting"</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(bal_tab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Balance Measures
            Type Diff.Adj
age      Contin.   0.1881
male      Binary   0.0230
diabetes  Binary   0.0132
smoking   Binary  -0.0089
sbp      Contin.  -0.0893
ldl      Contin.   0.1068
bmi      Contin.  -0.0589

Effective sample sizes
           Control Treated
Unadjusted  126.   1713.  
Adjusted    101.25 1707.42</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 可视化平衡</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">love.plot</span>(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    statin <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> diabetes <span class="sc">+</span> smoking <span class="sc">+</span> sbp <span class="sc">+</span> ldl <span class="sc">+</span> bmi,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data_obs,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> data_obs<span class="sc">$</span>ipw_truncated,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">threshold =</span> <span class="fl">0.1</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"加权前后协变量平衡（Love图）"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1057-target-trial_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="步骤4加权生存分析" class="level2">
<h2 class="anchored" data-anchor-id="步骤4加权生存分析">步骤4：加权生存分析</h2>
<section id="kaplan-meier曲线" class="level3">
<h3 class="anchored" data-anchor-id="kaplan-meier曲线">Kaplan-Meier曲线</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 创建生存对象</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>data_obs<span class="sc">$</span>surv_obj <span class="ot">&lt;-</span> <span class="fu">Surv</span>(data_obs<span class="sc">$</span>time, data_obs<span class="sc">$</span>event)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 加权KM曲线（使用survey包更准确，这里简化演示）</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>km_fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    surv_obj <span class="sc">~</span> statin,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data_obs,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> ipw_truncated</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 绘制生存曲线</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    km_fit,</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data_obs,</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">"#4f46e5"</span>, <span class="st">"#10b981"</span>),</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">risk.table =</span> <span class="cn">TRUE</span>,</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">"随访时间（月）"</span>,</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylab =</span> <span class="st">"无事件生存概率"</span>,</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.labs =</span> <span class="fu">c</span>(<span class="st">"未使用他汀"</span>, <span class="st">"使用他汀"</span>),</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="st">"治疗组"</span>,</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"加权Kaplan-Meier生存曲线"</span>,</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">ggtheme =</span> <span class="fu">theme_minimal</span>()</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1057-target-trial_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="加权cox回归" class="level3">
<h3 class="anchored" data-anchor-id="加权cox回归">加权Cox回归</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 加权Cox回归</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>cox_weighted <span class="ot">&lt;-</span> <span class="fu">coxph</span>(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    surv_obj <span class="sc">~</span> statin,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data_obs,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> ipw_truncated,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span> <span class="co"># 稳健标准误</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 结果摘要</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(cox_weighted, <span class="at">conf.int =</span> <span class="cn">TRUE</span>, <span class="at">exponentiate =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 8
  term   estimate std.error robust.se statistic p.value conf.low conf.high
  &lt;chr&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 statin    0.871    0.0366    0.0950     -1.45   0.147    0.723      1.05</code></pre>
</div>
</div>
</section>
<section id="结果解读" class="level3">
<h3 class="anchored" data-anchor-id="结果解读">结果解读</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>hr <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">coef</span>(cox_weighted))</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>ci <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">confint</span>(cox_weighted))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"使用他汀与不使用相比，心血管事件的风险比为 %.2f (95%% CI: %.2f-%.2f)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    hr, ci[<span class="dv">1</span>], ci[<span class="dv">2</span>]</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>使用他汀与不使用相比，心血管事件的风险比为 0.87 (95% CI: 0.72-1.05)</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="处理时间相关偏倚" class="level2">
<h2 class="anchored" data-anchor-id="处理时间相关偏倚">处理时间相关偏倚</h2>
<section id="不朽时间偏倚" class="level3">
<h3 class="anchored" data-anchor-id="不朽时间偏倚">不朽时间偏倚</h3>
<p><strong>不朽时间偏倚（Immortal Time Bias）</strong> 是目标试验模拟中最常见的偏倚：</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1057-target-trial_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="使用克隆-审查-加权法" class="level3">
<h3 class="anchored" data-anchor-id="使用克隆-审查-加权法">使用克隆-审查-加权法</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 克隆-审查-加权法伪代码</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 克隆：每个符合条件的患者复制两份</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>cloned_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    data_obs <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">assigned =</span> <span class="dv">0</span>), <span class="co"># 分配到未治疗组</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    data_obs <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">assigned =</span> <span class="dv">1</span>) <span class="co"># 分配到治疗组</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 审查：当实际治疗与分配不符时审查</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>cloned_data <span class="ot">&lt;-</span> cloned_data <span class="sc">%&gt;%</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 如果分配到治疗组但实际未治疗，在治疗时间审查</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 如果分配到未治疗组但实际接受治疗，在治疗时间审查</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">artificial_censoring =</span> <span class="fu">case_when</span>(</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>            assigned <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> statin <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="cn">TRUE</span>,</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>            assigned <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> statin <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="cn">TRUE</span>,</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>            <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">FALSE</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. 加权：使用IPCW校正人为审查</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
</section>
<section id="target报告清单" class="level2">
<h2 class="anchored" data-anchor-id="target报告清单">TARGET报告清单</h2>
<p>2025年JAMA发布的TARGET指南包含21条报告项目：</p>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>TARGET报告清单（简化版）</caption>
<thead>
<tr class="header">
<th style="text-align: left;">类别</th>
<th style="text-align: left;">条目</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">标题与摘要</td>
<td style="text-align: left;">1. 标题表明使用目标试验框架</td>
</tr>
<tr class="even">
<td style="text-align: left;">标题与摘要</td>
<td style="text-align: left;">2. 摘要描述目标试验和模拟方法</td>
</tr>
<tr class="odd">
<td style="text-align: left;">引言</td>
<td style="text-align: left;">3. 说明研究问题和理由</td>
</tr>
<tr class="even">
<td style="text-align: left;">引言</td>
<td style="text-align: left;">4. 说明为何使用观察数据</td>
</tr>
<tr class="odd">
<td style="text-align: left;">方法</td>
<td style="text-align: left;">5. 描述目标试验协议</td>
</tr>
<tr class="even">
<td style="text-align: left;">方法</td>
<td style="text-align: left;">6. 描述数据来源</td>
</tr>
<tr class="odd">
<td style="text-align: left;">方法</td>
<td style="text-align: left;">7. 描述入组标准的操作化定义</td>
</tr>
<tr class="even">
<td style="text-align: left;">方法</td>
<td style="text-align: left;">8. 描述治疗策略的定义</td>
</tr>
<tr class="odd">
<td style="text-align: left;">方法</td>
<td style="text-align: left;">9. 描述时间零点的确定</td>
</tr>
<tr class="even">
<td style="text-align: left;">方法</td>
<td style="text-align: left;">10. 描述结局的测量</td>
</tr>
<tr class="odd">
<td style="text-align: left;">方法</td>
<td style="text-align: left;">11. 描述随访方式</td>
</tr>
<tr class="even">
<td style="text-align: left;">方法</td>
<td style="text-align: left;">12. 描述因果对比</td>
</tr>
<tr class="odd">
<td style="text-align: left;">方法</td>
<td style="text-align: left;">13. 描述统计分析方法</td>
</tr>
<tr class="even">
<td style="text-align: left;">方法</td>
<td style="text-align: left;">14. 描述敏感性分析</td>
</tr>
<tr class="odd">
<td style="text-align: left;">结果</td>
<td style="text-align: left;">15. 报告符合入组标准的人数</td>
</tr>
<tr class="even">
<td style="text-align: left;">结果</td>
<td style="text-align: left;">16. 报告基线特征</td>
</tr>
<tr class="odd">
<td style="text-align: left;">结果</td>
<td style="text-align: left;">17. 报告主要分析结果</td>
</tr>
<tr class="even">
<td style="text-align: left;">结果</td>
<td style="text-align: left;">18. 报告敏感性分析结果</td>
</tr>
<tr class="odd">
<td style="text-align: left;">讨论</td>
<td style="text-align: left;">19. 讨论目标试验与模拟的差异</td>
</tr>
<tr class="even">
<td style="text-align: left;">讨论</td>
<td style="text-align: left;">20. 讨论结果的因果解释</td>
</tr>
<tr class="odd">
<td style="text-align: left;">讨论</td>
<td style="text-align: left;">21. 讨论局限性和未来方向</td>
</tr>
</tbody>
</table>
</div>
</div>
<hr>
</section>
<section id="完整分析流程" class="level2">
<h2 class="anchored" data-anchor-id="完整分析流程">完整分析流程</h2>
<section id="第1步定义并记录目标试验" class="level3">
<h3 class="anchored" data-anchor-id="第1步定义并记录目标试验">第1步：定义并记录目标试验</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 记录目标试验协议</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>protocol_doc <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="st">## 目标试验协议</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="st">### 入组标准</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="st">- 年龄40-75岁</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="st">- 诊断高血压</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="st">- 无心血管疾病史</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="st">- 过去12个月未使用他汀</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="st">### 治疗策略</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="st">- 策略A：启动他汀治疗</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="st">- 策略B：不启动他汀治疗</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="st">### 分配策略</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="st">- 随机分配（1:1）</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="st">### 随访起点</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="st">- 随机化日期</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="st">### 结局</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="st">- 主要结局：首次主要不良心血管事件（MACE）</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="st">- 随访时间：5年</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="st">### 因果对比</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="st">- 意向性治疗（ITT）效应</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="st">### 分析计划</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a><span class="st">- IPW调整混杂</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a><span class="st">- Cox比例风险回归</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a><span class="st">- 敏感性分析：E值、不同权重截断点</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(protocol_doc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
## 目标试验协议

### 入组标准
- 年龄40-75岁
- 诊断高血压
- 无心血管疾病史
- 过去12个月未使用他汀

### 治疗策略
- 策略A：启动他汀治疗
- 策略B：不启动他汀治疗

### 分配策略
- 随机分配（1:1）

### 随访起点
- 随机化日期

### 结局
- 主要结局：首次主要不良心血管事件（MACE）
- 随访时间：5年

### 因果对比
- 意向性治疗（ITT）效应

### 分析计划
- IPW调整混杂
- Cox比例风险回归
- 敏感性分析：E值、不同权重截断点</code></pre>
</div>
</div>
</section>
<section id="第2步选择符合条件的观察数据" class="level3">
<h3 class="anchored" data-anchor-id="第2步选择符合条件的观察数据">第2步：选择符合条件的观察数据</h3>
</section>
<section id="第3步倾向评分加权" class="level3">
<h3 class="anchored" data-anchor-id="第3步倾向评分加权">第3步：倾向评分加权</h3>
</section>
<section id="第4步加权cox回归" class="level3">
<h3 class="anchored" data-anchor-id="第4步加权cox回归">第4步：加权Cox回归</h3>
</section>
<section id="第5步敏感性分析" class="level3">
<h3 class="anchored" data-anchor-id="第5步敏感性分析">第5步：敏感性分析</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># E值敏感性分析</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(EValue)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>hr_result <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">coef</span>(cox_weighted))</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">evalue</span>(<span class="at">est =</span> <span class="fu">HR</span>(hr_result, <span class="at">rare =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             point lower upper
RR       0.8714156    NA    NA
E-values 1.5590572    NA    NA</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="总结" class="level2">
<h2 class="anchored" data-anchor-id="总结">总结</h2>
<table class="caption-top table">
<thead>
<tr class="header">
<th>步骤</th>
<th>关键点</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1. 定义目标试验</td>
<td>明确7个协议组成部分</td>
</tr>
<tr class="even">
<td>2. 识别数据源</td>
<td>评估数据能否模拟目标试验</td>
</tr>
<tr class="odd">
<td>3. 操作化定义</td>
<td>将协议转化为可测量的变量</td>
</tr>
<tr class="even">
<td>4. 处理偏倚</td>
<td>使用IPW、克隆-审查-加权等方法</td>
</tr>
<tr class="odd">
<td>5. 分析与报告</td>
<td>遵循TARGET指南</td>
</tr>
</tbody>
</table>
<section id="推荐资源" class="level3">
<h3 class="anchored" data-anchor-id="推荐资源">推荐资源</h3>
<ul>
<li>Hernán MA, Robins JM. Using Big Data to Emulate a Target Trial</li>
<li><a href="https://jamanetwork.com/">TARGET Reporting Guideline (2025)</a></li>
<li><a href="https://www.hsph.harvard.edu/causallab/">CAUSALab Harvard</a></li>
<li>Hernán &amp; Robins《Causal Inference: What If》</li>
</ul>


</section>
</section>

</main> <!-- /main -->
<!-- Back to Top Button -->

<button id="back-to-top" aria-label="Back to Top">

    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">

        <path d="M18 15l-6-6-6 6"></path>

    </svg>

</button>



<!-- Floating TOC Button (Mobile Only) -->

<button id="toc-floating-btn" aria-label="Table of Contents">

    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">

        <line x1="8" y1="6" x2="21" y2="6"></line>

        <line x1="8" y1="12" x2="21" y2="12"></line>

        <line x1="8" y1="18" x2="21" y2="18"></line>

        <line x1="3" y1="6" x2="3.01" y2="6"></line>

        <line x1="3" y1="12" x2="3.01" y2="12"></line>

        <line x1="3" y1="18" x2="3.01" y2="18"></line>

    </svg>

</button>



<!-- TOC Modal -->

<div class="toc-modal-overlay">

    <div class="toc-modal-content">

        <div class="toc-modal-header">

            <div class="toc-modal-title">目录</div>

            <button class="toc-modal-close" aria-label="Close">×</button>

        </div>

        <div class="toc-modal-body" id="toc-modal-body">

            <!-- TOC content will be injected here -->

        </div>

    </div>

</div>



<script>

    // Back to Top Logic

    const backToTopBtn = document.getElementById('back-to-top');



    window.addEventListener('scroll', () => {

        if (window.scrollY > 300) {

            backToTopBtn.classList.add('visible');

        } else {

            backToTopBtn.classList.remove('visible');

        }

    });



    backToTopBtn.addEventListener('click', () => {

        window.scrollTo({

            top: 0,

            behavior: 'smooth'

        });

    });



    // Mobile Table Scrolling Logic

    document.addEventListener("DOMContentLoaded", function () {

        const tables = document.querySelectorAll('table');

        tables.forEach(table => {

            if (!table.parentElement.classList.contains('table-responsive')) {

                const wrapper = document.createElement('div');

                wrapper.className = 'table-responsive';

                wrapper.style.overflowX = 'auto'; // Force scroll

                table.parentNode.insertBefore(wrapper, table);

                wrapper.appendChild(table);

            }

        });



        // Floating TOC Logic

        const tocBtn = document.getElementById('toc-floating-btn');

        const tocOverlay = document.querySelector('.toc-modal-overlay');

        const tocClose = document.querySelector('.toc-modal-close');

        const tocBody = document.getElementById('toc-modal-body');

        const originalToc = document.getElementById('TOC');



        if (originalToc && tocBtn) {

            // Check if TOC has content

            const tocLinks = originalToc.querySelectorAll('a');

            if (tocLinks.length > 0) {

                tocBtn.style.display = 'flex';



                // Function to populate modal

                const populateToc = () => {

                    tocBody.innerHTML = '';

                    const tocClone = originalToc.querySelector('ul').cloneNode(true);

                    tocBody.appendChild(tocClone);



                    // Add click listeners to close modal on link click

                    tocBody.querySelectorAll('a').forEach(link => {

                        link.addEventListener('click', () => {

                            tocOverlay.classList.remove('active');

                            // Smooth scroll to target (handled by browser usually, but ensure modal closes first)

                        });

                    });

                };



                tocBtn.addEventListener('click', () => {

                    populateToc();

                    tocOverlay.classList.add('active');

                });



                tocClose.addEventListener('click', () => {

                    tocOverlay.classList.remove('active');

                });



                tocOverlay.addEventListener('click', (e) => {

                    if (e.target === tocOverlay) {

                        tocOverlay.classList.remove('active');

                    }

                });

            } else {

                tocBtn.style.display = 'none';

            }

        } else if (tocBtn) {

            tocBtn.style.display = 'none';

        }



        // Article Footer Random Recommendation

        // Only run on article pages (has sidebar and main content)

        const sidebar = document.querySelector('#quarto-sidebar') || document.querySelector('.sidebar');

        const mainContent = document.querySelector('main');



        if (sidebar && mainContent) {

            const links = Array.from(sidebar.querySelectorAll('a.sidebar-item-text'));



            // If no links found with specific class, try generic anchor in sidebar

            const allLinks = links.length > 0 ? links : Array.from(sidebar.querySelectorAll('a'));



            // Filter out section headers if they are just toggles (usually href is # or empty)

            const validLinks = allLinks.filter(a => a.href && !a.href.endsWith('#') && !a.href.includes('javascript:'));



            // Article Footer Navigation (Prev/Next + Random)

            const currentUrl = window.location.href.split('#')[0];

            let currentIndex = -1;



            // Find current article index

            for (let i = 0; i < validLinks.length; i++) {

                if (validLinks[i].href.split('#')[0] === currentUrl) {

                    currentIndex = i;

                    break;

                }

            }



            // Create Container

            const footerNav = document.createElement('div');

            footerNav.className = 'article-footer-nav-container';

            footerNav.style.marginTop = '4rem';

            footerNav.style.paddingTop = '2rem';

            footerNav.style.borderTop = '1px solid #e5e7eb';



            // 1. Prev/Next Navigation

            if (currentIndex !== -1) {

                let navHtml = '<div class="article-footer-nav">';



                // Previous

                if (currentIndex > 0) {

                    const prevLink = validLinks[currentIndex - 1];

                    const prevTitle = prevLink.innerText.trim();

                    navHtml += `

                        <a href="${prevLink.href}" class="article-nav-link">

                            <span class="nav-label">上一篇</span>

                            <span class="nav-title">« ${prevTitle}</span>

                        </a>

                    `;

                } else {

                    navHtml += `<div></div>`;

                }



                // Next

                if (currentIndex < validLinks.length - 1) {

                    const nextLink = validLinks[currentIndex + 1];

                    const nextTitle = nextLink.innerText.trim();

                    navHtml += `

                        <a href="${nextLink.href}" class="article-nav-link" style="text-align: right;">

                            <span class="nav-label">下一篇</span>

                            <span class="nav-title">${nextTitle} »</span>

                        </a>

                    `;

                } else {

                    navHtml += `<div></div>`;

                }



                navHtml += '</div>';



                // Append Prev/Next HTML

                const navDiv = document.createElement('div');

                navDiv.innerHTML = navHtml;

                footerNav.appendChild(navDiv);

            }



            // 2. Random Recommendation

            const otherLinks = validLinks.filter((_, idx) => idx !== currentIndex);

            if (otherLinks.length > 0) {

                const randomIdx = Math.floor(Math.random() * otherLinks.length);

                const randomLink = otherLinks[randomIdx];

                const randomTitle = randomLink.innerText.trim(); // Use innerText for title



                if (randomTitle) {

                    const randomDiv = document.createElement('div');

                    randomDiv.innerHTML = `

                        <div class="random-recommendation">

                            <h4>👋 随便看看</h4>

                            <p>探索更多 R 语言精彩内容</p>

                            <a href="${randomLink.href}" class="random-btn">

                                🎲 ${randomTitle}

                            </a>

                        </div>

                    `;

                    footerNav.appendChild(randomDiv);

                }

            }



            mainContent.appendChild(footerNav);

        }

    });

</script>



<!-- Like Button Styles -->

<style>

    .article-like-container {

        display: flex;

        justify-content: flex-start;

        margin: 1.5rem 0 2rem 0;

        padding: 0;

    }



    .like-wrapper {

        display: flex;

        flex-direction: column;

        align-items: flex-start;

        gap: 0.4rem;

    }



    .like-btn {

        display: inline-flex;

        align-items: center;

        gap: 0.5rem;

        padding: 0.6rem 1.2rem;

        border: 2px solid #e5e7eb;

        border-radius: 50px;

        background: white;

        color: #6b7280;

        font-size: 0.95rem;

        font-weight: 500;

        cursor: pointer;

        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);

        user-select: none;

    }



    .like-btn:hover {

        border-color: #f472b6;

        color: #ec4899;

        background: #fdf2f8;

    }



    .like-btn.liked {

        border-color: #ec4899;

        color: #ec4899;

        background: #fdf2f8;

    }



    .like-btn.pop {

        animation: pop-animation 0.3s ease;

    }



    @keyframes pop-animation {

        0% {

            transform: scale(1);

        }



        50% {

            transform: scale(1.15);

        }



        100% {

            transform: scale(1);

        }

    }



    .like-icon {

        width: 20px;

        height: 20px;

        transition: transform 0.2s;

    }



    .like-btn:hover .like-icon {

        transform: scale(1.1);

    }



    .like-icon .heart-outline {

        fill: none;

        stroke: currentColor;

        stroke-width: 2;

    }



    .like-icon .heart-fill {

        fill: currentColor;

        opacity: 0;

        transition: opacity 0.2s;

    }



    .like-btn.liked .heart-fill {

        opacity: 1;

    }



    .like-btn.liked .heart-outline {

        stroke: none;

    }



    .like-text {

        font-size: 0.9rem;

    }



    .like-count {

        font-size: 0.85rem;

        min-width: 1rem;

        text-align: center;

    }



    .like-hint {

        font-size: 0.75rem;

        color: #9ca3af;

        padding-left: 0.25rem;

    }



    /* Mobile optimization */

    @media (max-width: 768px) {

        .article-like-container {

            margin: 1rem 0 1.5rem 0;

        }



        .like-btn {

            padding: 0.5rem 1rem;

            font-size: 0.9rem;

        }



        .like-icon {

            width: 18px;

            height: 18px;

        }

    }

</style>



<!-- Like Section Script with Supabase Backend -->

<script>

    // Supabase Configuration

    const SUPABASE_URL = 'https://zyfdzyifhvglibpganxt.supabase.co';

    const SUPABASE_ANON_KEY = 'sb_publishable_XhaP4hFZ30sHZybEjVRQxg_iwlPTxz8';



    document.addEventListener('DOMContentLoaded', async function () {

        const mainContent = document.querySelector('main');



        // Only show on article pages (not index, not sections)

        const isArticlePage = !window.location.pathname.includes('index.html') &&

            !window.location.pathname.includes('sections/') &&

            !window.location.pathname.endsWith('/');



        if (!isArticlePage || !mainContent) return;



        const articleId = window.location.pathname.replace(/[^a-zA-Z0-9]/g, '_');

        const likeKey = `article_like_${articleId}`; // localStorage key for current user's like state



        // Create Like Section (at page bottom)

        const likeSection = document.createElement('div');

        likeSection.className = 'article-like-section';



        // Initial state from localStorage (for immediate UI feedback)

        const isLiked = localStorage.getItem(likeKey) === 'true';

        let likeCount = 0;



        likeSection.innerHTML = `

            <div class="like-section-inner">

                <p class="like-prompt">觉得有帮助？点赞支持一下 👇</p>

                <button class="like-btn ${isLiked ? 'liked' : ''}" id="article-like-btn" aria-label="点赞">

                    <svg class="like-icon" viewBox="0 0 24 24" width="24" height="24">

                        <path class="heart-outline" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>

                        <path class="heart-fill" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>

                    </svg>

                    <span class="like-text">${isLiked ? '已喜欢' : '喜欢这篇文章'}</span>

                    <span class="like-count" id="like-count"><span class="loading-dots">...</span></span>

                </button>

            </div>

        `;



        mainContent.appendChild(likeSection);



        const likeBtn = document.getElementById('article-like-btn');

        const likeCountSpan = document.getElementById('like-count');

        const likeText = likeBtn.querySelector('.like-text');



        // Supabase API helper

        async function supabaseRequest(method, endpoint, body = null) {

            const options = {

                method: method,

                headers: {

                    'apikey': SUPABASE_ANON_KEY,

                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,

                    'Content-Type': 'application/json',

                    'Prefer': method === 'POST' ? 'return=representation' : 'return=minimal'

                }

            };

            if (body) options.body = JSON.stringify(body);



            try {

                const response = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, options);

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const text = await response.text();

                return text ? JSON.parse(text) : null;

            } catch (error) {

                console.error('Supabase error:', error);

                return null;

            }

        }



        // Fetch current like count from Supabase

        async function fetchLikeCount() {

            const data = await supabaseRequest('GET', `article_likes?article_id=eq.${articleId}&select=like_count`);

            if (data && data.length > 0) {

                return data[0].like_count;

            }

            return 0;

        }



        // Update like count in Supabase

        async function updateLikeCount(newCount) {

            // Try to update existing record

            const existing = await supabaseRequest('GET', `article_likes?article_id=eq.${articleId}&select=id`);



            if (existing && existing.length > 0) {

                // Update existing

                await supabaseRequest('PATCH', `article_likes?article_id=eq.${articleId}`, {

                    like_count: newCount

                });

            } else {

                // Insert new record

                await supabaseRequest('POST', 'article_likes', {

                    article_id: articleId,

                    like_count: newCount

                });

            }

        }



        // Load initial like count

        try {

            likeCount = await fetchLikeCount();

            likeCountSpan.textContent = likeCount > 0 ? likeCount : '';

        } catch (e) {

            console.error('Failed to fetch likes:', e);

            likeCountSpan.textContent = '';

        }



        // Like button click handler

        likeBtn.addEventListener('click', async function () {

            const currentlyLiked = this.classList.contains('liked');



            // Optimistic UI update

            if (currentlyLiked) {

                this.classList.remove('liked');

                likeCount = Math.max(0, likeCount - 1);

                likeText.textContent = '喜欢这篇文章';

                localStorage.setItem(likeKey, 'false');

            } else {

                this.classList.add('liked');

                likeCount++;

                likeText.textContent = '已喜欢';

                localStorage.setItem(likeKey, 'true');



                this.classList.add('pop');

                setTimeout(() => this.classList.remove('pop'), 300);

            }



            likeCountSpan.textContent = likeCount > 0 ? likeCount : '';



            // Sync with Supabase in background

            try {

                await updateLikeCount(likeCount);

            } catch (e) {

                console.error('Failed to sync like:', e);

            }

        });



        // ============================================

        // Comment Section with Supabase

        // ============================================



        // Create comment section HTML

        const commentSection = document.createElement('div');

        commentSection.className = 'comment-section';

        commentSection.innerHTML = `

            <h4 class="comment-title">💬 评论区</h4>

            <div class="comment-form">

                <input type="text" id="comment-nickname" class="comment-nickname" placeholder="昵称（可选）" maxlength="20">

                <textarea id="comment-content" class="comment-textarea" placeholder="写下你的想法..." maxlength="500" rows="3"></textarea>

                <div class="comment-form-footer">

                    <span class="char-count"><span id="char-count">0</span>/500</span>

                    <button id="submit-comment" class="comment-submit-btn">发表评论</button>

                </div>

            </div>

            <div id="comment-list" class="comment-list">

                <div class="loading-comments">加载评论中...</div>

            </div>

        `;



        // Append comment section after like section

        const likeSectionEl = document.querySelector('.article-like-section');

        if (likeSectionEl) {

            likeSectionEl.after(commentSection);

        } else {

            mainContent.appendChild(commentSection);

        }



        const commentNickname = document.getElementById('comment-nickname');

        const commentContent = document.getElementById('comment-content');

        const submitBtn = document.getElementById('submit-comment');

        const commentList = document.getElementById('comment-list');

        const charCount = document.getElementById('char-count');



        // Visitor ID for identifying own comments

        let visitorId = localStorage.getItem('visitor_id');

        if (!visitorId) {

            visitorId = 'v_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);

            localStorage.setItem('visitor_id', visitorId);

        }



        // Character counter

        commentContent.addEventListener('input', () => {

            charCount.textContent = commentContent.value.length;

        });



        // Format time helper

        function formatTime(timestamp) {

            const date = new Date(timestamp);

            const now = new Date();

            const diff = now - date;



            if (diff < 60000) return '刚刚';

            if (diff < 3600000) return Math.floor(diff / 60000) + ' 分钟前';

            if (diff < 86400000) return Math.floor(diff / 3600000) + ' 小时前';

            if (diff < 604800000) return Math.floor(diff / 86400000) + ' 天前';



            return date.toLocaleDateString('zh-CN');

        }



        // Escape HTML to prevent XSS

        function escapeHtml(text) {

            const div = document.createElement('div');

            div.textContent = text;

            return div.innerHTML;

        }



        // Fetch comments from Supabase

        async function fetchComments() {

            const data = await supabaseRequest('GET', `article_comments?article_id=eq.${articleId}&order=created_at.desc`);

            return data || [];

        }



        // Post new comment

        async function postComment(nickname, content) {

            return await supabaseRequest('POST', 'article_comments', {

                article_id: articleId,

                nickname: nickname || '匿名用户',

                content: content,

                visitor_id: visitorId

            });

        }



        // Delete comment

        async function deleteComment(commentId) {

            await supabaseRequest('DELETE', `article_comments?id=eq.${commentId}&visitor_id=eq.${visitorId}`);

        }



        // Render comments

        function renderComments(comments) {

            if (!comments || comments.length === 0) {

                commentList.innerHTML = '<div class="no-comments">暂无评论，来做第一个留言的人吧 🎉</div>';

                return;

            }



            commentList.innerHTML = comments.map(c => `

                <div class="comment-item" data-id="${c.id}">

                    <div class="comment-header">

                        <span class="comment-author">${escapeHtml(c.nickname || '匿名用户')}</span>

                        <span class="comment-time">${formatTime(c.created_at)}</span>

                        ${c.visitor_id === visitorId ? `<button class="comment-delete" data-id="${c.id}">删除</button>` : ''}

                    </div>

                    <div class="comment-body">${escapeHtml(c.content)}</div>

                </div>

            `).join('');



            // Add delete handlers

            commentList.querySelectorAll('.comment-delete').forEach(btn => {

                btn.addEventListener('click', async function () {

                    const id = this.dataset.id;

                    await deleteComment(id);

                    loadComments();

                });

            });

        }



        // Load and display comments

        async function loadComments() {

            try {

                const comments = await fetchComments();

                renderComments(comments);

            } catch (e) {

                console.error('Failed to load comments:', e);

                commentList.innerHTML = '<div class="no-comments">加载评论失败</div>';

            }

        }



        // Submit comment handler

        submitBtn.addEventListener('click', async function () {

            const content = commentContent.value.trim();

            if (!content) {

                alert('请输入评论内容');

                return;

            }



            submitBtn.disabled = true;

            submitBtn.textContent = '发送中...';



            try {

                await postComment(commentNickname.value.trim(), content);

                commentContent.value = '';

                charCount.textContent = '0';

                await loadComments();

            } catch (e) {

                console.error('Failed to post comment:', e);

                alert('评论发送失败，请重试');

            }



            submitBtn.disabled = false;

            submitBtn.textContent = '发表评论';

        });



        // Initial load

        loadComments();

    });

</script>



<!-- Interaction Section Styles -->

<style>

    .article-interaction-section {

        margin-top: 3rem;

        padding-top: 2rem;

        border-top: 2px solid #e5e7eb;

    }



    .interaction-header {

        text-align: center;

        margin-bottom: 2rem;

    }



    .interaction-header h3 {

        font-size: 1.4rem;

        color: #1f2937;

        margin: 0 0 0.5rem 0;

    }



    .interaction-header p {

        color: #6b7280;

        font-size: 0.95rem;

        margin: 0;

    }



    /* Like Section at Bottom */

    .article-like-section {

        margin-top: 3rem;

        padding: 2rem 0;

        border-top: 2px solid #e5e7eb;

        text-align: center;

    }



    .like-section-inner {

        display: flex;

        flex-direction: column;

        align-items: center;

        gap: 1rem;

    }



    .like-prompt {

        color: #6b7280;

        font-size: 0.95rem;

        margin: 0;

    }



    .article-like-section .like-btn {

        padding: 0.75rem 2rem;

        font-size: 1rem;

    }



    .article-like-section .like-icon {

        width: 22px;

        height: 22px;

    }



    /* Mobile */

    @media (max-width: 768px) {

        .article-like-section {

            margin-top: 2rem;

            padding: 1.5rem 0;

        }



        .like-prompt {

            font-size: 0.9rem;

        }

    }



    /* Comment Section */

    .comment-section {

        margin-top: 2rem;

        padding: 1.5rem;

        background: #f9fafb;

        border-radius: 12px;

    }



    .comment-title {

        font-size: 1.1rem;

        color: #1f2937;

        margin: 0 0 1rem 0;

    }



    .comment-form {

        margin-bottom: 1.5rem;

    }



    .comment-nickname {

        width: 200px;

        padding: 0.5rem 0.75rem;

        border: 1px solid #e5e7eb;

        border-radius: 8px;

        font-size: 0.9rem;

        margin-bottom: 0.75rem;

        background: white;

    }



    .comment-textarea {

        width: 100%;

        padding: 0.75rem;

        border: 1px solid #e5e7eb;

        border-radius: 8px;

        font-size: 0.95rem;

        resize: vertical;

        min-height: 80px;

        background: white;

        font-family: inherit;

        box-sizing: border-box;

        margin-bottom: 0.5rem;

    }



    .comment-nickname:focus,

    .comment-textarea:focus {

        outline: none;

        border-color: #4f46e5;

        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);

    }



    .comment-form-footer {

        display: flex;

        justify-content: space-between;

        align-items: center;

    }



    .char-count {

        font-size: 0.8rem;

        color: #9ca3af;

    }



    .comment-submit-btn {

        padding: 0.6rem 1.5rem;

        background: #4f46e5;

        color: white;

        border: none;

        border-radius: 8px;

        font-size: 0.9rem;

        font-weight: 500;

        cursor: pointer;

        transition: all 0.2s;

    }



    .comment-submit-btn:hover:not(:disabled) {

        background: #4338ca;

        transform: translateY(-1px);

    }



    .comment-submit-btn:disabled {

        opacity: 0.6;

        cursor: not-allowed;

    }



    .comment-list {

        margin-top: 1rem;

    }



    .loading-comments,

    .no-comments {

        text-align: center;

        color: #9ca3af;

        padding: 1.5rem;

        font-size: 0.95rem;

    }



    .comment-item {

        background: white;

        border-radius: 8px;

        padding: 1rem;

        margin-bottom: 0.75rem;

        border: 1px solid #e5e7eb;

    }



    .comment-header {

        display: flex;

        align-items: center;

        gap: 0.75rem;

        margin-bottom: 0.5rem;

    }



    .comment-author {

        font-weight: 600;

        color: #1f2937;

        font-size: 0.9rem;

    }



    .comment-time {

        font-size: 0.8rem;

        color: #9ca3af;

    }



    .comment-delete {

        margin-left: auto;

        background: none;

        border: none;

        color: #ef4444;

        font-size: 0.8rem;

        cursor: pointer;

        padding: 0.2rem 0.5rem;

        border-radius: 4px;

    }



    .comment-delete:hover {

        background: #fef2f2;

    }



    .comment-body {

        color: #374151;

        font-size: 0.95rem;

        line-height: 1.6;

        white-space: pre-wrap;

        word-break: break-word;

    }



    /* Mobile Comment Styles */

    @media (max-width: 768px) {

        .comment-section {

            padding: 1rem;

        }



        .comment-nickname {

            width: 100%;

        }



        .comment-title {

            font-size: 1rem;

        }

    }

</style>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Made with <a href="https://quarto.org/">Quarto</a> | © 2024-2026</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




<script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>