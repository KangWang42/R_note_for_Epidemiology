---
title: 零膨胀模型完全指南
date: '2026-01-16'
description: 零膨胀Poisson和负二项模型处理计数数据中过多零值问题，适用于医疗使用、事故计数等场景。
categories:
- 统计分析方法
- 基础回归
- 回归分析
- 计数数据
image: images/zero-inflated-cover.svg
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    warning = FALSE,
    message = FALSE,
    fig.width = 8,
    fig.height = 5
)
```

## 零膨胀模型简介

当计数数据中零值过多时，标准的Poisson或负二项回归可能拟合不佳。**零膨胀模型**假设数据来自两个过程：一个产生"结构性零"，另一个产生标准计数分布。

### 何时使用零膨胀模型？

| 数据特征 | 可能原因 | 解决方案 |
|----------|---------|---------|
| 零值比例过高 | 两类人群混合 | 零膨胀模型 |
| 非参与者 | "从不"做某事的人 | ZIP/ZINB |
| 测量限制 | 无法检测到低值 | Hurdle模型 |

### 模型类型

- **ZIP**：零膨胀Poisson
- **ZINB**：零膨胀负二项（处理过度离散）
- **Hurdle**：两部分模型（跨越零的障碍）

## 安装与加载

```{r}
library(pscl)
library(MASS)
library(ggplot2)
library(dplyr)

set.seed(42)
theme_set(theme_bw(base_size = 12))
```


## 第一部分：理解零膨胀

### 模拟零膨胀数据

```{r}
# 模拟吸烟数据：部分人从不吸烟，吸烟者服从Poisson
n <- 500
never_smoker <- rbinom(n, 1, 0.4) # 40%从不吸烟
cigarettes <- ifelse(never_smoker == 1, 0, rpois(n, lambda = 5))

# 添加协变量
age <- round(rnorm(n, 40, 10))
male <- rbinom(n, 1, 0.5)

sim_data <- data.frame(cigarettes, age, male, never_smoker)

# 零值比例
cat("零值比例:", mean(cigarettes == 0), "\n")
cat("Poisson期望零值比例:", dpois(0, mean(cigarettes)), "\n")
```

### 可视化零膨胀

```{r}
# 比较观察值与Poisson分布
obs_counts <- table(factor(cigarettes, levels = 0:max(cigarettes)))
pois_expected <- dpois(0:max(cigarettes), lambda = mean(cigarettes)) * n

compare_df <- data.frame(
    count = 0:max(cigarettes),
    observed = as.numeric(obs_counts),
    expected = pois_expected
) %>%
    tidyr::pivot_longer(-count, names_to = "type", values_to = "frequency")

ggplot(compare_df, aes(x = count, y = frequency, fill = type)) +
    geom_col(position = "dodge", alpha = 0.8) +
    scale_fill_manual(
        values = c("#4f46e5", "#dc2626"),
        labels = c("Poisson期望", "观察值")
    ) +
    labs(
        title = "零膨胀数据 vs Poisson分布",
        subtitle = "观察零值远多于Poisson预期",
        x = "计数", y = "频数", fill = ""
    )
```


## 第二部分：标准计数模型

### Poisson回归

```{r}
# 标准Poisson
pois_fit <- glm(cigarettes ~ age + male, data = sim_data, family = poisson)
summary(pois_fit)

# 检查过度离散
cat("\n过度离散检验:\n")
cat("残差偏差:", deviance(pois_fit), "\n")
cat("自由度:", df.residual(pois_fit), "\n")
cat("离散参数估计:", deviance(pois_fit) / df.residual(pois_fit), "\n")
```

### 负二项回归

```{r}
# 负二项回归
nb_fit <- glm.nb(cigarettes ~ age + male, data = sim_data)
summary(nb_fit)
```


## 第三部分：零膨胀Poisson (ZIP)

### 拟合ZIP模型

```{r}
# 零膨胀Poisson
zip_fit <- zeroinfl(cigarettes ~ age + male | 1, data = sim_data)
summary(zip_fit)
```

**模型解读**：
- **Count model**：计数部分（给定不是结构零）
- **Zero-inflation model**：零膨胀部分（是结构零的概率）

### ZIP模型扩展

```{r}
# 零膨胀部分也包含协变量
zip_full <- zeroinfl(cigarettes ~ age + male | age + male, data = sim_data)
summary(zip_full)
```


## 第四部分：零膨胀负二项 (ZINB)

```{r}
# 添加过度离散
sim_data$cigs_od <- ifelse(
    sim_data$never_smoker == 1, 0,
    rnbinom(n, size = 2, mu = 5) # 负二项分布
)

# ZINB模型
zinb_fit <- zeroinfl(cigs_od ~ age + male | 1, data = sim_data, dist = "negbin")
summary(zinb_fit)
```


## 第五部分：Hurdle模型

Hurdle模型将数据分为两部分：零vs非零（二项部分），非零值的大小（截断计数部分）。

```{r}
# Hurdle Poisson
hurdle_fit <- hurdle(cigarettes ~ age + male | age + male, data = sim_data)
summary(hurdle_fit)
```

### ZIP vs Hurdle 区别

| 特点 | ZIP | Hurdle |
|------|-----|--------|
| 零来源 | 结构零 + 采样零 | 仅"跨栏"决定 |
| 非零部分 | 完整分布 | 截断分布 |
| 适用场景 | 两类人群混合 | 参与/不参与决策 |


## 第六部分：模型比较

### AIC/BIC比较

```{r}
models <- list(
    Poisson = pois_fit,
    NegBin = nb_fit,
    ZIP = zip_fit,
    Hurdle = hurdle_fit
)

comparison <- data.frame(
    Model = names(models),
    AIC = sapply(models, AIC),
    BIC = sapply(models, BIC),
    LogLik = sapply(models, logLik)
)

comparison <- comparison[order(comparison$AIC), ]
print(comparison)
```

### Vuong检验

```{r}
# ZIP vs Poisson
vuong_test <- vuong(zip_fit, pois_fit)
print(vuong_test)
```


## 第七部分：实战案例

### 医疗就诊次数

```{r}
# 模拟医疗就诊数据
n <- 1000

# 部分人健康不需就诊，其他人根据健康状况就诊
healthy <- rbinom(n, 1, 0.3)
chronic <- rbinom(n, 1, 0.25)
income <- rnorm(n, 50000, 15000)

# 就诊次数
lambda <- exp(0.5 + 0.8 * chronic - 0.00001 * income)
visits <- ifelse(healthy == 1, 0, rpois(n, lambda))

health_data <- data.frame(visits, chronic, income = income / 1000, healthy)

cat("就诊统计:\n")
cat("零值比例:", mean(visits == 0), "\n")
cat("平均就诊次数:", mean(visits), "\n")
```

```{r}
# 比较模型
pois_health <- glm(visits ~ chronic + income, data = health_data, family = poisson)
zip_health <- zeroinfl(visits ~ chronic + income | 1, data = health_data)
zinb_health <- zeroinfl(visits ~ chronic + income | 1, data = health_data, dist = "negbin")

cat("模型AIC比较:\n")
cat("Poisson:", AIC(pois_health), "\n")
cat("ZIP:", AIC(zip_health), "\n")
cat("ZINB:", AIC(zinb_health), "\n")
```

```{r}
# 最佳模型系数解释
cat("\nZIP模型结果:\n")
summary(zip_health)
```


## 常用代码速查

```{r eval=FALSE}
# ===== 零膨胀模型 =====
library(pscl)

# ZIP
zeroinfl(y ~ x1 + x2 | z1, data = df)

# ZINB
zeroinfl(y ~ x1 + x2 | z1, data = df, dist = "negbin")

# Hurdle
hurdle(y ~ x1 + x2 | z1, data = df)

# ===== 模型比较 =====
AIC(model1, model2)
vuong(zip_model, poisson_model)

# ===== 预测 =====
predict(fit, type = "response") # 期望计数
predict(fit, type = "zero") # 零膨胀概率
```


## 小结

零膨胀模型选择指南：

1. **先检查零值过多**：观察比例 vs Poisson期望
2. **检查过度离散**：偏差/自由度 > 1
3. **选择模型**：
   - 结构零 + 均匀离散 → ZIP
   - 结构零 + 过度离散 → ZINB
   - 参与决策 → Hurdle

> **关键**：理解你的零值来自何处（两类人群？还是跨栏决策？）


## 参考资源

- [pscl包文档](https://cran.r-project.org/package=pscl)
- Zeileis et al. (2008). Regression Models for Count Data in R.
- [UCLA IDRE指南](https://stats.oarc.ucla.edu/r/dae/zip/)
