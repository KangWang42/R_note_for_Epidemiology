---
title: "分布滞后非线性模型 (DLNM)"
date: "2025-01-12"
categories: [R包, 时间序列, 环境流行病学]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    warning = FALSE,
    message = FALSE,
    fig.width = 8,
    fig.height = 6,
    dpi = 150
)
```

## 简介

**分布滞后非线性模型 (Distributed Lag Non-linear Models, DLNM)** 是环境流行病学中用于研究暴露（如温度、空气污染）与健康结局（如死亡、发病）之间复杂关系的经典方法。它可以同时模拟暴露-反应 (Exposure-Response) 的非线性关系和滞后-反应 (Lag-Response) 的非线性关系。

R 语言中的 `dlnm` 包提供了实现这一模型的完整框架。

## 安装

```{r eval=FALSE}
install.packages("dlnm")
```

```{r}
library(dlnm)
library(ggplot2)
```

## 实例数据

我们将使用 `dlnm` 包自带的 `chicagoNMMAPS` 数据集，该数据集包含了 1987-2000 年芝加哥的每日死亡率、天气和污染数据。

```{r}
data(chicagoNMMAPS)
head(chicagoNMMAPS)
```

## 建立交叉基 (Cross-Basis)

DLNM 的核心是建立“交叉基”，它是由暴露维度和滞后维度的基函数组成的张量积。

我们以温度 (`temp`) 对死亡 (`death`) 的影响为例。

1.  **暴露反应关系**: 假设为二次样条 (Quadratic Spline)。
2.  **滞后反应关系**: 假设最大滞后 30 天，也使用自然样条。

```{r}
# 定义交叉基
cb <- crossbasis(
    chicagoNMMAPS$temp,
    lag = 30,
    argvar = list(fun = "ns", knots = quantile(chicagoNMMAPS$temp, c(0.1, 0.75, 0.9))),
    arglag = list(fun = "ns", df = 4)
)

summary(cb)
```

## 模型拟合

将建立好的交叉基 `cb` 放入广义线性模型 (GLM) 中。通常死亡数据服从泊松分布或拟泊松分布。我们需要控制长期趋势、星期几效应等混杂因素。

```{r}
# 建立模型
model <- glm(
    death ~ cb + ns(time, 7 * 14) + dow,
    family = quasipoisson(),
    data = chicagoNMMAPS
)

# ns(time, 7*14) 用于控制长期趋势和季节性，每年约 7 个自由度
```

## 预测与可视化

使用 `crosspred()` 函数进行预测。我们需要指定一个参考值 (cen)，通常选择中位数或最小死亡温度 (MMT)。

```{r}
# 预测
# 设定参考温度为 21 度 (假设的适宜温度)
pred <- crosspred(cb, model, cen = 21, by = 1)
```

### 1. 3D 表面图

展示暴露、滞后和相对风险 (RR) 的整体关系。

```{r}
plot(pred, "3d",
    xlab = "Temperature", ylab = "Lag", zlab = "RR",
    main = "3D Association Surface"
)
```

### 2. 总体累积效应 (Overall Cumulative Effect)

展示考虑了所有滞后天数后的总体暴露-反应关系。

```{r}
plot(pred, "overall",
    xlab = "Temperature", ylab = "RR",
    main = "Overall Cumulative Association"
)
```

### 3. 特定滞后日的效应

查看特定滞后天数（如第 0 天、第 5 天）的暴露-反应曲线。

```{r}
plot(pred, "slices",
    var = 25, ci = "bars", type = "p", col = 2, pch = 19,
    main = "Lag-Response at Temp = 25"
)
```

在上面的代码中，我们也可以画出特定温度的滞后曲线：

```{r}
plot(pred, "slices",
    var = c(-10, 30), lag = 0:30,
    main = "Lag-Response Curves at -10C and 30C"
)
```

## 参考文献

-   Gasparrini, A. (2011). Distributed Lag Linear and Non-Linear Models in R: The Package dlnm. *Journal of Statistical Software*, 43(8), 1-20.
