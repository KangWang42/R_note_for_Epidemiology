---
title: "样本量与功效分析"
date: "2026-01-13"
categories: [R语言方法, 统计设计, 样本量]
image: "images/power-analysis-cover.svg"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    warning = FALSE,
    message = FALSE,
    fig.width = 8,
    fig.height = 5
)
```

## 功效分析简介

**功效分析**用于确定研究所需的样本量，或评估给定样本量下检测效应的能力。

### 核心概念

| 概念 | 符号 | 含义 | 常用值 |
|------|------|------|--------|
| **显著性水平** | α | I类错误概率 | 0.05 |
| **功效** | 1-β | 检测真实效应的概率 | 0.80 |
| **效应量** | d/r/f | 效应大小 | 因检验而异 |
| **样本量** | n | 每组样本数 | 待计算 |

### 四要素关系

知道任意三个，可求第四个：
- **样本量计算**：已知 α, 功效, 效应量 → 求 n
- **功效计算**：已知 α, n, 效应量 → 求功效
- **效应量估计**：已知 α, n, 功效 → 求可检测效应量

## 安装与加载

```{r}
library(pwr)
library(ggplot2)

theme_set(theme_bw(base_size = 12))
```


## 第一部分：t 检验样本量

### 独立样本 t 检验

```{r}
# 双侧检验，中等效应（d=0.5），功效=0.8，α=0.05
pwr.t.test(
    d = 0.5, # Cohen's d
    sig.level = 0.05,
    power = 0.80,
    type = "two.sample"
)
```

**解读**：每组需要 64 人，总共 128 人。

### 配对 t 检验

```{r}
pwr.t.test(
    d = 0.5,
    sig.level = 0.05,
    power = 0.80,
    type = "paired"
)
```

### Cohen's d 参考标准

| 效应大小 | Cohen's d | 含义 |
|---------|-----------|------|
| 小 | 0.2 | 微弱差异 |
| 中 | 0.5 | 中等差异 |
| 大 | 0.8 | 明显差异 |

### 从原始数据估算 d

```{r}
# 根据均值差和标准差估算
mean_diff <- 5 # 预期均值差
pooled_sd <- 10 # 合并标准差
d <- mean_diff / pooled_sd
cat("Cohen's d =", d)
```


## 第二部分：方差分析样本量

### 单因素 ANOVA

```{r}
# k=3组，中等效应（f=0.25）
pwr.anova.test(
    k = 3, # 组数
    f = 0.25, # 效应量
    sig.level = 0.05,
    power = 0.80
)
```

**解读**：每组需要 52 人，总共 156 人。

### 效应量 f 转换

```{r}
# 从 eta-squared 转换
eta_sq <- 0.06 # 中等效应
f <- sqrt(eta_sq / (1 - eta_sq))
cat("f =", round(f, 3))
```

| η² | f | 效应大小 |
|----|---|---------|
| 0.01 | 0.10 | 小 |
| 0.06 | 0.25 | 中 |
| 0.14 | 0.40 | 大 |


## 第三部分：相关分析样本量

```{r}
# 中等相关（r=0.3）
pwr.r.test(
    r = 0.3,
    sig.level = 0.05,
    power = 0.80
)
```

**解读**：需要 84 个样本。

| r | 效应大小 |
|---|---------|
| 0.1 | 小 |
| 0.3 | 中 |
| 0.5 | 大 |


## 第四部分：卡方检验样本量

```{r}
# 2x2 列联表，中等效应
pwr.chisq.test(
    w = 0.3, # 效应量
    df = 1, # 自由度 = (行-1)*(列-1)
    sig.level = 0.05,
    power = 0.80
)
```

| w | 效应大小 |
|---|---------|
| 0.1 | 小 |
| 0.3 | 中 |
| 0.5 | 大 |


## 第五部分：回归分析样本量

```{r}
# 多元回归：5个预测变量，f²=0.15
pwr.f2.test(
    u = 5, # 预测变量数
    f2 = 0.15, # 效应量
    sig.level = 0.05,
    power = 0.80
)
```

**解读**：需要 $v+u+1 = 73+5+1 = 79$ 个样本。

| f² | 效应大小 | R² |
|----|---------|-----|
| 0.02 | 小 | 0.02 |
| 0.15 | 中 | 0.13 |
| 0.35 | 大 | 0.26 |


## 第六部分：可视化功效曲线

### 样本量 vs 功效

```{r}
# 计算不同样本量的功效
sample_sizes <- seq(10, 200, by = 5)
powers <- sapply(sample_sizes, function(n) {
    pwr.t.test(n = n, d = 0.5, sig.level = 0.05)$power
})

# 绑图
power_df <- data.frame(n = sample_sizes, power = powers)

ggplot(power_df, aes(x = n, y = power)) +
    geom_line(color = "#4f46e5", linewidth = 1.2) +
    geom_hline(yintercept = 0.8, linetype = "dashed", color = "red") +
    geom_vline(xintercept = 64, linetype = "dashed", color = "gray50") +
    labs(
        title = "功效曲线（Cohen's d = 0.5）",
        x = "每组样本量",
        y = "统计功效"
    ) +
    scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2)) +
    annotate("text", x = 70, y = 0.75, label = "n = 64", color = "gray30")
```

### 效应量 vs 所需样本

```{r}
effect_sizes <- seq(0.2, 1, by = 0.05)
sample_needed <- sapply(effect_sizes, function(d) {
    pwr.t.test(d = d, sig.level = 0.05, power = 0.80)$n
})

effect_df <- data.frame(d = effect_sizes, n = sample_needed)

ggplot(effect_df, aes(x = d, y = n)) +
    geom_line(color = "#10b981", linewidth = 1.2) +
    labs(
        title = "效应量与所需样本量的关系",
        x = "Cohen's d",
        y = "每组所需样本量"
    )
```


## 第七部分：临床研究案例

### RCT 样本量计算

```{r}
# 假设：对照组治愈率40%，干预组预期60%
# 转换为 Cohen's h
p1 <- 0.40 # 对照组比例
p2 <- 0.60 # 干预组比例
h <- 2 * asin(sqrt(p2)) - 2 * asin(sqrt(p1))

pwr.2p.test(h = h, sig.level = 0.05, power = 0.80)
```

**解读**：每组需要 97 人。

### 考虑脱落率

```{r}
# 预期脱落率 15%
n_calculated <- 97
dropout_rate <- 0.15
n_final <- ceiling(n_calculated / (1 - dropout_rate))
cat("考虑脱落后每组需要:", n_final, "人\n")
cat("总样本量:", n_final * 2, "人")
```


## 常用代码速查

```{r eval=FALSE}
# t 检验
pwr.t.test(d = 0.5, power = 0.8, sig.level = 0.05)

# 配对 t 检验
pwr.t.test(d = 0.5, power = 0.8, type = "paired")

# ANOVA
pwr.anova.test(k = 3, f = 0.25, power = 0.8)

# 相关
pwr.r.test(r = 0.3, power = 0.8)

# 卡方
pwr.chisq.test(w = 0.3, df = 1, power = 0.8)

# 回归
pwr.f2.test(u = 5, f2 = 0.15, power = 0.8)

# 两比例
pwr.2p.test(h = 0.5, power = 0.8)
```


## 小结

样本量计算要点：

1. **明确研究设计**：选择正确的统计方法
2. **预估效应量**：参考文献或预实验
3. **设定功效水平**：通常 80% 或 90%
4. **考虑实际因素**：脱落率、多重比较

> **建议**：宁可略微高估样本量，预留 10-20% 余量。


## 参考资源

- [pwr 包文档](https://cran.r-project.org/web/packages/pwr/)
- [G*Power 软件](https://www.psychologie.hhu.de/arbeitsgruppen/allgemeine-psychologie-und-arbeitspsychologie/gpower)
- Cohen, J. (1988). Statistical Power Analysis for the Behavioral Sciences
