{
  "hash": "bd30fa6f17e8cf858fa458f62374637c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"R语言绘制桑基图详细教程\"\ndate: \"2024-10-20\"\ncategories: [可视化, 桑基图]\nimage: \"figure/sankey-cover.png\"\n---\n\n\n\n> 本期主要介绍常用桑基图（流量图）绘制包ggsankeyfier和相关代码教程\n> \n> 桑基图也叫流量图，主要用来处理多个分类变量的分布情况。可视化展示占比比例等，美观容易\n\n## R包介绍\n\n[CRAN库](https://cran.r-project.org/web/packages/ggsankeyfier/index.html)\n\n[教程手册](https://cran.r-project.org/web/packages/ggsankeyfier/vignettes/decorating.html)\n\n## R包安装\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages(\"ggsankeyfier\")\n```\n:::\n\n\n## R包使用\n\n桑基图本质上就是不同分类变量的流量图，可视化的第一步就是数据整洁化，常用数据宽变长。一列是变量，一列是流量值，在`ggsankeyfier`使用过程中重要的就是用`pivot_stages_longer`来做数据清洗\n\n### 数据准备\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggsankeyfier)\nlibrary(tidyverse)\nlibrary(cowplot)\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\n\n## first get a data set with a wide format:\ndata(ecosystem_services)\ndata <- ecosystem_services\n\n## pivot to long format for plotting:\ndata_neat <-\n  data |>\n  subset(RCSES > 0.005) |>\n  pivot_stages_longer(\n    c(\"activity_realm\", \"biotic_realm\", \"service_section\"),\n    \"RCSES\", \"service_section\"\n  )\n\n# pivot宽变长前\nhead(data, 5)\n## # A tibble: 5 × 8\n##   activity_type          activity_realm pressure_cat   biotic_group biotic_realm\n##   <chr>                  <chr>          <chr>          <chr>        <chr>       \n## 1 Agriculture & Forestry Land-based     Biological di… Zooplankton  Plankton    \n## 2 Agriculture & Forestry Land-based     Biological di… Zooplankton  Plankton    \n## 3 Agriculture & Forestry Land-based     Chemical chan… Zooplankton  Plankton    \n## 4 Agriculture & Forestry Land-based     Chemical chan… Zooplankton  Plankton    \n## 5 Agriculture & Forestry Land-based     Physical chan… Zooplankton  Plankton    \n## # ℹ 3 more variables: service_division <chr>, service_section <chr>,\n## #   RCSES <dbl>\n# 宽变长后\nhead(data_neat, 5)\n## # A tibble: 5 × 6\n##   service_section  RCSES edge_id connector node               stage         \n##   <fct>            <dbl>   <int> <chr>     <fct>              <fct>         \n## 1 Provisioning    0.0123       1 from      Land-based         activity_realm\n## 2 Provisioning    0.0123       1 to        Plant              biotic_realm  \n## 3 Provisioning    0.0133       2 from      Land-based         activity_realm\n## 4 Provisioning    0.0133       2 to        Fish & Cephalopods biotic_realm  \n## 5 Cultural        0.0127       3 from      Land-based         activity_realm\n```\n:::\n\n\n## 总绘图代码\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_neat |>\n  ggplot(\n    mapping = aes(\n      x = stage, y = RCSES,\n      group = node, edge_id = edge_id, connector = connector\n    )\n  ) +\n  geom_sankeyedge(aes(alpha = RCSES, fill = service_section),\n    position = position_sankey(\n      order = \"ascending\", v_space = \"auto\",\n      width = 0.01\n    )\n  ) +\n  geom_sankeynode(aes(fill = node, color = \"grey\"),\n    position = position_sankey(\n      order = \"ascending\", v_space = \"auto\",\n      width = 0.11\n    ),\n    show.legend = FALSE\n  ) +\n  geom_text(\n    data = data_neat,\n    aes(label = node), stat = \"sankeynode\",\n    position = position_sankey(v_space = \"auto\", order = \"ascending\", nudge_x = 0),\n    hjust = 0.5, size = 3.5, fontface = \"bold\", color = \"black\"\n  )+\n  guides(\n    alpha = FALSE,\n    colour = FALSE,\n    fill = guide_legend(position = \"bottom\", nrow = 1)\n  ) +\n  scale_fill_discrete(\n    breaks = unique(data_neat$service_section)[1:3]  # 只在图例中显示前三个键\n  )+\n  theme_minimal_hgrid() +\n  theme( # 去除周围外边距\n    panel.spacing = unit(0, \"cm\"),\n    panel.grid.major.y = element_blank(),\n    axis.text.y = element_blank(),\n    axis.title = element_blank(),\n    legend.key.spacing.x = unit(60, \"pt\")\n  ) \n```\n\n::: {.cell-output-display}\n![](2014-sankey_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n## 绘图代码拆解\n\n接下来我们拆解上边一大段代码，一步步的跑出来就会感觉会好很多。数据的预先准备至关重要，看数据准备部分的代码就行了\n\n### 第一步我们先把sankeyedge做出来，就是中间的流量\n\n看到我们设置了一个至关重要的的参数position：这个参数决定了sankeyedge的位置，我们设置为`position_sankey(order =\"ascending\",v_space=\"auto\",width = 0.01)`，其中order是设置sankeyedge的方向，ascending是从左到右，descending是从右到左，v_space是设置sankeyedge的间距，auto是自动设置，width是设置sankeyedge的宽度。\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_neat |>\n  ggplot(\n    mapping = aes(\n      x = stage, y = RCSES,\n      group = node, edge_id = edge_id, connector = connector, fill = stage\n    )\n  ) +\n  geom_sankeyedge(aes(alpha = RCSES, fill = service_section),\n    position = position_sankey(\n      order = \"ascending\", v_space = \"auto\",\n      width = 0.01\n    )\n  )\n```\n\n::: {.cell-output-display}\n![](2014-sankey_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n### 很好，下一部我们把node给加上，就是各个小方块\n\n设置node的填充色是node，然后边框设置成灰色\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_neat |>\n  ggplot(\n    mapping = aes(\n      x = stage, y = RCSES,\n      group = node, edge_id = edge_id, connector = connector\n    )\n  ) +\n  geom_sankeyedge(aes(alpha = RCSES, fill = service_section),\n    position = position_sankey(\n      order = \"ascending\", v_space = \"auto\",\n      width = 0.01\n    )\n  ) +\n  geom_sankeynode(aes(fill = node, color = \"grey\"),\n    position = position_sankey(\n      order = \"ascending\", v_space = \"auto\",\n      width = 0.1\n    )\n  )\n```\n\n::: {.cell-output-display}\n![](2014-sankey_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n### 然后我们添加文字到图形里\n\n注意添加 `stat = \"sankeynode\"`\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_neat |>\n  ggplot(\n    mapping = aes(\n      x = stage, y = RCSES,\n      group = node, edge_id = edge_id, connector = connector\n    )\n  ) +\n  geom_sankeyedge(aes(alpha = RCSES, fill = service_section),\n    position = position_sankey(\n      order = \"ascending\", v_space = \"auto\",\n      width = 0.01\n    )\n  ) +\n  geom_sankeynode(aes(fill = node, color = \"grey\"),\n    position = position_sankey(\n      order = \"ascending\", v_space = \"auto\",\n      width = 0.1\n    )\n  ) +\n  geom_text(\n    data = data_neat,\n    aes(label = node), stat = \"sankeynode\",\n    position = position_sankey(v_space = \"auto\", order = \"ascending\", nudge_x = 0),\n    hjust = 0.5, size = 3.5, fontface = \"bold\", color = \"black\"\n  )\n```\n\n::: {.cell-output-display}\n![](2014-sankey_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n### 最后阶段我们修改一下图例，改改主题\n\n我们的主要变量是service_section（geom_sankeyedge的fill映射），我们在这里就设置这个作为图例，其它都删掉。这一部分说起来简单，其实挺麻烦的。\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_neat |>\n  ggplot(\n    mapping = aes(\n      x = stage, y = RCSES,\n      group = node, edge_id = edge_id, connector = connector\n    )\n  ) +\n  geom_sankeyedge(aes(alpha = RCSES, fill = service_section),\n    position = position_sankey(\n      order = \"ascending\", v_space = \"auto\",\n      width = 0.01\n    )\n  ) +\n  geom_sankeynode(aes(fill = node, color = \"grey\"),\n    position = position_sankey(\n      order = \"ascending\", v_space = \"auto\",\n      width = 0.11\n    ),\n    show.legend = FALSE\n  ) +\n  geom_text(\n    data = data_neat,\n    aes(label = node), stat = \"sankeynode\",\n    position = position_sankey(v_space = \"auto\", order = \"ascending\", nudge_x = 0),\n    hjust = 0.5, size = 3.5, fontface = \"bold\", color = \"black\"\n  )+\n  guides(\n    alpha = FALSE,\n    colour = FALSE,\n    fill = guide_legend(position = \"bottom\", nrow = 1)\n  ) +\n  scale_fill_discrete(\n    breaks = unique(data_neat$service_section)[1:3]  # 只在图例中显示前三个键\n  )+\n  theme_minimal_hgrid() +\n  theme( # 去除周围外边距\n    panel.spacing = unit(0, \"cm\"),\n    panel.grid.major.y = element_blank(),\n    axis.text.y = element_blank(),\n    axis.title = element_blank(),\n    legend.key.spacing.x = unit(60, \"pt\")\n  ) \n```\n\n::: {.cell-output-display}\n![](2014-sankey_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n",
    "supporting": [
      "2014-sankey_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}