---
title: 加权分位数和回归 (WQS) 完全指南
date: '2026-01-20'
categories:
- 特殊应用
- 环境流行病学
- R包
- 混合暴露
image: images/1106_cover.svg
description: 环境流行病学评估混合暴露效应的核心方法：如何量化多种化学物质同时暴露对健康结局的综合影响。
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    warning = FALSE,
    message = FALSE,
    fig.width = 9,
    fig.height = 7,
    dpi = 300
)
```

## 为什么需要 WQS 回归？

在环境流行病学研究中，人们往往同时暴露于多种化学物质（如重金属、农药、空气污染物等）。传统的回归方法面临两个核心挑战：

1. **多重共线性**：暴露物之间高度相关（例如，吃鱼的人同时暴露于汞和多氯联苯）
2. **多重比较问题**：逐一检验每个暴露物会导致假阳性率膨胀

**WQS (Weighted Quantile Sum) 回归** 是一种专门为解决"混合暴露"问题而设计的统计方法。它将多个暴露物整合为一个加权指数，同时估计：
- 混合暴露的**总体效应**（是否有害/有益）
- 各暴露物的**相对重要性**（通过权重体现）

## WQS 方法原理

WQS 回归的核心思想是构建一个加权指数，将多个暴露物"打包"成一个综合指标。

### 数据预处理：分位数转换

首先，将每个连续暴露变量转换为分位数得分（通常是四分位数，0-3）：

- 第 1 四分位数 → 得分 0
- 第 2 四分位数 → 得分 1
- 第 3 四分位数 → 得分 2
- 第 4 四分位数 → 得分 3

这一步有两个好处：
1. 消除暴露物之间的量纲差异
2. 减少极端值的影响

### WQS 指数构建

WQS 指数的数学形式为：

$$\text{WQS} = \sum_{i=1}^{c} w_i \cdot q_i$$

其中：
- $c$ = 暴露物数量
- $w_i$ = 第 $i$ 个暴露物的权重（$\sum w_i = 1$，且 $w_i \geq 0$）
- $q_i$ = 第 $i$ 个暴露物的分位数得分

### 回归模型

以 logistic 回归为例，模型形式为：

$$\text{logit}(P(Y=1)) = \beta_0 + \beta_1 \cdot \text{WQS} + \boldsymbol{\gamma}^T \mathbf{Z}$$

其中：
- $\beta_1$ = WQS 指数的效应系数（核心关注参数）
- $\mathbf{Z}$ = 协变量向量（年龄、性别等）
- $\boldsymbol{\gamma}$ = 协变量系数向量

### 方向约束

WQS 方法的关键假设是**所有暴露物与结局的关联方向一致**。因此，在拟合模型前需要指定：

- **正向约束**（`b1_pos = TRUE`）：假设暴露物与结局正相关（增加风险）
- **负向约束**（`b1_pos = FALSE`）：假设暴露物与结局负相关（保护效应）

如果不确定方向，可以先运行探索性分析，或使用双向 WQS（分别运行正向和负向模型）。

### Bootstrap 验证

权重的估计采用 Bootstrap 方法：
1. 将数据随机分为训练集（40%）和验证集（60%）
2. 在训练集上估计权重
3. 在验证集上估计 $\beta_1$
4. 重复多次（通常 100-1000 次），取权重的平均值

## 安装与加载

```{r eval=FALSE}
install.packages("gWQS")
```

```{r}
library(gWQS)
library(ggplot2)
library(dplyr)
```

## 数据准备与探索

`gWQS` 包内置了 `wqs_data` 数据集，包含来自 NHANES 的混合暴露数据。

```{r}
data("wqs_data")

# 查看数据结构
dim(wqs_data)
names(wqs_data)[1:20]  # 显示前20个变量名
```

数据包含：
- `y`、`ybin`：结局变量（连续/二分类）
- `sex`：性别协变量
- 多个以 `LBX` 开头的 PCB 暴露物变量
- 多个以 `URX` 开头的尿液生物标志物

```{r}
# 提取 PCB 相关暴露物变量名（以 LBX 开头，排除汇总变量）
mix_vars <- names(wqs_data)[grepl("^LBX[0-9]", names(wqs_data))]
print(mix_vars)
```

### 暴露物相关性分析

检查暴露物之间的相关性是 WQS 分析的重要前期步骤：

```{r}
# 计算相关矩阵
cor_matrix <- cor(wqs_data[, mix_vars], use = "complete.obs")

# 可视化相关矩阵
library(corrplot)
corrplot(cor_matrix, 
         method = "color", 
         type = "upper",
         tl.cex = 0.6,
         title = "PCB 暴露物相关性矩阵",
         mar = c(0, 0, 1, 0))
```

从相关性图可以看出，这些 PCB 暴露物之间存在中等到高度的相关性，这正是 WQS 方法的适用场景。

## 基础 WQS 模型拟合

### 正向约束模型

假设我们预期这些暴露物会增加疾病风险：

```{r}
set.seed(42)

# 拟合 WQS 模型（正向约束，使用二分类结局 ybin）
wqs_pos <- gwqs(
    ybin ~ wqs,                     # 模型公式，使用 ybin 作为结局
    mix_name = mix_vars,            # 暴露物变量名向量
    data = wqs_data,                # 数据集
    q = 4,                          # 分位数数量（四分位数）
    validation = 0.6,               # 验证集比例
    b = 100,                        # Bootstrap 次数
    b1_pos = TRUE,                  # 正向约束
    b1_constr = TRUE,               # 强制约束
    family = "binomial",            # 结局类型（二分类）
    seed = 42                       # 随机种子
)

# 模型摘要
summary(wqs_pos)
```

### 结果解读

模型输出包含几个关键信息：

1. **WQS 指数效应**：$\beta_1$ 的估计值及其显著性
   - 如果显著，说明混合暴露整体与结局有关
   - OR = exp($\beta_1$) 表示 WQS 指数每增加 1 个单位的风险变化

2. **权重估计**：每个暴露物对 WQS 指数的贡献
   - 权重之和为 1
   - 权重越高，该暴露物在混合效应中的相对重要性越大

```{r}
# 提取权重
weights_df <- wqs_pos$final_weights
print(weights_df)
```

## 结果可视化

### 权重柱状图

权重图是 WQS 分析最重要的可视化输出：

```{r}
# 使用 gWQS 内置绑图函数
gwqs_barplot(wqs_pos) +
    labs(
        title = "WQS 模型权重分布",
        subtitle = "各暴露物对混合效应的相对贡献",
        x = "暴露物",
        y = "权重"
    ) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

**解读**：
- 权重最高的暴露物对混合效应贡献最大
- 通常关注权重 > 1/c（均等权重阈值）的暴露物
- 本例中 c = `r length(mix_vars)`，均等权重 = `r round(1/length(mix_vars), 3)`

### 权重散点图（显示不确定性）

展示 Bootstrap 过程中权重的变异：

```{r}
gwqs_scatterplot(wqs_pos) +
    labs(
        title = "WQS 权重散点图",
        subtitle = "Bootstrap 重复中的权重分布"
    ) +
    theme_minimal()
```

## 调整协变量

在实际研究中，通常需要调整混杂因素：

```{r}
set.seed(42)

# 调整性别（wqs_data 中只有 sex 变量）
wqs_adj <- gwqs(
    ybin ~ wqs + sex,               # 添加协变量
    mix_name = mix_vars,
    data = wqs_data,
    q = 4,
    validation = 0.6,
    b = 100,
    b1_pos = TRUE,
    b1_constr = TRUE,
    family = "binomial",
    seed = 42
)

summary(wqs_adj)
```

## 模型诊断与敏感性分析

### 双向 WQS 分析

当暴露物可能同时存在有害和保护效应时，可以同时运行正向和负向模型：

```{r}
# 负向约束模型
set.seed(42)
wqs_neg <- gwqs(
    ybin ~ wqs,
    mix_name = mix_vars,
    data = wqs_data,
    q = 4,
    validation = 0.6,
    b = 100,
    b1_pos = FALSE,                 # 负向约束
    b1_constr = TRUE,
    family = "binomial",
    seed = 42
)

# 比较两个模型
cat("正向模型 WQS 效应:", coef(wqs_pos$fit)["wqs"], "\n")
cat("负向模型 WQS 效应:", coef(wqs_neg$fit)["wqs"], "\n")
```

### 分位数敏感性分析

检验结果对分位数划分的稳健性：

```{r}
# 使用十分位数
set.seed(42)
wqs_q10 <- gwqs(
    ybin ~ wqs,
    mix_name = mix_vars,
    data = wqs_data,
    q = 10,                         # 十分位数
    validation = 0.6,
    b = 100,
    b1_pos = TRUE,
    b1_constr = TRUE,
    family = "binomial",
    seed = 42
)

cat("四分位数模型效应:", coef(wqs_pos$fit)["wqs"], "\n")
cat("十分位数模型效应:", coef(wqs_q10$fit)["wqs"], "\n")
```

### Bootstrap 次数敏感性

增加 Bootstrap 次数可以获得更稳定的权重估计：

```{r eval=FALSE}
# 生产环境建议使用更多 Bootstrap 次数
wqs_b500 <- gwqs(
    ybin ~ wqs,
    mix_name = mix_vars,
    data = wqs_data,
    q = 4,
    validation = 0.6,
    b = 500,                        # 增加到 500 次
    b1_pos = TRUE,
    b1_constr = TRUE,
    family = "binomial",
    seed = 42
)
```

## 连续型结局的 WQS 模型

WQS 不仅适用于二分类结局，也适用于连续型结局。使用 `wqs_data` 中的连续型结局变量 `yLBX`：

```{r}
# 拟合线性 WQS 模型（使用连续结局 yLBX）
set.seed(42)
wqs_linear <- gwqs(
    yLBX ~ wqs + sex,
    mix_name = mix_vars,
    data = wqs_data,
    q = 4,
    validation = 0.6,
    b = 100,
    b1_pos = TRUE,
    b1_constr = TRUE,
    family = "gaussian",            # 连续型结局
    seed = 42
)

summary(wqs_linear)
```

## WQS 的扩展方法

### 重复交叉验证 WQS

为了减少数据分割的随机性影响，可以使用重复交叉验证：

```{r}
set.seed(42)

# 使用重复交叉验证
wqs_cv <- gwqs(
    ybin ~ wqs,
    mix_name = mix_vars,
    data = wqs_data,
    q = 4,
    validation = 0.6,
    b = 100,
    b1_pos = TRUE,
    b1_constr = TRUE,
    family = "binomial",
    rh = 5,                         # 重复次数
    seed = 42
)

summary(wqs_cv)
```

### 分层 WQS 分析

检验效应是否在亚组间存在差异。分层分析需要确保每个亚组有足够的样本量：

```{r}
# 检查各性别组的样本量
table(wqs_data$sex)

# 按性别分层（仅示例代码，实际使用需确保样本量充足）
# 男性 (sex = 0)
male_data <- wqs_data[wqs_data$sex == 0, ]
if(nrow(male_data) >= 100) {
    wqs_male <- gwqs(
        ybin ~ wqs,
        mix_name = mix_vars,
        data = male_data,
        q = 4,
        validation = 0.6,
        b = 50,                     # 减少 bootstrap 次数加快运行
        b1_pos = TRUE,
        b1_constr = TRUE,
        family = "binomial",
        seed = 42
    )
    cat("男性 WQS 效应:", coef(wqs_male$fit)["wqs"], "\n")
} else {
    cat("男性样本量不足，无法进行分层分析\n")
}

# 女性 (sex = 1)
female_data <- wqs_data[wqs_data$sex == 1, ]
if(nrow(female_data) >= 100) {
    wqs_female <- gwqs(
        ybin ~ wqs,
        mix_name = mix_vars,
        data = female_data,
        q = 4,
        validation = 0.6,
        b = 50,
        b1_pos = TRUE,
        b1_constr = TRUE,
        family = "binomial",
        seed = 42
    )
    cat("女性 WQS 效应:", coef(wqs_female$fit)["wqs"], "\n")
} else {
    cat("女性样本量不足，无法进行分层分析\n")
}
```

## 结果报告示例

在论文中报告 WQS 结果时，应包含以下信息：

### 方法描述

> 我们使用加权分位数和（WQS）回归评估 `r length(mix_vars)` 种 PCB 暴露物的混合效应与疾病风险的关联。每种暴露物被转换为四分位数得分（0-3），然后通过 Bootstrap 方法（B=100）估计权重和效应参数。训练集占 40%，验证集占 60%。采用正向约束假设混合暴露增加疾病风险。

### 结果描述

```{r echo=FALSE}
wqs_coef <- coef(wqs_pos$fit)["wqs"]
wqs_or <- exp(wqs_coef)
wqs_ci <- confint(wqs_pos$fit)["wqs", ]
wqs_or_ci <- exp(wqs_ci)
```

> WQS 指数与疾病风险显著正相关（OR = `r round(wqs_or, 2)`，95% CI: `r round(wqs_or_ci[1], 2)` - `r round(wqs_or_ci[2], 2)`）。在混合暴露中，贡献最大的暴露物包括 `r paste(head(weights_df$mix_name[order(-weights_df$mean_weight)], 3), collapse = "、")`，其权重分别为 `r paste(round(head(weights_df$mean_weight[order(-weights_df$mean_weight)], 3), 3), collapse = "、")`。

## 与其他方法的比较

| 方法 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| **WQS** | 处理共线性、单一指数易解释 | 假设方向一致、无法检测非线性 | 暴露物同向效应 |
| **BKMR** | 允许非线性、可检测交互 | 计算密集、解释复杂 | 探索性分析 |
| **qgcomp** | 双向效应、分位数 g-computation | 需要足够样本量 | 存在双向效应 |
| **Lasso** | 变量选择 | 不保证权重为正 | 高维数据筛选 |

## 常见问题与解决方案

### 权重全为 0 或 1

**原因**：数据变异不足或样本量过小

**解决**：
- 增加 Bootstrap 次数
- 检查数据质量
- 考虑合并相似暴露物

### 正负模型效应不一致

**原因**：暴露物可能存在双向效应

**解决**：
- 使用 `qgcomp` 包进行双向分析
- 根据先验知识分组建模

### 权重不稳定

**原因**：Bootstrap 次数不足

**解决**：
- 增加 B 值（建议 ≥ 500）
- 报告权重的置信区间

## 参考文献

- Carrico, C., et al. (2015). Characterization of Weighted Quantile Sum Regression for Highly Correlated Data in a Risk Analysis Setting. *Journal of Agricultural, Biological, and Environmental Statistics*.
- Czarnota, J., et al. (2015). Assessment of Weighted Quantile Sum Regression for Modeling Chemical Mixtures and Cancer Risk. *Cancer Informatics*.
- Renzetti, S., et al. (2021). gWQS: An R Package for Linear and Generalized Weighted Quantile Sum (WQS) Regression. *R package version 3.0.4*.
