{
  "hash": "3574e331a6627736d99492871996b8e9",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"时间序列分析\"\ndate: \"2025-01-10\"\ncategories: [R语言方法, 时间序列, 预测]\nimage: \"figure/timeseries-cover.png\"\n---\n\n\n\n时间序列分析是研究按时间顺序排列的数据规律的方法，广泛应用于经济预测、气象分析、销售预估等领域。\n\n## 基础概念\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(forecast) # 时间序列预测核心包\nlibrary(ggplot2)\nlibrary(patchwork)\n\n# 使用经典航空乘客数据\ndata <- AirPassengers # 1949-1960年月度乘客数（千人）\ndata\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec\n1949 112 118 132 129 121 135 148 148 136 119 104 118\n1950 115 126 141 135 125 149 170 170 158 133 114 140\n1951 145 150 178 163 172 178 199 199 184 162 146 166\n1952 171 180 193 181 183 218 230 242 209 191 172 194\n1953 196 196 236 235 229 243 264 272 237 211 180 201\n1954 204 188 235 227 234 264 302 293 259 229 203 229\n1955 242 233 267 269 270 315 364 347 312 274 237 278\n1956 284 277 317 313 318 374 413 405 355 306 271 306\n1957 315 301 356 348 355 422 465 467 404 347 305 336\n1958 340 318 362 348 363 435 491 505 404 359 310 337\n1959 360 342 406 396 420 472 548 559 463 407 362 405\n1960 417 391 419 461 472 535 622 606 508 461 390 432\n```\n\n\n:::\n:::\n\n\n时间序列的三个核心成分：\n\n- **趋势 (Trend)**：长期上升或下降的模式\n- **季节性 (Seasonality)**：固定周期的重复波动\n- **残差 (Residual)**：去除趋势和季节性后的随机成分\n\n## 时序分解\n\n将时间序列分解为趋势、季节和残差三部分：\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# STL分解：更灵活的现代方法\nstl(data, s.window = \"periodic\") |>\n  autoplot() +\n  theme_minimal() +\n  labs(title = \"航空乘客数据的STL分解\")\n```\n\n::: {.cell-output-display}\n![](1017-timeseries_files/figure-html/unnamed-chunk-2-1.png){width=100%}\n:::\n:::\n\n\n:::{.callout-tip}\n**分解类型选择**：\n\n- 加法模型：$Y = T + S + R$（波动幅度稳定）\n- 乘法模型：$Y = T \\times S \\times R$（波动随趋势增大，如本例）\n:::\n\n## 平稳性检验\n\nARIMA模型要求序列平稳。使用ADF检验判断：\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tseries)\n\n# 原始序列：非平稳\nadf.test(data) # p > 0.05 → 非平稳\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tAugmented Dickey-Fuller Test\n\ndata:  data\nDickey-Fuller = -7.3186, Lag order = 5, p-value = 0.01\nalternative hypothesis: stationary\n```\n\n\n:::\n\n```{.r .cell-code}\n# 一阶差分后：平稳\nadf.test(diff(data)) # p < 0.05 → 平稳\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tAugmented Dickey-Fuller Test\n\ndata:  diff(data)\nDickey-Fuller = -7.0177, Lag order = 5, p-value = 0.01\nalternative hypothesis: stationary\n```\n\n\n:::\n:::\n\n\n差分可消除趋势，使序列平稳：\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 对比原始与差分后的序列\np1 <- autoplot(data) + labs(title = \"原始序列\", y = \"乘客数\")\np2 <- autoplot(diff(data)) + labs(title = \"一阶差分后\", y = \"差分值\")\np1 / p2 & theme_minimal()\n```\n\n::: {.cell-output-display}\n![](1017-timeseries_files/figure-html/unnamed-chunk-4-1.png){width=100%}\n:::\n:::\n\n\n## ARIMA模型\n\nARIMA(p,d,q) 是最常用的时间序列模型：\n\n- **p**：自回归阶数（AR）\n- **d**：差分次数\n- **q**：移动平均阶数（MA）\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 自动选择最优参数（基于AIC准则）\nfit <- auto.arima(data)\nfit\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSeries: data \nARIMA(2,1,1)(0,1,0)[12] \n\nCoefficients:\n         ar1     ar2      ma1\n      0.5960  0.2143  -0.9819\ns.e.  0.0888  0.0880   0.0292\n\nsigma^2 = 132.3:  log likelihood = -504.92\nAIC=1017.85   AICc=1018.17   BIC=1029.35\n```\n\n\n:::\n:::\n\n\n### 模型诊断\n\n检查残差是否为白噪声：\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncheckresiduals(fit) # 残差应无自相关、近似正态\n```\n\n::: {.cell-output-display}\n![](1017-timeseries_files/figure-html/unnamed-chunk-6-1.png){width=100%}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tLjung-Box test\n\ndata:  Residuals from ARIMA(2,1,1)(0,1,0)[12]\nQ* = 37.784, df = 21, p-value = 0.01366\n\nModel df: 3.   Total lags used: 24\n```\n\n\n:::\n:::\n\n\n## 预测\n\n使用拟合模型进行未来预测：\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 预测未来2年（24个月）\nfc <- forecast(fit, h = 24)\n\n# 可视化：蓝色区域为置信区间\nautoplot(fc) +\n  theme_minimal() +\n  labs(\n    title = \"航空乘客数预测\",\n    subtitle = \"ARIMA模型 + 80%/95%置信区间\",\n    x = \"年份\", y = \"乘客数（千人）\"\n  )\n```\n\n::: {.cell-output-display}\n![](1017-timeseries_files/figure-html/unnamed-chunk-7-1.png){width=100%}\n:::\n:::\n\n\n## 季节性ARIMA\n\n对于有明显季节模式的数据，使用SARIMA：\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 强制使用季节性模型\nfit_seasonal <- auto.arima(data, seasonal = TRUE, D = 1)\nfit_seasonal\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSeries: data \nARIMA(2,1,1)(0,1,0)[12] \n\nCoefficients:\n         ar1     ar2      ma1\n      0.5960  0.2143  -0.9819\ns.e.  0.0888  0.0880   0.0292\n\nsigma^2 = 132.3:  log likelihood = -504.92\nAIC=1017.85   AICc=1018.17   BIC=1029.35\n```\n\n\n:::\n\n```{.r .cell-code}\n# 预测并对比\nforecast(fit_seasonal, h = 24) |>\n  autoplot() +\n  theme_minimal() +\n  labs(title = \"季节性ARIMA预测\")\n```\n\n::: {.cell-output-display}\n![](1017-timeseries_files/figure-html/unnamed-chunk-8-1.png){width=100%}\n:::\n:::\n\n\n## 指数平滑法\n\n另一类常用方法，适合短期预测：\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ETS自动选择最优平滑参数\nets_fit <- ets(data)\nets_fit # M,A,M = 乘法误差、加法趋势、乘法季节\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nETS(M,Ad,M) \n\nCall:\nets(y = data)\n\n  Smoothing parameters:\n    alpha = 0.7096 \n    beta  = 0.0204 \n    gamma = 1e-04 \n    phi   = 0.98 \n\n  Initial states:\n    l = 120.9939 \n    b = 1.7705 \n    s = 0.8944 0.7993 0.9217 1.0592 1.2203 1.2318\n           1.1105 0.9786 0.9804 1.011 0.8869 0.9059\n\n  sigma:  0.0392\n\n     AIC     AICc      BIC \n1395.166 1400.638 1448.623 \n```\n\n\n:::\n\n```{.r .cell-code}\n# 预测\nforecast(ets_fit, h = 24) |>\n  autoplot() +\n  theme_minimal() +\n  labs(title = \"指数平滑预测 (ETS)\")\n```\n\n::: {.cell-output-display}\n![](1017-timeseries_files/figure-html/unnamed-chunk-9-1.png){width=100%}\n:::\n:::\n\n\n## 模型对比\n\n使用交叉验证比较预测准确性：\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 取最后2年作为测试集\ntrain <- window(data, end = c(1958, 12))\ntest <- window(data, start = c(1959, 1))\n\n# 训练两个模型\nm1 <- auto.arima(train)\nm2 <- ets(train)\n\n# 预测并计算误差\nfc1 <- forecast(m1, h = 24)\nfc2 <- forecast(m2, h = 24)\n\n# 准确率指标\naccuracy(fc1, test)[2, c(\"RMSE\", \"MAE\", \"MAPE\")]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    RMSE      MAE     MAPE \n74.25224 68.57729 14.92756 \n```\n\n\n:::\n\n```{.r .cell-code}\naccuracy(fc2, test)[2, c(\"RMSE\", \"MAE\", \"MAPE\")]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    RMSE      MAE     MAPE \n72.54791 63.21297 13.30345 \n```\n\n\n:::\n:::\n\n\n:::{.callout-note}\n**常用评估指标**：\n\n- **RMSE**：均方根误差（对大误差敏感）\n- **MAE**：平均绝对误差\n- **MAPE**：平均绝对百分比误差（可解释性好）\n:::\n\n## 实战：预测月度销售\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 模拟零售数据\nset.seed(42)\nsales <- ts(\n  100 + 1:60 * 2 + # 上升趋势\n    30 * sin(2 * pi * 1:60 / 12) + # 季节性\n    rnorm(60, sd = 10), # 噪声\n  start = c(2020, 1), frequency = 12\n)\n\n# 一行完成：建模 + 预测 + 可视化\nsales |>\n  auto.arima() |>\n  forecast(h = 12) |>\n  autoplot() +\n  theme_minimal() +\n  labs(title = \"月度销售额预测\", x = \"年份\", y = \"销售额\")\n```\n\n::: {.cell-output-display}\n![](1017-timeseries_files/figure-html/unnamed-chunk-11-1.png){width=100%}\n:::\n:::\n\n\n## 总结\n\n| 方法 | 适用场景 | 函数 |\n|------|----------|------|\n| STL分解 | 理解数据结构 | `stl()` |\n| ARIMA | 通用预测 | `auto.arima()` |\n| SARIMA | 强季节性数据 | `auto.arima(seasonal=TRUE)` |\n| ETS | 短期预测、平滑 | `ets()` |\n\n:::{.callout-tip}\n**实践建议**：\n\n1. 先可视化，理解数据特征\n2. 检验平稳性，必要时差分\n3. 对比多个模型，选择最优\n4. 关注置信区间，预测有不确定性\n:::\n",
    "supporting": [
      "1017-timeseries_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}