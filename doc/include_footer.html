<!-- Back to Top Button -->
<button id="back-to-top" aria-label="Back to Top">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M18 15l-6-6-6 6" />
    </svg>
</button>

<!-- Floating TOC Button (Mobile Only) -->
<button id="toc-floating-btn" aria-label="Table of Contents">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="8" y1="6" x2="21" y2="6"></line>
        <line x1="8" y1="12" x2="21" y2="12"></line>
        <line x1="8" y1="18" x2="21" y2="18"></line>
        <line x1="3" y1="6" x2="3.01" y2="6"></line>
        <line x1="3" y1="12" x2="3.01" y2="12"></line>
        <line x1="3" y1="18" x2="3.01" y2="18"></line>
    </svg>
</button>

<!-- TOC Modal -->
<div class="toc-modal-overlay">
    <div class="toc-modal-content">
        <div class="toc-modal-header">
            <div class="toc-modal-title">ç›®å½•</div>
            <button class="toc-modal-close" aria-label="Close">&times;</button>
        </div>
        <div class="toc-modal-body" id="toc-modal-body">
            <!-- TOC content will be injected here -->
        </div>
    </div>
</div>

<script>
    // Back to Top Logic
    const backToTopBtn = document.getElementById('back-to-top');

    window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
            backToTopBtn.classList.add('visible');
        } else {
            backToTopBtn.classList.remove('visible');
        }
    });

    backToTopBtn.addEventListener('click', () => {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });

    // Mobile Table Scrolling Logic
    document.addEventListener("DOMContentLoaded", function () {
        const tables = document.querySelectorAll('table');
        tables.forEach(table => {
            if (!table.parentElement.classList.contains('table-responsive')) {
                const wrapper = document.createElement('div');
                wrapper.className = 'table-responsive';
                wrapper.style.overflowX = 'auto'; // Force scroll
                table.parentNode.insertBefore(wrapper, table);
                wrapper.appendChild(table);
            }
        });

        // Floating TOC Logic
        const tocBtn = document.getElementById('toc-floating-btn');
        const tocOverlay = document.querySelector('.toc-modal-overlay');
        const tocClose = document.querySelector('.toc-modal-close');
        const tocBody = document.getElementById('toc-modal-body');
        const originalToc = document.getElementById('TOC');

        if (originalToc && tocBtn) {
            // Check if TOC has content
            const tocLinks = originalToc.querySelectorAll('a');
            if (tocLinks.length > 0) {
                tocBtn.style.display = 'flex';

                // Function to populate modal
                const populateToc = () => {
                    tocBody.innerHTML = '';
                    const tocClone = originalToc.querySelector('ul').cloneNode(true);
                    tocBody.appendChild(tocClone);

                    // Add click listeners to close modal on link click
                    tocBody.querySelectorAll('a').forEach(link => {
                        link.addEventListener('click', () => {
                            tocOverlay.classList.remove('active');
                            // Smooth scroll to target (handled by browser usually, but ensure modal closes first)
                        });
                    });
                };

                tocBtn.addEventListener('click', () => {
                    populateToc();
                    tocOverlay.classList.add('active');
                });

                tocClose.addEventListener('click', () => {
                    tocOverlay.classList.remove('active');
                });

                tocOverlay.addEventListener('click', (e) => {
                    if (e.target === tocOverlay) {
                        tocOverlay.classList.remove('active');
                    }
                });
            } else {
                tocBtn.style.display = 'none';
            }
        } else if (tocBtn) {
            tocBtn.style.display = 'none';
        }

        // Article Footer Random Recommendation
        // Only run on article pages (has sidebar and main content)
        const sidebar = document.querySelector('#quarto-sidebar') || document.querySelector('.sidebar');
        const mainContent = document.querySelector('main');

        if (sidebar && mainContent) {
            const links = Array.from(sidebar.querySelectorAll('a.sidebar-item-text'));

            // If no links found with specific class, try generic anchor in sidebar
            const allLinks = links.length > 0 ? links : Array.from(sidebar.querySelectorAll('a'));

            // Filter out section headers if they are just toggles (usually href is # or empty)
            const validLinks = allLinks.filter(a => a.href && !a.href.endsWith('#') && !a.href.includes('javascript:'));

            // Article Footer Navigation (Prev/Next + Random)
            const currentUrl = window.location.href.split('#')[0];
            let currentIndex = -1;

            // Find current article index
            for (let i = 0; i < validLinks.length; i++) {
                if (validLinks[i].href.split('#')[0] === currentUrl) {
                    currentIndex = i;
                    break;
                }
            }

            // Create Container
            const footerNav = document.createElement('div');
            footerNav.className = 'article-footer-nav-container';
            footerNav.style.marginTop = '4rem';
            footerNav.style.paddingTop = '2rem';
            footerNav.style.borderTop = '1px solid #e5e7eb';

            // 1. Prev/Next Navigation
            if (currentIndex !== -1) {
                let navHtml = '<div class="article-footer-nav">';

                // Previous
                if (currentIndex > 0) {
                    const prevLink = validLinks[currentIndex - 1];
                    const prevTitle = prevLink.innerText.trim();
                    navHtml += `
                        <a href="${prevLink.href}" class="article-nav-link">
                            <span class="nav-label">ä¸Šä¸€ç¯‡</span>
                            <span class="nav-title">Â« ${prevTitle}</span>
                        </a>
                    `;
                } else {
                    navHtml += `<div></div>`;
                }

                // Next
                if (currentIndex < validLinks.length - 1) {
                    const nextLink = validLinks[currentIndex + 1];
                    const nextTitle = nextLink.innerText.trim();
                    navHtml += `
                        <a href="${nextLink.href}" class="article-nav-link" style="text-align: right;">
                            <span class="nav-label">ä¸‹ä¸€ç¯‡</span>
                            <span class="nav-title">${nextTitle} Â»</span>
                        </a>
                    `;
                } else {
                    navHtml += `<div></div>`;
                }

                navHtml += '</div>';

                // Append Prev/Next HTML
                const navDiv = document.createElement('div');
                navDiv.innerHTML = navHtml;
                footerNav.appendChild(navDiv);
            }

            // 2. Random Recommendation
            const otherLinks = validLinks.filter((_, idx) => idx !== currentIndex);
            if (otherLinks.length > 0) {
                const randomIdx = Math.floor(Math.random() * otherLinks.length);
                const randomLink = otherLinks[randomIdx];
                const randomTitle = randomLink.innerText.trim(); // Use innerText for title

                if (randomTitle) {
                    const randomDiv = document.createElement('div');
                    randomDiv.innerHTML = `
                        <div class="random-recommendation">
                            <h4>ğŸ‘‹ éšä¾¿çœ‹çœ‹</h4>
                            <p>æ¢ç´¢æ›´å¤š R è¯­è¨€ç²¾å½©å†…å®¹</p>
                            <a href="${randomLink.href}" class="random-btn">
                                ğŸ² ${randomTitle}
                            </a>
                        </div>
                    `;
                    footerNav.appendChild(randomDiv);
                }
            }

            mainContent.appendChild(footerNav);
        }
    });
</script>