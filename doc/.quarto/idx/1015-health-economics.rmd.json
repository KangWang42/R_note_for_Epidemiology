{"title":"R语言卫生经济学分析","markdown":{"yaml":{"title":"R语言卫生经济学分析","date":"2026-01-10","categories":["R语言方法","卫生经济学","成本效果分析"],"image":"figure/health-economics-cover.png"},"headingText":"什么是卫生经济学评价","containsRefs":false,"markdown":"\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(\n  echo = TRUE,\n  warning = FALSE,\n  message = FALSE,\n  fig.width = 8,\n  fig.height = 5,\n  fig.retina = 2,\n  out.width = \"100%\",\n  dpi = 150\n)\n```\n\n\n卫生经济学评价（Health Economic Evaluation）是一种系统性比较不同医疗干预措施的**成本**和**健康结果**的分析方法，帮助决策者在有限资源下做出最优选择。\n\n### 主要评价方法\n\n| 方法 | 英文缩写 | 结果指标 | 适用场景 |\n|------|----------|----------|----------|\n| 成本效果分析 | CEA | 自然单位（如生命年） | 单一疾病比较 |\n| 成本效用分析 | CUA | 质量调整生命年（QALY） | 跨疾病比较 |\n| 成本效益分析 | CBA | 货币单位 | 健康与非健康项目比较 |\n| 成本最小化分析 | CMA | 无（假设效果相同） | 效果相同的干预比较 |\n\n### 核心概念\n\n- **ICER**（增量成本效果比）：每多获得一个健康单位所需的额外成本\n- **QALY**（质量调整生命年）：综合考虑生存时间和生活质量\n- **WTP**（支付意愿）：社会愿意为一个 QALY 支付的最高金额\n- **贴现率**：将未来成本/效果折算为现值的比率（通常 3-5%）\n\n---\n\n## R包介绍\n\n卫生经济学分析常用的 R 包：\n\n| R包 | 功能 | 链接 |\n|-----|------|------|\n| `hesim` | 健康状态转换模型、决策分析 | [CRAN](https://cran.r-project.org/package=hesim) |\n| `heemod` | 马尔可夫模型构建 | [CRAN](https://cran.r-project.org/package=heemod) |\n| `BCEA` | 贝叶斯成本效果分析 | [CRAN](https://cran.r-project.org/package=BCEA) |\n| `dampack` | 决策分析模型参数化 | [CRAN](https://cran.r-project.org/package=dampack) |\n| `survHE` | 生存分析外推 | [CRAN](https://cran.r-project.org/package=survHE) |\n\n本教程使用基础 R 和 `ggplot2` 从零实现卫生经济学核心分析，无需安装专业包。\n\n## R包安装\n\n```{r eval=FALSE}\n# 安装核心包\ninstall.packages(\"ggplot2\")\ninstall.packages(\"dplyr\")\ninstall.packages(\"scales\")\n```\n\n```{r}\nlibrary(ggplot2)\nlibrary(dplyr)\nlibrary(scales)\n```\n\n---\n\n## 成本效果分析基础\n\n### 模拟数据准备\n\n假设我们比较三种治疗方案：标准治疗、新药 A、新药 B。\n\n```{r}\n# 创建策略数据\nstrategies <- c(\"标准治疗\", \"新药A\", \"新药B\")\n\n# 成本数据（单位：元）\ncosts <- c(50000, 80000, 120000)\n\n# 效果数据（QALY）\nqalys <- c(5.2, 6.8, 7.5)\n\n# 创建数据框\ncea_data <- data.frame(\n  Strategy = strategies,\n  Cost = costs,\n  QALY = qalys\n)\n\ncea_data\n```\n\n### 成本效果平面图\n\n成本效果平面图是卫生经济学最基础的可视化，横轴为效果（QALY），纵轴为成本。\n\n```{r}\n# 基础成本效果平面图\nggplot(cea_data, aes(x = QALY, y = Cost, color = Strategy)) +\n  geom_point(size = 5) +\n  geom_text(aes(label = Strategy), vjust = -1, size = 4) +\n  scale_y_continuous(labels = comma_format()) +\n  scale_color_manual(values = c(\"#4f46e5\", \"#10b981\", \"#f59e0b\")) +\n  labs(\n    title = \"成本效果平面图\",\n    x = \"质量调整生命年 (QALY)\",\n    y = \"成本 (元)\",\n    color = \"治疗方案\"\n  ) +\n  theme_bw(base_size = 12) +\n  theme(\n    legend.position = \"bottom\",\n    plot.title = element_text(hjust = 0.5, face = \"bold\")\n  ) +\n  expand_limits(y = c(0, 150000))\n```\n\n### 计算增量成本效果比 (ICER)\n\nICER 公式：$$ICER = \\frac{\\Delta Cost}{\\Delta QALY} = \\frac{Cost_B - Cost_A}{QALY_B - QALY_A}$$\n\n```{r}\n# 以标准治疗为参照计算 ICER\nreference <- cea_data[1, ]\n\nicer_results <- cea_data |>\n  mutate(\n    Delta_Cost = Cost - reference$Cost,\n    Delta_QALY = QALY - reference$QALY,\n    ICER = ifelse(Delta_QALY > 0, Delta_Cost / Delta_QALY, NA)\n  )\n\nicer_results\n```\n\n---\n\n## 成本效果可接受曲线 (CEAC)\n\n### 概率敏感性分析数据\n\n模拟 1000 次蒙特卡洛模拟的结果：\n\n```{r}\nset.seed(42)\nn_sim <- 1000\n\n# 模拟成本和效果的不确定性\nsim_data <- data.frame(\n  simulation = rep(1:n_sim, 3),\n  Strategy = rep(c(\"标准治疗\", \"新药A\", \"新药B\"), each = n_sim),\n  Cost = c(\n    rnorm(n_sim, 50000, 5000),\n    rnorm(n_sim, 80000, 10000),\n    rnorm(n_sim, 120000, 15000)\n  ),\n  QALY = c(\n    rnorm(n_sim, 5.2, 0.5),\n    rnorm(n_sim, 6.8, 0.6),\n    rnorm(n_sim, 7.5, 0.7)\n  )\n)\n\nhead(sim_data)\n```\n\n### 增量成本效果散点图\n\n```{r}\n# 计算相对于标准治疗的增量\nref_data <- sim_data |>\n  filter(Strategy == \"标准治疗\") |>\n  select(simulation, ref_Cost = Cost, ref_QALY = QALY)\n\nincremental_data <- sim_data |>\n  filter(Strategy != \"标准治疗\") |>\n  left_join(ref_data, by = \"simulation\") |>\n  mutate(\n    Delta_Cost = Cost - ref_Cost,\n    Delta_QALY = QALY - ref_QALY\n  )\n\n# 绘制增量成本效果散点图\nggplot(incremental_data, aes(x = Delta_QALY, y = Delta_Cost, color = Strategy)) +\n  geom_point(alpha = 0.3, size = 1.5) +\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"gray50\") +\n  geom_vline(xintercept = 0, linetype = \"dashed\", color = \"gray50\") +\n  # 添加 WTP 阈值线（假设 50000 元/QALY）\n  geom_abline(intercept = 0, slope = 50000, linetype = \"solid\", color = \"red\", linewidth = 1) +\n  scale_y_continuous(labels = comma_format()) +\n  scale_color_manual(values = c(\"#10b981\", \"#f59e0b\")) +\n  labs(\n    title = \"增量成本效果散点图\",\n    subtitle = \"红线: WTP 阈值 = 50,000 元/QALY\",\n    x = \"增量 QALY (ΔQALYs)\",\n    y = \"增量成本 (Δ成本)\",\n    color = \"治疗方案\"\n  ) +\n  theme_bw(base_size = 12) +\n  theme(\n    legend.position = \"bottom\",\n    plot.title = element_text(hjust = 0.5, face = \"bold\")\n  ) +\n  annotate(\"text\", x = 2.5, y = -20000, label = \"优势象限\\n(更有效且更便宜)\", \n           color = \"darkgreen\", size = 3) +\n  annotate(\"text\", x = -0.5, y = 80000, label = \"劣势象限\\n(更无效且更贵)\", \n           color = \"darkred\", size = 3)\n```\n\n### 成本效果可接受曲线\n\nCEAC 展示在不同 WTP 阈值下，每种策略具有成本效果的概率。\n\n```{r}\n# 定义 WTP 范围\nwtp_range <- seq(0, 150000, by = 5000)\n\n# 计算每个 WTP 下各策略的可接受概率\ncalculate_ceac <- function(sim_data, wtp_range) {\n  strategies <- unique(sim_data$Strategy)\n  results <- data.frame()\n  \n  for (wtp in wtp_range) {\n    # 计算每次模拟的净货币收益 (NMB)\n    nmb_data <- sim_data |>\n      mutate(NMB = wtp * QALY - Cost)\n    \n    # 找出每次模拟中 NMB 最高的策略\n    best_strategy <- nmb_data |>\n      group_by(simulation) |>\n      slice_max(NMB, n = 1) |>\n      ungroup()\n    \n    # 计算每种策略的最优概率\n    prob_best <- best_strategy |>\n      count(Strategy) |>\n      mutate(Probability = n / n_sim)\n    \n    # 补充没有出现的策略\n    for (s in strategies) {\n      if (!s %in% prob_best$Strategy) {\n        prob_best <- bind_rows(prob_best, \n                               data.frame(Strategy = s, n = 0, Probability = 0))\n      }\n    }\n    \n    prob_best$WTP <- wtp\n    results <- bind_rows(results, prob_best)\n  }\n  \n  results\n}\n\nceac_data <- calculate_ceac(sim_data, wtp_range)\n\n# 绘制 CEAC\nggplot(ceac_data, aes(x = WTP, y = Probability, color = Strategy)) +\n  geom_line(linewidth = 1.2) +\n  geom_vline(xintercept = 50000, linetype = \"dashed\", color = \"gray50\") +\n  scale_x_continuous(labels = comma_format()) +\n  scale_y_continuous(limits = c(0, 1), labels = percent_format()) +\n  scale_color_manual(values = c(\"#4f46e5\", \"#10b981\", \"#f59e0b\")) +\n  labs(\n    title = \"成本效果可接受曲线 (CEAC)\",\n    x = \"支付意愿 (WTP, 元/QALY)\",\n    y = \"成本效果的概率\",\n    color = \"治疗方案\"\n  ) +\n  theme_bw(base_size = 12) +\n  theme(\n    legend.position = \"bottom\",\n    plot.title = element_text(hjust = 0.5, face = \"bold\")\n  ) +\n  annotate(\"text\", x = 55000, y = 0.95, label = \"WTP = 50,000\", \n           hjust = 0, color = \"gray30\", size = 3.5)\n```\n\n---\n\n## 决策树模型\n\n### 简单决策树示例\n\n模拟一个简单的治疗决策场景：\n\n```{r}\n# 决策树参数\nparams <- list(\n  # 治疗成功率\n  p_success_standard = 0.60,\n  p_success_new = 0.80,\n  \n  # 成本\n  c_standard = 10000,\n  c_new = 25000,\n  c_success = 5000,  # 成功后维护成本\n  c_failure = 50000, # 失败后补救成本\n  \n  # 效用\n  u_success = 0.9,\n  u_failure = 0.5,\n  \n  # 时间范围（年）\n  time_horizon = 5\n)\n\n# 计算期望成本和效果\ncalculate_expected <- function(p_success, c_treatment, params) {\n  # 期望成本\n  expected_cost <- c_treatment + \n    p_success * params$c_success + \n    (1 - p_success) * params$c_failure\n  \n  # 期望 QALY\n  expected_qaly <- params$time_horizon * (\n    p_success * params$u_success + \n    (1 - p_success) * params$u_failure\n  )\n  \n  list(cost = expected_cost, qaly = expected_qaly)\n}\n\n# 标准治疗\nstandard <- calculate_expected(params$p_success_standard, params$c_standard, params)\n\n# 新治疗\nnew_treatment <- calculate_expected(params$p_success_new, params$c_new, params)\n\n# 结果汇总\ndecision_tree_results <- data.frame(\n  Strategy = c(\"标准治疗\", \"新治疗\"),\n  Expected_Cost = c(standard$cost, new_treatment$cost),\n  Expected_QALY = c(standard$qaly, new_treatment$qaly)\n) |>\n  mutate(\n    ICER = c(NA, (Expected_Cost[2] - Expected_Cost[1]) / \n               (Expected_QALY[2] - Expected_QALY[1]))\n  )\n\ndecision_tree_results\n```\n\n### 决策树可视化\n\n```{r fig.width=10, fig.height=6}\n# 创建决策树数据\ntree_data <- data.frame(\n  x = c(0, 1, 1, 2, 2, 2, 2),\n  y = c(3, 4.5, 1.5, 5.5, 3.5, 2.5, 0.5),\n  label = c(\n    \"决策节点\",\n    \"标准治疗\",\n    \"新治疗\",\n    paste0(\"成功 (\", params$p_success_standard * 100, \"%)\"),\n    paste0(\"失败 (\", (1 - params$p_success_standard) * 100, \"%)\"),\n    paste0(\"成功 (\", params$p_success_new * 100, \"%)\"),\n    paste0(\"失败 (\", (1 - params$p_success_new) * 100, \"%)\")\n  ),\n  node_type = c(\"decision\", \"chance\", \"chance\", \"outcome\", \"outcome\", \"outcome\", \"outcome\")\n)\n\n# 连接线数据\nedges <- data.frame(\n  x = c(0, 0, 1, 1, 1, 1),\n  xend = c(1, 1, 2, 2, 2, 2),\n  y = c(3, 3, 4.5, 4.5, 1.5, 1.5),\n  yend = c(4.5, 1.5, 5.5, 3.5, 2.5, 0.5)\n)\n\nggplot() +\n  # 绘制连接线\n  geom_segment(data = edges, \n               aes(x = x, y = y, xend = xend, yend = yend),\n               color = \"gray50\", linewidth = 0.8) +\n  # 决策节点（方形）\n  geom_point(data = tree_data |> filter(node_type == \"decision\"),\n             aes(x = x, y = y), shape = 15, size = 8, color = \"#4f46e5\") +\n  # 机会节点（圆形）\n  geom_point(data = tree_data |> filter(node_type == \"chance\"),\n             aes(x = x, y = y), shape = 16, size = 6, color = \"#10b981\") +\n  # 结果节点（三角形）\n  geom_point(data = tree_data |> filter(node_type == \"outcome\"),\n             aes(x = x, y = y), shape = 17, size = 5, color = \"#f59e0b\") +\n  # 标签\n  geom_text(data = tree_data,\n            aes(x = x, y = y, label = label),\n            hjust = -0.1, vjust = 0.5, size = 3.5) +\n  # 添加结果数值\n  annotate(\"text\", x = 2.8, y = 5.5, \n           label = paste0(\"成本: \", comma(params$c_standard + params$c_success), \n                          \"\\nQALY: \", params$time_horizon * params$u_success),\n           hjust = 0, size = 3, color = \"gray30\") +\n  annotate(\"text\", x = 2.8, y = 3.5,\n           label = paste0(\"成本: \", comma(params$c_standard + params$c_failure),\n                          \"\\nQALY: \", params$time_horizon * params$u_failure),\n           hjust = 0, size = 3, color = \"gray30\") +\n  annotate(\"text\", x = 2.8, y = 2.5,\n           label = paste0(\"成本: \", comma(params$c_new + params$c_success),\n                          \"\\nQALY: \", params$time_horizon * params$u_success),\n           hjust = 0, size = 3, color = \"gray30\") +\n  annotate(\"text\", x = 2.8, y = 0.5,\n           label = paste0(\"成本: \", comma(params$c_new + params$c_failure),\n                          \"\\nQALY: \", params$time_horizon * params$u_failure),\n           hjust = 0, size = 3, color = \"gray30\") +\n  labs(title = \"治疗决策树模型\") +\n  theme_void() +\n  theme(plot.title = element_text(hjust = 0.5, face = \"bold\", size = 14)) +\n  xlim(-0.5, 4) +\n  ylim(-0.5, 6.5)\n```\n\n---\n\n## 马尔可夫模型\n\n### 模型概述\n\n马尔可夫模型是卫生经济学中最常用的建模方法，用于模拟疾病进展和干预效果。\n\n```{r}\n# 定义模型参数\nmarkov_params <- list(\n  # 状态名称\n  states = c(\"健康\", \"疾病\", \"死亡\"),\n  n_states = 3,\n  \n  # 周期数（年）\n  n_cycles = 20,\n  \n  # 转移概率（标准治疗）\n  p_healthy_disease_std = 0.10,\n  p_disease_death_std = 0.15,\n  \n  # 转移概率（新治疗）\n  p_healthy_disease_new = 0.05,\n  p_disease_death_new = 0.10,\n  \n  # 成本（每周期）\n  c_healthy = 1000,\n  c_disease = 8000,\n  c_death = 0,\n  c_new_treatment = 5000,  # 新治疗额外成本\n  \n  # 效用\n  u_healthy = 1.0,\n  u_disease = 0.6,\n  u_death = 0,\n  \n  # 贴现率\n  discount_rate = 0.03\n)\n```\n\n### 构建转移概率矩阵\n\n```{r}\n# 标准治疗转移矩阵\ntrans_matrix_std <- matrix(c(\n  0.89, 0.10, 0.01,  # 从健康状态\n  0.00, 0.84, 0.16,  # 从疾病状态（含背景死亡）\n  0.00, 0.00, 1.00   # 从死亡状态\n), nrow = 3, byrow = TRUE)\n\nrownames(trans_matrix_std) <- colnames(trans_matrix_std) <- markov_params$states\n\n# 新治疗转移矩阵\ntrans_matrix_new <- matrix(c(\n  0.94, 0.05, 0.01,  # 从健康状态\n  0.00, 0.89, 0.11,  # 从疾病状态\n  0.00, 0.00, 1.00   # 从死亡状态\n), nrow = 3, byrow = TRUE)\n\nrownames(trans_matrix_new) <- colnames(trans_matrix_new) <- markov_params$states\n\ntrans_matrix_std\n```\n\n### 运行马尔可夫模拟\n\n```{r}\n# 马尔可夫模拟函数\nrun_markov <- function(trans_matrix, params, treatment_cost = 0) {\n  n_cycles <- params$n_cycles\n  states <- params$states\n  \n  # 初始状态分布（100% 健康）\n  state_dist <- matrix(0, nrow = n_cycles + 1, ncol = 3)\n  colnames(state_dist) <- states\n  state_dist[1, ] <- c(1, 0, 0)\n  \n  # 成本和效用向量\n  costs <- c(params$c_healthy, params$c_disease, params$c_death)\n  utilities <- c(params$u_healthy, params$u_disease, params$u_death)\n  \n  # 贴现因子\n  discount_factors <- (1 / (1 + params$discount_rate)) ^ (0:n_cycles)\n  \n  # 模拟各周期\n  for (i in 1:n_cycles) {\n    state_dist[i + 1, ] <- state_dist[i, ] %*% trans_matrix\n  }\n  \n  # 计算成本和 QALY\n  cycle_costs <- state_dist %*% costs + treatment_cost\n  cycle_qalys <- state_dist %*% utilities\n  \n  # 贴现后总计\n  total_cost <- sum(cycle_costs * discount_factors)\n  total_qaly <- sum(cycle_qalys * discount_factors)\n  \n  list(\n    state_dist = state_dist,\n    total_cost = total_cost,\n    total_qaly = total_qaly,\n    cycle_costs = cycle_costs,\n    cycle_qalys = cycle_qalys\n  )\n}\n\n# 运行两种治疗方案\nresults_std <- run_markov(trans_matrix_std, markov_params, treatment_cost = 0)\nresults_new <- run_markov(trans_matrix_new, markov_params, treatment_cost = markov_params$c_new_treatment)\n```\n\n### 状态分布可视化\n\n```{r fig.width=10, fig.height=5}\n# 整理状态分布数据\nprepare_state_data <- function(results, treatment_name) {\n  data.frame(\n    Cycle = rep(0:markov_params$n_cycles, 3),\n    State = rep(markov_params$states, each = markov_params$n_cycles + 1),\n    Proportion = as.vector(results$state_dist),\n    Treatment = treatment_name\n  )\n}\n\nstate_data <- bind_rows(\n  prepare_state_data(results_std, \"标准治疗\"),\n  prepare_state_data(results_new, \"新治疗\")\n)\n\n# 绘制状态转移图\nggplot(state_data, aes(x = Cycle, y = Proportion, fill = State)) +\n  geom_area(alpha = 0.8) +\n  facet_wrap(~Treatment) +\n  scale_fill_manual(values = c(\"#10b981\", \"#f59e0b\", \"#6b7280\")) +\n  scale_y_continuous(labels = percent_format()) +\n  labs(\n    title = \"马尔可夫模型状态分布\",\n    x = \"周期（年）\",\n    y = \"人群比例\",\n    fill = \"健康状态\"\n  ) +\n  theme_bw(base_size = 12) +\n  theme(\n    legend.position = \"bottom\",\n    plot.title = element_text(hjust = 0.5, face = \"bold\"),\n    strip.background = element_rect(fill = \"#4f46e5\"),\n    strip.text = element_text(color = \"white\", face = \"bold\")\n  )\n```\n\n### 马尔可夫模型结果汇总\n\n```{r}\n# 汇总结果\nmarkov_summary <- data.frame(\n  Strategy = c(\"标准治疗\", \"新治疗\"),\n  Total_Cost = c(results_std$total_cost, results_new$total_cost),\n  Total_QALY = c(results_std$total_qaly, results_new$total_qaly)\n) |>\n  mutate(\n    Delta_Cost = Total_Cost - Total_Cost[1],\n    Delta_QALY = Total_QALY - Total_QALY[1],\n    ICER = ifelse(Delta_QALY > 0, Delta_Cost / Delta_QALY, NA)\n  )\n\nmarkov_summary\n```\n\n---\n\n## 单因素敏感性分析\n\n### 龙卷风图\n\n龙卷风图展示各参数对结果的影响程度。\n\n```{r fig.width=9, fig.height=6}\n# 定义参数范围\nsensitivity_params <- data.frame(\n  Parameter = c(\n    \"疾病转移概率 (标准)\",\n    \"死亡转移概率 (标准)\",\n    \"疾病转移概率 (新)\",\n    \"死亡转移概率 (新)\",\n    \"疾病状态成本\",\n    \"新治疗成本\",\n    \"贴现率\"\n  ),\n  Base = c(0.10, 0.15, 0.05, 0.10, 8000, 5000, 0.03),\n  Low = c(0.05, 0.10, 0.03, 0.05, 5000, 3000, 0.00),\n  High = c(0.15, 0.20, 0.08, 0.15, 12000, 8000, 0.05)\n)\n\n# 模拟敏感性分析结果（简化演示）\nset.seed(123)\ntornado_data <- sensitivity_params |>\n  mutate(\n    ICER_low = runif(n(), 15000, 35000),\n    ICER_high = runif(n(), 35000, 55000),\n    ICER_base = 32000\n  ) |>\n  arrange(desc(abs(ICER_high - ICER_low)))\n\n# 绘制龙卷风图\nggplot(tornado_data) +\n  geom_segment(aes(y = reorder(Parameter, abs(ICER_high - ICER_low)),\n                   yend = reorder(Parameter, abs(ICER_high - ICER_low)),\n                   x = ICER_low, xend = ICER_high),\n               linewidth = 8, color = \"#4f46e5\", alpha = 0.7) +\n  geom_vline(xintercept = tornado_data$ICER_base[1], \n             linetype = \"dashed\", color = \"red\", linewidth = 1) +\n  scale_x_continuous(labels = comma_format()) +\n  labs(\n    title = \"龙卷风图 - 单因素敏感性分析\",\n    subtitle = \"红色虚线: 基准 ICER\",\n    x = \"ICER (元/QALY)\",\n    y = \"参数\"\n  ) +\n  theme_bw(base_size = 12) +\n  theme(\n    plot.title = element_text(hjust = 0.5, face = \"bold\"),\n    panel.grid.major.y = element_blank()\n  )\n```\n\n---\n\n## 成本效果前沿\n\n### 效率前沿线\n\n效率前沿展示在给定成本下可达到的最大效果。\n\n```{r}\n# 创建多策略数据\nfrontier_data <- data.frame(\n  Strategy = c(\"无干预\", \"方案A\", \"方案B\", \"方案C\", \"方案D\", \"方案E\"),\n  Cost = c(10000, 30000, 45000, 60000, 90000, 100000),\n  QALY = c(4.0, 5.5, 6.2, 6.8, 7.8, 7.9)\n)\n\n# 识别效率前沿上的策略（简化算法）\nfrontier_data <- frontier_data |>\n  arrange(Cost) |>\n  mutate(\n    on_frontier = c(TRUE, TRUE, TRUE, FALSE, TRUE, FALSE)  # 手动标记\n  )\n\nggplot(frontier_data, aes(x = QALY, y = Cost)) +\n  # 绘制效率前沿线\n  geom_line(data = frontier_data |> filter(on_frontier),\n            color = \"#4f46e5\", linewidth = 1.2) +\n  # 所有点\n  geom_point(aes(color = on_frontier), size = 5) +\n  # 标签\n  geom_text(aes(label = Strategy), vjust = -1, size = 3.5) +\n  scale_color_manual(values = c(\"TRUE\" = \"#10b981\", \"FALSE\" = \"#ef4444\"),\n                     labels = c(\"TRUE\" = \"效率前沿\", \"FALSE\" = \"被支配\")) +\n  scale_y_continuous(labels = comma_format()) +\n  labs(\n    title = \"成本效果效率前沿\",\n    x = \"质量调整生命年 (QALY)\",\n    y = \"成本 (元)\",\n    color = \"策略状态\"\n  ) +\n  theme_bw(base_size = 12) +\n  theme(\n    legend.position = \"bottom\",\n    plot.title = element_text(hjust = 0.5, face = \"bold\")\n  )\n```\n\n---\n\n## 净货币收益分析\n\n### NMB 计算与可视化\n\n净货币收益（Net Monetary Benefit）：$$NMB = WTP \\times \\Delta QALY - \\Delta Cost$$\n\n```{r}\n# 计算不同 WTP 下的 NMB\nwtp_values <- seq(0, 100000, by = 10000)\n\nnmb_data <- expand.grid(\n  WTP = wtp_values,\n  Strategy = c(\"标准治疗\", \"新药A\", \"新药B\")\n) |>\n  left_join(cea_data, by = \"Strategy\") |>\n  mutate(\n    NMB = WTP * QALY - Cost\n  )\n\nggplot(nmb_data, aes(x = WTP, y = NMB, color = Strategy)) +\n  geom_line(linewidth = 1.2) +\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"gray50\") +\n  scale_x_continuous(labels = comma_format()) +\n  scale_y_continuous(labels = comma_format()) +\n  scale_color_manual(values = c(\"#4f46e5\", \"#10b981\", \"#f59e0b\")) +\n  labs(\n    title = \"净货币收益 (NMB) 分析\",\n    x = \"支付意愿 (WTP, 元/QALY)\",\n    y = \"净货币收益 (元)\",\n    color = \"治疗方案\"\n  ) +\n  theme_bw(base_size = 12) +\n  theme(\n    legend.position = \"bottom\",\n    plot.title = element_text(hjust = 0.5, face = \"bold\")\n  )\n```\n\n---\n\n## 实用函数封装\n\n### ICER 计算函数\n\n```{r}\n#' 计算 ICER\n#' @param cost_new 新治疗成本\n#' @param cost_ref 参照治疗成本\n#' @param effect_new 新治疗效果\n#' @param effect_ref 参照治疗效果\n#' @return ICER 值\ncalculate_icer <- function(cost_new, cost_ref, effect_new, effect_ref) {\n  delta_cost <- cost_new - cost_ref\n  delta_effect <- effect_new - effect_ref\n  \n  if (delta_effect <= 0) {\n    warning(\"增量效果 <= 0，新治疗可能被支配\")\n    return(NA)\n  }\n  \n  icer <- delta_cost / delta_effect\n  \n  cat(\"增量成本:\", comma(delta_cost), \"元\\n\")\n  cat(\"增量效果:\", round(delta_effect, 3), \"QALY\\n\")\n  cat(\"ICER:\", comma(round(icer, 0)), \"元/QALY\\n\")\n  \n  invisible(icer)\n}\n\n# 示例\ncalculate_icer(\n  cost_new = 80000, cost_ref = 50000,\n  effect_new = 6.8, effect_ref = 5.2\n)\n```\n\n---\n\n## 总结\n\n卫生经济学评价是医疗决策的重要工具，R 语言提供了强大的分析能力：\n\n| 分析类型 | 关键指标 | 推荐方法 |\n|----------|----------|----------|\n| 成本效果分析 | ICER | 增量分析、效率前沿 |\n| 不确定性分析 | CEAC、龙卷风图 | 概率敏感性分析 |\n| 疾病建模 | 状态分布、生存曲线 | 马尔可夫模型、决策树 |\n| 决策支持 | NMB | 净货币收益分析 |\n\n### 推荐学习资源\n\n- [DARTH 工作组](https://darthworkgroup.com/) - 决策分析建模教程\n- [ISPOR 指南](https://www.ispor.org/) - 卫生经济学方法学标准\n- [R for Health Technology Assessment](https://r-hta.org/) - R 语言 HTA 资源\n\n### 常用 WTP 阈值参考\n\n| 国家/地区 | WTP 阈值（每 QALY） |\n|-----------|---------------------|\n| 中国 | 1-3 倍人均 GDP（约 7-21 万元） |\n| 英国 (NICE) | £20,000-30,000 |\n| 美国 | $50,000-150,000 |\n| WHO 推荐 | 1-3 倍人均 GDP |\n","srcMarkdownNoYaml":"\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(\n  echo = TRUE,\n  warning = FALSE,\n  message = FALSE,\n  fig.width = 8,\n  fig.height = 5,\n  fig.retina = 2,\n  out.width = \"100%\",\n  dpi = 150\n)\n```\n\n## 什么是卫生经济学评价\n\n卫生经济学评价（Health Economic Evaluation）是一种系统性比较不同医疗干预措施的**成本**和**健康结果**的分析方法，帮助决策者在有限资源下做出最优选择。\n\n### 主要评价方法\n\n| 方法 | 英文缩写 | 结果指标 | 适用场景 |\n|------|----------|----------|----------|\n| 成本效果分析 | CEA | 自然单位（如生命年） | 单一疾病比较 |\n| 成本效用分析 | CUA | 质量调整生命年（QALY） | 跨疾病比较 |\n| 成本效益分析 | CBA | 货币单位 | 健康与非健康项目比较 |\n| 成本最小化分析 | CMA | 无（假设效果相同） | 效果相同的干预比较 |\n\n### 核心概念\n\n- **ICER**（增量成本效果比）：每多获得一个健康单位所需的额外成本\n- **QALY**（质量调整生命年）：综合考虑生存时间和生活质量\n- **WTP**（支付意愿）：社会愿意为一个 QALY 支付的最高金额\n- **贴现率**：将未来成本/效果折算为现值的比率（通常 3-5%）\n\n---\n\n## R包介绍\n\n卫生经济学分析常用的 R 包：\n\n| R包 | 功能 | 链接 |\n|-----|------|------|\n| `hesim` | 健康状态转换模型、决策分析 | [CRAN](https://cran.r-project.org/package=hesim) |\n| `heemod` | 马尔可夫模型构建 | [CRAN](https://cran.r-project.org/package=heemod) |\n| `BCEA` | 贝叶斯成本效果分析 | [CRAN](https://cran.r-project.org/package=BCEA) |\n| `dampack` | 决策分析模型参数化 | [CRAN](https://cran.r-project.org/package=dampack) |\n| `survHE` | 生存分析外推 | [CRAN](https://cran.r-project.org/package=survHE) |\n\n本教程使用基础 R 和 `ggplot2` 从零实现卫生经济学核心分析，无需安装专业包。\n\n## R包安装\n\n```{r eval=FALSE}\n# 安装核心包\ninstall.packages(\"ggplot2\")\ninstall.packages(\"dplyr\")\ninstall.packages(\"scales\")\n```\n\n```{r}\nlibrary(ggplot2)\nlibrary(dplyr)\nlibrary(scales)\n```\n\n---\n\n## 成本效果分析基础\n\n### 模拟数据准备\n\n假设我们比较三种治疗方案：标准治疗、新药 A、新药 B。\n\n```{r}\n# 创建策略数据\nstrategies <- c(\"标准治疗\", \"新药A\", \"新药B\")\n\n# 成本数据（单位：元）\ncosts <- c(50000, 80000, 120000)\n\n# 效果数据（QALY）\nqalys <- c(5.2, 6.8, 7.5)\n\n# 创建数据框\ncea_data <- data.frame(\n  Strategy = strategies,\n  Cost = costs,\n  QALY = qalys\n)\n\ncea_data\n```\n\n### 成本效果平面图\n\n成本效果平面图是卫生经济学最基础的可视化，横轴为效果（QALY），纵轴为成本。\n\n```{r}\n# 基础成本效果平面图\nggplot(cea_data, aes(x = QALY, y = Cost, color = Strategy)) +\n  geom_point(size = 5) +\n  geom_text(aes(label = Strategy), vjust = -1, size = 4) +\n  scale_y_continuous(labels = comma_format()) +\n  scale_color_manual(values = c(\"#4f46e5\", \"#10b981\", \"#f59e0b\")) +\n  labs(\n    title = \"成本效果平面图\",\n    x = \"质量调整生命年 (QALY)\",\n    y = \"成本 (元)\",\n    color = \"治疗方案\"\n  ) +\n  theme_bw(base_size = 12) +\n  theme(\n    legend.position = \"bottom\",\n    plot.title = element_text(hjust = 0.5, face = \"bold\")\n  ) +\n  expand_limits(y = c(0, 150000))\n```\n\n### 计算增量成本效果比 (ICER)\n\nICER 公式：$$ICER = \\frac{\\Delta Cost}{\\Delta QALY} = \\frac{Cost_B - Cost_A}{QALY_B - QALY_A}$$\n\n```{r}\n# 以标准治疗为参照计算 ICER\nreference <- cea_data[1, ]\n\nicer_results <- cea_data |>\n  mutate(\n    Delta_Cost = Cost - reference$Cost,\n    Delta_QALY = QALY - reference$QALY,\n    ICER = ifelse(Delta_QALY > 0, Delta_Cost / Delta_QALY, NA)\n  )\n\nicer_results\n```\n\n---\n\n## 成本效果可接受曲线 (CEAC)\n\n### 概率敏感性分析数据\n\n模拟 1000 次蒙特卡洛模拟的结果：\n\n```{r}\nset.seed(42)\nn_sim <- 1000\n\n# 模拟成本和效果的不确定性\nsim_data <- data.frame(\n  simulation = rep(1:n_sim, 3),\n  Strategy = rep(c(\"标准治疗\", \"新药A\", \"新药B\"), each = n_sim),\n  Cost = c(\n    rnorm(n_sim, 50000, 5000),\n    rnorm(n_sim, 80000, 10000),\n    rnorm(n_sim, 120000, 15000)\n  ),\n  QALY = c(\n    rnorm(n_sim, 5.2, 0.5),\n    rnorm(n_sim, 6.8, 0.6),\n    rnorm(n_sim, 7.5, 0.7)\n  )\n)\n\nhead(sim_data)\n```\n\n### 增量成本效果散点图\n\n```{r}\n# 计算相对于标准治疗的增量\nref_data <- sim_data |>\n  filter(Strategy == \"标准治疗\") |>\n  select(simulation, ref_Cost = Cost, ref_QALY = QALY)\n\nincremental_data <- sim_data |>\n  filter(Strategy != \"标准治疗\") |>\n  left_join(ref_data, by = \"simulation\") |>\n  mutate(\n    Delta_Cost = Cost - ref_Cost,\n    Delta_QALY = QALY - ref_QALY\n  )\n\n# 绘制增量成本效果散点图\nggplot(incremental_data, aes(x = Delta_QALY, y = Delta_Cost, color = Strategy)) +\n  geom_point(alpha = 0.3, size = 1.5) +\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"gray50\") +\n  geom_vline(xintercept = 0, linetype = \"dashed\", color = \"gray50\") +\n  # 添加 WTP 阈值线（假设 50000 元/QALY）\n  geom_abline(intercept = 0, slope = 50000, linetype = \"solid\", color = \"red\", linewidth = 1) +\n  scale_y_continuous(labels = comma_format()) +\n  scale_color_manual(values = c(\"#10b981\", \"#f59e0b\")) +\n  labs(\n    title = \"增量成本效果散点图\",\n    subtitle = \"红线: WTP 阈值 = 50,000 元/QALY\",\n    x = \"增量 QALY (ΔQALYs)\",\n    y = \"增量成本 (Δ成本)\",\n    color = \"治疗方案\"\n  ) +\n  theme_bw(base_size = 12) +\n  theme(\n    legend.position = \"bottom\",\n    plot.title = element_text(hjust = 0.5, face = \"bold\")\n  ) +\n  annotate(\"text\", x = 2.5, y = -20000, label = \"优势象限\\n(更有效且更便宜)\", \n           color = \"darkgreen\", size = 3) +\n  annotate(\"text\", x = -0.5, y = 80000, label = \"劣势象限\\n(更无效且更贵)\", \n           color = \"darkred\", size = 3)\n```\n\n### 成本效果可接受曲线\n\nCEAC 展示在不同 WTP 阈值下，每种策略具有成本效果的概率。\n\n```{r}\n# 定义 WTP 范围\nwtp_range <- seq(0, 150000, by = 5000)\n\n# 计算每个 WTP 下各策略的可接受概率\ncalculate_ceac <- function(sim_data, wtp_range) {\n  strategies <- unique(sim_data$Strategy)\n  results <- data.frame()\n  \n  for (wtp in wtp_range) {\n    # 计算每次模拟的净货币收益 (NMB)\n    nmb_data <- sim_data |>\n      mutate(NMB = wtp * QALY - Cost)\n    \n    # 找出每次模拟中 NMB 最高的策略\n    best_strategy <- nmb_data |>\n      group_by(simulation) |>\n      slice_max(NMB, n = 1) |>\n      ungroup()\n    \n    # 计算每种策略的最优概率\n    prob_best <- best_strategy |>\n      count(Strategy) |>\n      mutate(Probability = n / n_sim)\n    \n    # 补充没有出现的策略\n    for (s in strategies) {\n      if (!s %in% prob_best$Strategy) {\n        prob_best <- bind_rows(prob_best, \n                               data.frame(Strategy = s, n = 0, Probability = 0))\n      }\n    }\n    \n    prob_best$WTP <- wtp\n    results <- bind_rows(results, prob_best)\n  }\n  \n  results\n}\n\nceac_data <- calculate_ceac(sim_data, wtp_range)\n\n# 绘制 CEAC\nggplot(ceac_data, aes(x = WTP, y = Probability, color = Strategy)) +\n  geom_line(linewidth = 1.2) +\n  geom_vline(xintercept = 50000, linetype = \"dashed\", color = \"gray50\") +\n  scale_x_continuous(labels = comma_format()) +\n  scale_y_continuous(limits = c(0, 1), labels = percent_format()) +\n  scale_color_manual(values = c(\"#4f46e5\", \"#10b981\", \"#f59e0b\")) +\n  labs(\n    title = \"成本效果可接受曲线 (CEAC)\",\n    x = \"支付意愿 (WTP, 元/QALY)\",\n    y = \"成本效果的概率\",\n    color = \"治疗方案\"\n  ) +\n  theme_bw(base_size = 12) +\n  theme(\n    legend.position = \"bottom\",\n    plot.title = element_text(hjust = 0.5, face = \"bold\")\n  ) +\n  annotate(\"text\", x = 55000, y = 0.95, label = \"WTP = 50,000\", \n           hjust = 0, color = \"gray30\", size = 3.5)\n```\n\n---\n\n## 决策树模型\n\n### 简单决策树示例\n\n模拟一个简单的治疗决策场景：\n\n```{r}\n# 决策树参数\nparams <- list(\n  # 治疗成功率\n  p_success_standard = 0.60,\n  p_success_new = 0.80,\n  \n  # 成本\n  c_standard = 10000,\n  c_new = 25000,\n  c_success = 5000,  # 成功后维护成本\n  c_failure = 50000, # 失败后补救成本\n  \n  # 效用\n  u_success = 0.9,\n  u_failure = 0.5,\n  \n  # 时间范围（年）\n  time_horizon = 5\n)\n\n# 计算期望成本和效果\ncalculate_expected <- function(p_success, c_treatment, params) {\n  # 期望成本\n  expected_cost <- c_treatment + \n    p_success * params$c_success + \n    (1 - p_success) * params$c_failure\n  \n  # 期望 QALY\n  expected_qaly <- params$time_horizon * (\n    p_success * params$u_success + \n    (1 - p_success) * params$u_failure\n  )\n  \n  list(cost = expected_cost, qaly = expected_qaly)\n}\n\n# 标准治疗\nstandard <- calculate_expected(params$p_success_standard, params$c_standard, params)\n\n# 新治疗\nnew_treatment <- calculate_expected(params$p_success_new, params$c_new, params)\n\n# 结果汇总\ndecision_tree_results <- data.frame(\n  Strategy = c(\"标准治疗\", \"新治疗\"),\n  Expected_Cost = c(standard$cost, new_treatment$cost),\n  Expected_QALY = c(standard$qaly, new_treatment$qaly)\n) |>\n  mutate(\n    ICER = c(NA, (Expected_Cost[2] - Expected_Cost[1]) / \n               (Expected_QALY[2] - Expected_QALY[1]))\n  )\n\ndecision_tree_results\n```\n\n### 决策树可视化\n\n```{r fig.width=10, fig.height=6}\n# 创建决策树数据\ntree_data <- data.frame(\n  x = c(0, 1, 1, 2, 2, 2, 2),\n  y = c(3, 4.5, 1.5, 5.5, 3.5, 2.5, 0.5),\n  label = c(\n    \"决策节点\",\n    \"标准治疗\",\n    \"新治疗\",\n    paste0(\"成功 (\", params$p_success_standard * 100, \"%)\"),\n    paste0(\"失败 (\", (1 - params$p_success_standard) * 100, \"%)\"),\n    paste0(\"成功 (\", params$p_success_new * 100, \"%)\"),\n    paste0(\"失败 (\", (1 - params$p_success_new) * 100, \"%)\")\n  ),\n  node_type = c(\"decision\", \"chance\", \"chance\", \"outcome\", \"outcome\", \"outcome\", \"outcome\")\n)\n\n# 连接线数据\nedges <- data.frame(\n  x = c(0, 0, 1, 1, 1, 1),\n  xend = c(1, 1, 2, 2, 2, 2),\n  y = c(3, 3, 4.5, 4.5, 1.5, 1.5),\n  yend = c(4.5, 1.5, 5.5, 3.5, 2.5, 0.5)\n)\n\nggplot() +\n  # 绘制连接线\n  geom_segment(data = edges, \n               aes(x = x, y = y, xend = xend, yend = yend),\n               color = \"gray50\", linewidth = 0.8) +\n  # 决策节点（方形）\n  geom_point(data = tree_data |> filter(node_type == \"decision\"),\n             aes(x = x, y = y), shape = 15, size = 8, color = \"#4f46e5\") +\n  # 机会节点（圆形）\n  geom_point(data = tree_data |> filter(node_type == \"chance\"),\n             aes(x = x, y = y), shape = 16, size = 6, color = \"#10b981\") +\n  # 结果节点（三角形）\n  geom_point(data = tree_data |> filter(node_type == \"outcome\"),\n             aes(x = x, y = y), shape = 17, size = 5, color = \"#f59e0b\") +\n  # 标签\n  geom_text(data = tree_data,\n            aes(x = x, y = y, label = label),\n            hjust = -0.1, vjust = 0.5, size = 3.5) +\n  # 添加结果数值\n  annotate(\"text\", x = 2.8, y = 5.5, \n           label = paste0(\"成本: \", comma(params$c_standard + params$c_success), \n                          \"\\nQALY: \", params$time_horizon * params$u_success),\n           hjust = 0, size = 3, color = \"gray30\") +\n  annotate(\"text\", x = 2.8, y = 3.5,\n           label = paste0(\"成本: \", comma(params$c_standard + params$c_failure),\n                          \"\\nQALY: \", params$time_horizon * params$u_failure),\n           hjust = 0, size = 3, color = \"gray30\") +\n  annotate(\"text\", x = 2.8, y = 2.5,\n           label = paste0(\"成本: \", comma(params$c_new + params$c_success),\n                          \"\\nQALY: \", params$time_horizon * params$u_success),\n           hjust = 0, size = 3, color = \"gray30\") +\n  annotate(\"text\", x = 2.8, y = 0.5,\n           label = paste0(\"成本: \", comma(params$c_new + params$c_failure),\n                          \"\\nQALY: \", params$time_horizon * params$u_failure),\n           hjust = 0, size = 3, color = \"gray30\") +\n  labs(title = \"治疗决策树模型\") +\n  theme_void() +\n  theme(plot.title = element_text(hjust = 0.5, face = \"bold\", size = 14)) +\n  xlim(-0.5, 4) +\n  ylim(-0.5, 6.5)\n```\n\n---\n\n## 马尔可夫模型\n\n### 模型概述\n\n马尔可夫模型是卫生经济学中最常用的建模方法，用于模拟疾病进展和干预效果。\n\n```{r}\n# 定义模型参数\nmarkov_params <- list(\n  # 状态名称\n  states = c(\"健康\", \"疾病\", \"死亡\"),\n  n_states = 3,\n  \n  # 周期数（年）\n  n_cycles = 20,\n  \n  # 转移概率（标准治疗）\n  p_healthy_disease_std = 0.10,\n  p_disease_death_std = 0.15,\n  \n  # 转移概率（新治疗）\n  p_healthy_disease_new = 0.05,\n  p_disease_death_new = 0.10,\n  \n  # 成本（每周期）\n  c_healthy = 1000,\n  c_disease = 8000,\n  c_death = 0,\n  c_new_treatment = 5000,  # 新治疗额外成本\n  \n  # 效用\n  u_healthy = 1.0,\n  u_disease = 0.6,\n  u_death = 0,\n  \n  # 贴现率\n  discount_rate = 0.03\n)\n```\n\n### 构建转移概率矩阵\n\n```{r}\n# 标准治疗转移矩阵\ntrans_matrix_std <- matrix(c(\n  0.89, 0.10, 0.01,  # 从健康状态\n  0.00, 0.84, 0.16,  # 从疾病状态（含背景死亡）\n  0.00, 0.00, 1.00   # 从死亡状态\n), nrow = 3, byrow = TRUE)\n\nrownames(trans_matrix_std) <- colnames(trans_matrix_std) <- markov_params$states\n\n# 新治疗转移矩阵\ntrans_matrix_new <- matrix(c(\n  0.94, 0.05, 0.01,  # 从健康状态\n  0.00, 0.89, 0.11,  # 从疾病状态\n  0.00, 0.00, 1.00   # 从死亡状态\n), nrow = 3, byrow = TRUE)\n\nrownames(trans_matrix_new) <- colnames(trans_matrix_new) <- markov_params$states\n\ntrans_matrix_std\n```\n\n### 运行马尔可夫模拟\n\n```{r}\n# 马尔可夫模拟函数\nrun_markov <- function(trans_matrix, params, treatment_cost = 0) {\n  n_cycles <- params$n_cycles\n  states <- params$states\n  \n  # 初始状态分布（100% 健康）\n  state_dist <- matrix(0, nrow = n_cycles + 1, ncol = 3)\n  colnames(state_dist) <- states\n  state_dist[1, ] <- c(1, 0, 0)\n  \n  # 成本和效用向量\n  costs <- c(params$c_healthy, params$c_disease, params$c_death)\n  utilities <- c(params$u_healthy, params$u_disease, params$u_death)\n  \n  # 贴现因子\n  discount_factors <- (1 / (1 + params$discount_rate)) ^ (0:n_cycles)\n  \n  # 模拟各周期\n  for (i in 1:n_cycles) {\n    state_dist[i + 1, ] <- state_dist[i, ] %*% trans_matrix\n  }\n  \n  # 计算成本和 QALY\n  cycle_costs <- state_dist %*% costs + treatment_cost\n  cycle_qalys <- state_dist %*% utilities\n  \n  # 贴现后总计\n  total_cost <- sum(cycle_costs * discount_factors)\n  total_qaly <- sum(cycle_qalys * discount_factors)\n  \n  list(\n    state_dist = state_dist,\n    total_cost = total_cost,\n    total_qaly = total_qaly,\n    cycle_costs = cycle_costs,\n    cycle_qalys = cycle_qalys\n  )\n}\n\n# 运行两种治疗方案\nresults_std <- run_markov(trans_matrix_std, markov_params, treatment_cost = 0)\nresults_new <- run_markov(trans_matrix_new, markov_params, treatment_cost = markov_params$c_new_treatment)\n```\n\n### 状态分布可视化\n\n```{r fig.width=10, fig.height=5}\n# 整理状态分布数据\nprepare_state_data <- function(results, treatment_name) {\n  data.frame(\n    Cycle = rep(0:markov_params$n_cycles, 3),\n    State = rep(markov_params$states, each = markov_params$n_cycles + 1),\n    Proportion = as.vector(results$state_dist),\n    Treatment = treatment_name\n  )\n}\n\nstate_data <- bind_rows(\n  prepare_state_data(results_std, \"标准治疗\"),\n  prepare_state_data(results_new, \"新治疗\")\n)\n\n# 绘制状态转移图\nggplot(state_data, aes(x = Cycle, y = Proportion, fill = State)) +\n  geom_area(alpha = 0.8) +\n  facet_wrap(~Treatment) +\n  scale_fill_manual(values = c(\"#10b981\", \"#f59e0b\", \"#6b7280\")) +\n  scale_y_continuous(labels = percent_format()) +\n  labs(\n    title = \"马尔可夫模型状态分布\",\n    x = \"周期（年）\",\n    y = \"人群比例\",\n    fill = \"健康状态\"\n  ) +\n  theme_bw(base_size = 12) +\n  theme(\n    legend.position = \"bottom\",\n    plot.title = element_text(hjust = 0.5, face = \"bold\"),\n    strip.background = element_rect(fill = \"#4f46e5\"),\n    strip.text = element_text(color = \"white\", face = \"bold\")\n  )\n```\n\n### 马尔可夫模型结果汇总\n\n```{r}\n# 汇总结果\nmarkov_summary <- data.frame(\n  Strategy = c(\"标准治疗\", \"新治疗\"),\n  Total_Cost = c(results_std$total_cost, results_new$total_cost),\n  Total_QALY = c(results_std$total_qaly, results_new$total_qaly)\n) |>\n  mutate(\n    Delta_Cost = Total_Cost - Total_Cost[1],\n    Delta_QALY = Total_QALY - Total_QALY[1],\n    ICER = ifelse(Delta_QALY > 0, Delta_Cost / Delta_QALY, NA)\n  )\n\nmarkov_summary\n```\n\n---\n\n## 单因素敏感性分析\n\n### 龙卷风图\n\n龙卷风图展示各参数对结果的影响程度。\n\n```{r fig.width=9, fig.height=6}\n# 定义参数范围\nsensitivity_params <- data.frame(\n  Parameter = c(\n    \"疾病转移概率 (标准)\",\n    \"死亡转移概率 (标准)\",\n    \"疾病转移概率 (新)\",\n    \"死亡转移概率 (新)\",\n    \"疾病状态成本\",\n    \"新治疗成本\",\n    \"贴现率\"\n  ),\n  Base = c(0.10, 0.15, 0.05, 0.10, 8000, 5000, 0.03),\n  Low = c(0.05, 0.10, 0.03, 0.05, 5000, 3000, 0.00),\n  High = c(0.15, 0.20, 0.08, 0.15, 12000, 8000, 0.05)\n)\n\n# 模拟敏感性分析结果（简化演示）\nset.seed(123)\ntornado_data <- sensitivity_params |>\n  mutate(\n    ICER_low = runif(n(), 15000, 35000),\n    ICER_high = runif(n(), 35000, 55000),\n    ICER_base = 32000\n  ) |>\n  arrange(desc(abs(ICER_high - ICER_low)))\n\n# 绘制龙卷风图\nggplot(tornado_data) +\n  geom_segment(aes(y = reorder(Parameter, abs(ICER_high - ICER_low)),\n                   yend = reorder(Parameter, abs(ICER_high - ICER_low)),\n                   x = ICER_low, xend = ICER_high),\n               linewidth = 8, color = \"#4f46e5\", alpha = 0.7) +\n  geom_vline(xintercept = tornado_data$ICER_base[1], \n             linetype = \"dashed\", color = \"red\", linewidth = 1) +\n  scale_x_continuous(labels = comma_format()) +\n  labs(\n    title = \"龙卷风图 - 单因素敏感性分析\",\n    subtitle = \"红色虚线: 基准 ICER\",\n    x = \"ICER (元/QALY)\",\n    y = \"参数\"\n  ) +\n  theme_bw(base_size = 12) +\n  theme(\n    plot.title = element_text(hjust = 0.5, face = \"bold\"),\n    panel.grid.major.y = element_blank()\n  )\n```\n\n---\n\n## 成本效果前沿\n\n### 效率前沿线\n\n效率前沿展示在给定成本下可达到的最大效果。\n\n```{r}\n# 创建多策略数据\nfrontier_data <- data.frame(\n  Strategy = c(\"无干预\", \"方案A\", \"方案B\", \"方案C\", \"方案D\", \"方案E\"),\n  Cost = c(10000, 30000, 45000, 60000, 90000, 100000),\n  QALY = c(4.0, 5.5, 6.2, 6.8, 7.8, 7.9)\n)\n\n# 识别效率前沿上的策略（简化算法）\nfrontier_data <- frontier_data |>\n  arrange(Cost) |>\n  mutate(\n    on_frontier = c(TRUE, TRUE, TRUE, FALSE, TRUE, FALSE)  # 手动标记\n  )\n\nggplot(frontier_data, aes(x = QALY, y = Cost)) +\n  # 绘制效率前沿线\n  geom_line(data = frontier_data |> filter(on_frontier),\n            color = \"#4f46e5\", linewidth = 1.2) +\n  # 所有点\n  geom_point(aes(color = on_frontier), size = 5) +\n  # 标签\n  geom_text(aes(label = Strategy), vjust = -1, size = 3.5) +\n  scale_color_manual(values = c(\"TRUE\" = \"#10b981\", \"FALSE\" = \"#ef4444\"),\n                     labels = c(\"TRUE\" = \"效率前沿\", \"FALSE\" = \"被支配\")) +\n  scale_y_continuous(labels = comma_format()) +\n  labs(\n    title = \"成本效果效率前沿\",\n    x = \"质量调整生命年 (QALY)\",\n    y = \"成本 (元)\",\n    color = \"策略状态\"\n  ) +\n  theme_bw(base_size = 12) +\n  theme(\n    legend.position = \"bottom\",\n    plot.title = element_text(hjust = 0.5, face = \"bold\")\n  )\n```\n\n---\n\n## 净货币收益分析\n\n### NMB 计算与可视化\n\n净货币收益（Net Monetary Benefit）：$$NMB = WTP \\times \\Delta QALY - \\Delta Cost$$\n\n```{r}\n# 计算不同 WTP 下的 NMB\nwtp_values <- seq(0, 100000, by = 10000)\n\nnmb_data <- expand.grid(\n  WTP = wtp_values,\n  Strategy = c(\"标准治疗\", \"新药A\", \"新药B\")\n) |>\n  left_join(cea_data, by = \"Strategy\") |>\n  mutate(\n    NMB = WTP * QALY - Cost\n  )\n\nggplot(nmb_data, aes(x = WTP, y = NMB, color = Strategy)) +\n  geom_line(linewidth = 1.2) +\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"gray50\") +\n  scale_x_continuous(labels = comma_format()) +\n  scale_y_continuous(labels = comma_format()) +\n  scale_color_manual(values = c(\"#4f46e5\", \"#10b981\", \"#f59e0b\")) +\n  labs(\n    title = \"净货币收益 (NMB) 分析\",\n    x = \"支付意愿 (WTP, 元/QALY)\",\n    y = \"净货币收益 (元)\",\n    color = \"治疗方案\"\n  ) +\n  theme_bw(base_size = 12) +\n  theme(\n    legend.position = \"bottom\",\n    plot.title = element_text(hjust = 0.5, face = \"bold\")\n  )\n```\n\n---\n\n## 实用函数封装\n\n### ICER 计算函数\n\n```{r}\n#' 计算 ICER\n#' @param cost_new 新治疗成本\n#' @param cost_ref 参照治疗成本\n#' @param effect_new 新治疗效果\n#' @param effect_ref 参照治疗效果\n#' @return ICER 值\ncalculate_icer <- function(cost_new, cost_ref, effect_new, effect_ref) {\n  delta_cost <- cost_new - cost_ref\n  delta_effect <- effect_new - effect_ref\n  \n  if (delta_effect <= 0) {\n    warning(\"增量效果 <= 0，新治疗可能被支配\")\n    return(NA)\n  }\n  \n  icer <- delta_cost / delta_effect\n  \n  cat(\"增量成本:\", comma(delta_cost), \"元\\n\")\n  cat(\"增量效果:\", round(delta_effect, 3), \"QALY\\n\")\n  cat(\"ICER:\", comma(round(icer, 0)), \"元/QALY\\n\")\n  \n  invisible(icer)\n}\n\n# 示例\ncalculate_icer(\n  cost_new = 80000, cost_ref = 50000,\n  effect_new = 6.8, effect_ref = 5.2\n)\n```\n\n---\n\n## 总结\n\n卫生经济学评价是医疗决策的重要工具，R 语言提供了强大的分析能力：\n\n| 分析类型 | 关键指标 | 推荐方法 |\n|----------|----------|----------|\n| 成本效果分析 | ICER | 增量分析、效率前沿 |\n| 不确定性分析 | CEAC、龙卷风图 | 概率敏感性分析 |\n| 疾病建模 | 状态分布、生存曲线 | 马尔可夫模型、决策树 |\n| 决策支持 | NMB | 净货币收益分析 |\n\n### 推荐学习资源\n\n- [DARTH 工作组](https://darthworkgroup.com/) - 决策分析建模教程\n- [ISPOR 指南](https://www.ispor.org/) - 卫生经济学方法学标准\n- [R for Health Technology Assessment](https://r-hta.org/) - R 语言 HTA 资源\n\n### 常用 WTP 阈值参考\n\n| 国家/地区 | WTP 阈值（每 QALY） |\n|-----------|---------------------|\n| 中国 | 1-3 倍人均 GDP（约 7-21 万元） |\n| 英国 (NICE) | £20,000-30,000 |\n| 美国 | $50,000-150,000 |\n| WHO 推荐 | 1-3 倍人均 GDP |\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"wrap","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"toc-depth":3,"css":["styles.css"],"highlight-style":"github","output-file":"1015-health-economics.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.7.32","theme":{"light":["cosmo","theme.scss"]},"toc-title":"目录","toc-location":"right","code-copy":true,"smooth-scroll":true,"page-layout":"full","title":"R语言卫生经济学分析","date":"2026-01-10","categories":["R语言方法","卫生经济学","成本效果分析"],"image":"figure/health-economics-cover.png"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}