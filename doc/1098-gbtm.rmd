---
title: 基于群组的轨迹模型 (GBTM) 完全指南
date: '2026-01-20'
categories:
- 统计分析方法
- 高级建模
- 纵向数据
- 轨迹分析
image: images/1098_cover.svg
description: 介绍 GBTM 的建模逻辑、模型选择与结果解读，使用 lcmm 包实现轨迹分组与可视化。
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 8,
  fig.height = 5.5,
  dpi = 150
)
```

## 方法背景与适用场景

基于群组的轨迹模型 (Group-Based Trajectory Modeling, GBTM) 用于在纵向数据中识别具有相似变化轨迹的潜在人群亚组。它将个体的时间变化模式看作由若干个潜在群组生成，适合回答“人群中是否存在不同的趋势模式？”“这些模式如何与结局相关？”等问题。

GBTM 在公共卫生、医学随访、心理发展、教育学等领域常用于识别不同的随访路径，例如随访期间血压变化轨迹、症状缓解轨迹或行为模式演变轨迹。

## 模型入门与核心概念

GBTM 可以理解为“纵向数据上的潜类别模型”，核心要点包括：

- 轨迹群组：每个群组对应一条平均轨迹曲线。
- 类别概率：每个受试者属于不同群组的后验概率。
- 轨迹形状：线性、二次、三次等多项式形式。
- 模型选择：通过 BIC、AIC、熵、组内比例和可解释性共同判断。

与传统的混合效应模型相比，GBTM 重点在于发现离散的轨迹亚群而不是单一平均趋势。

## 模型假设与前提

GBTM 的关键假设包括：

1. 受试者属于有限个潜在轨迹群组之一。
2. 每个群组内部轨迹具有相同的函数形式（如线性或二次）。
3. 观测误差在群组内独立且符合模型指定分布（如高斯）。
4. 组内个体差异可通过随机效应或误差项刻画。

在实践中需要检查：

- 轨迹阶数是否合理（线性/二次/三次）。
- 群组数量是否过多导致小群组样本过少。
- 模型是否收敛与可解释。

## 数据准备与变量定义

GBTM 的数据通常是长格式 (long format)：

- `id`：个体编号。
- `time`：时间变量（随访次数或时间点）。
- `y`：连续型结局（如评分、指标）。

在示例中使用模拟数据构建 3 个潜在轨迹群组。

## 分析流程步骤

下面是一个常用的 GBTM 分析流程：

1. 探索性检查：查看每个个体的趋势曲线与总体分布。
2. 拟合单群组模型 (ng = 1) 作为基线。
3. 逐步增加群组数量并比较 BIC/AIC。
4. 评估群组规模与熵值，确保分类清晰。
5. 输出后验概率与群组分配。
6. 可视化群组轨迹并进行命名解释。

### 方法选择决策表

| 判断维度 | 推荐标准 | 解释 |
|---|---|---|
| BIC | 越小越好 | 对模型复杂度惩罚更强 |
| AIC | 越小越好 | 倾向选择更复杂模型 |
| 熵 | > 0.7 | 分类清晰度 |
| 最小群组比例 | > 5% | 避免过小群组 |
| 解释性 | 可解释 | 与学科知识一致 |

## 代码实现

### 1. 准备模拟数据

```{r simulate-data}
set.seed(42)

n_id <- 300
time_points <- 0:5

# 三个潜在群组
class_prob <- c(0.4, 0.35, 0.25)
class_id <- sample(1:3, size = n_id, replace = TRUE, prob = class_prob)

sim_data <- expand.grid(
  id = 1:n_id,
  time = time_points
)

sim_data$class <- class_id[sim_data$id]

# 设定不同轨迹
sim_data$y <- dplyr::case_when(
  sim_data$class == 1 ~ 5 + 0.6 * sim_data$time + rnorm(nrow(sim_data), 0, 0.8),
  sim_data$class == 2 ~ 8 - 0.4 * sim_data$time + rnorm(nrow(sim_data), 0, 0.8),
  sim_data$class == 3 ~ 3 + 1.2 * sim_data$time - 0.15 * sim_data$time^2 + rnorm(nrow(sim_data), 0, 0.8)
)

head(sim_data)
```

### 2. 初步可视化

```{r quick-plot}
library(ggplot2)

sample_ids <- sample(unique(sim_data$id), 40)
plot_data <- sim_data[sim_data$id %in% sample_ids, ]

ggplot(plot_data, aes(x = time, y = y, group = id)) +
  geom_line(alpha = 0.4, color = "#2563eb") +
  geom_point(alpha = 0.4, color = "#1d4ed8") +
  labs(
    title = "个体纵向轨迹示例",
    x = "时间",
    y = "结局变量"
  ) +
  theme_minimal()
```

### 3. 拟合 GBTM 模型

这里使用 `lcmm` 包中的 `hlme()` 拟合 GBTM。

```{r install-lcmm, eval=FALSE}
install.packages("lcmm")
```

```{r fit-gbtm}
library(lcmm)

# 基线模型：单群组
model_1 <- hlme(
  fixed = y ~ time,
  random = ~ time,
  subject = "id",
  ng = 1,
  data = sim_data
)

# 三群组模型：使用 gridsearch 自动搜索最佳初值
# gridsearch 从 model_1 生成多组随机初值，选择收敛最优的一组
model_3 <- gridsearch(
  m = hlme(
    fixed = y ~ time,
    mixture = ~ time,
    random = ~ time,
    subject = "id",
    ng = 3,
    nwg = TRUE,
    data = sim_data
  ),
  rep = 30,
  maxiter = 15,
  minit = model_1
)

summary(model_3)
```

### 4. 模型比较

```{r model-compare}
model_compare <- data.frame(
  model = c("ng=1", "ng=3"),
  AIC = c(model_1$AIC, model_3$AIC),
  BIC = c(model_1$BIC, model_3$BIC),
  logLik = c(model_1$loglik, model_3$loglik)
)

model_compare
```

### 5. 后验概率与分类质量

```{r posterior-prob}
post_prob <- model_3$pprob
head(post_prob)

# 计算熵
posterior_matrix <- as.matrix(post_prob[, grep("prob", names(post_prob))])
entropy <- -rowSums(posterior_matrix * log(posterior_matrix + 1e-12))
relative_entropy <- 1 - mean(entropy) / log(ncol(posterior_matrix))
relative_entropy
```

### 6. 轨迹可视化

```{r traj-plot}
pred_time <- data.frame(time = seq(min(sim_data$time), max(sim_data$time), length.out = 50))
pred <- predictY(model_3, newdata = pred_time, var.time = "time", draws = FALSE)

pred_df <- data.frame(
  time = rep(pred_time$time, model_3$ng),
  y = as.vector(pred$pred),
  class = factor(rep(1:model_3$ng, each = nrow(pred_time)))
)

ggplot(pred_df, aes(x = time, y = y, color = class)) +
  geom_line(size = 1.1) +
  labs(
    title = "GBTM 估计轨迹",
    x = "时间",
    y = "结局变量",
    color = "轨迹组"
  ) +
  theme_minimal()
```

## 结果解读与报告

报告时需明确：

- 群组数量与选择理由（BIC、熵、比例）。
- 各群组轨迹形态（上升、下降、倒 U）。
- 群组比例与后验概率均值。

示例表述：

> 识别出 3 个轨迹群组：上升型 (40%)、下降型 (35%) 与倒 U 型 (25%)。BIC 最小且相对熵为 0.78，说明分类质量良好。

## 常见错误与纠偏

| 问题 | 可能原因 | 处理建议 |
|---|---|---|
| 模型不收敛 | 初值不佳、阶数过高 | 降低阶数或调整 `B` 初值 |
| 群组过小 | 过度划分 | 减少群组数量 |
| 轨迹不合理 | 阶数选择错误 | 尝试线性与二次模型比较 |
| 熵值过低 | 群组区分度差 | 增加或减少群组数，重新建模 |

## 进阶扩展

- 引入协变量预测群组归属：使用 `classmb` 参数。
- 连续结局以外的模型：`lcmm` 支持二项、计数型结局扩展。
- 对比增长混合模型 (GMM)：允许更丰富的随机效应结构。

## 参考文献

- Nagin, D. S. (2005). Group-Based Modeling of Development. Harvard University Press.
- Proust-Lima, C., et al. (2017). Joint latent class mixed models. *Statistical Methods in Medical Research*, 26(1), 74-89.
- lcmm package documentation: <https://cran.r-project.org/package=lcmm>
