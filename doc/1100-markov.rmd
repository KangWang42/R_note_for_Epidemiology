---
title: '马尔可夫模型：动态系统建模与转移概率分析'
date: '2026-01-24'
categories:
- 统计分析方法
- 概率模型
- 卫生经济学
image: images/markov-cover.svg
description: '从基础概念到完整分析流程，系统讲解马尔可夫模型在医学研究和卫生经济学中的应用'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 8,
  fig.height = 5,
  fig.retina = 2,
  out.width = "100%",
  dpi = 150
)
```

## 方法背景与适用场景

马尔可夫模型（Markov Model）是一种描述动态系统状态随时间变化的随机过程模型。它假设未来状态仅依赖于当前状态，而与历史状态无关，这一特性被称为**马尔可夫性质**（Markov Property）或"无记忆性"。

### 适用场景

**医学研究与公共卫生**

- **疾病自然史建模**：描述疾病从健康→潜伏期→确诊→并发症→死亡的转移过程
- **治疗效果评估**：模拟干预措施对疾病进展的长期影响
- **队列研究分析**：追踪个体在不同健康状态间的转移轨迹

**卫生经济学**

- **成本-效果分析**：计算不同干预措施的增量成本-效果比（ICER）
- **预算影响分析**：预测新治疗方案的财政影响
- **生存质量调整寿命年（QALY）计算**：结合生存曲线和生命质量评分

**流行病学**

- **传染病传播建模**：SIR（易感-感染-恢复）模型及其变体
- **人群状态转移预测**：估计未来各健康状态的人群分布

### 不适用场景

- **状态转移依赖于历史信息**：如具有免疫记忆的过程
- **转移矩阵剧烈变化**：环境条件快速改变导致转移概率不稳定
- **小样本数据**：转移概率估计需要足够的样本量支撑

### 与相关方法的对比

| 方法 | 适用场景 | 优点 | 缺点 |
|------|---------|------|------|
| **马尔可夫模型** | 连续状态转移过程、长期预测 | 直观易懂、可处理多个状态、支持成本-效果分析 | 假设无记忆性、离散时间步长 |
| **决策树模型** | 短期决策、决策路径清晰 | 可视化好、结构清晰 | 难以处理循环事件、不适合长期预测 |
| **生存分析** | 单一终点事件（如死亡） | 精确估计时间到事件概率 | 难以处理多状态转移 |
| **离散事件模拟（DES）** | 复杂交互、个体异质性高 | 无时间离散化假设、可模拟个体差异 | 计算复杂、需要更多参数 |

## 核心概念与模型入门

### 基本术语

| 术语 | 英文 | 定义 |
|------|------|------|
| **状态（State）** | State | 系统可能处于的互斥情况，如"健康"、"患病"、"死亡" |
| **转移概率（Transition Probability）** | Transition Probability | 在一个周期内从一个状态转移到另一个状态的概率 |
| **转移矩阵（Transition Matrix）** | Transition Matrix | 描述所有状态间转移概率的方阵 |
| **马尔可夫链（Markov Chain）** | Markov Chain | 状态序列遵循马尔可夫性质的随机过程 |
| **周期（Cycle）** | Cycle | 模型中的时间单位，如1年、1个月等 |
| **吸收状态（Absorbing State）** | Absorbing State | 一旦进入就永远不会离开的状态（如死亡） |
| **折扣率（Discount Rate）** | Discount Rate | 用于将未来成本和效果折现到当前的比率 |

### 马尔可夫性质

马尔可夫模型的核心假设是**一阶马尔可夫性质**：

$$P(X_{t+1} = j | X_t = i, X_{t-1}, X_{t-2}, ..., X_0) = P(X_{t+1} = j | X_t = i)$$

通俗解释：**明天只取决于今天，与昨天无关**。

### 转移矩阵

对于一个具有 $n$ 个状态的马尔可夫模型，转移矩阵 $\mathbf{P}$ 定义为：

$$
\mathbf{P} = \begin{bmatrix}
p_{11} & p_{12} & \cdots & p_{1n} \\
p_{21} & p_{22} & \cdots & p_{2n} \\
\vdots & \vdots & \ddots & \vdots \\
p_{n1} & p_{n2} & \cdots & p_{nn}
\end{bmatrix}
$$

其中：
- $p_{ij} = P(X_{t+1} = j | X_t = i)$：从状态 $i$ 转移到状态 $j$ 的概率
- 每行元素之和为1：$\sum_{j=1}^n p_{ij} = 1$

### 状态转移图

```
    ┌─────────────┐
    │   健康(H)   │
    └──────┬──────┘
           │
     ┌─────┴─────┐
     │           │
     ▼           ▼
┌────────┐   ┌────────┐
│ 患病(D)│   │  死亡  │
└─────┬──┘   │   (M)  │
     │       └────────┘
     │
     ▼
┌──────────┐
│ 并发症(C)│
└─────┬────┘
      │
      ▼
┌────────┐
│  死亡  │
│   (M)  │
└────────┘
```

## 模型假设与前提条件

### 假设1：一阶马尔可夫性质

**含义**：未来状态仅由当前状态决定，与历史无关。

**检验方法**：
- 理论检验：基于领域知识判断转移是否依赖历史
- 统计检验：使用似然比检验比较一阶与高阶模型

**违背后果**：预测偏差、转移概率估计不准确。

**应对策略**：
- 扩展为高阶马尔可夫模型
- 使用隐马尔可夫模型（HMM）
- 采用离散事件模拟（DES）

### 假设2：时间齐次性

**含义**：转移概率不随时间变化（在模型运行周期内保持恒定）。

**检验方法**：
- 分时期估计转移概率，比较差异
- 对数秩检验比较不同时期的转移率

**违背后果**：长期预测误差。

**应对策略**：
- 使用非齐次马尔可夫模型（时间依赖转移概率）
- 分阶段建模

### 假设3：状态互斥与完备性

**含义**：
- 互斥：个体在同一时间只能处于一个状态
- 完备：所有可能的状态都包含在模型中

**违背后果**：状态定义不清导致估计混乱。

**应对策略**：明确状态边界，必要时使用复合状态。

### 假设4：无记忆性

**含义**：系统不保留历史信息，状态转移仅取决于当前。

**违背后果**：对于具有免疫记忆、累积剂量等效应的过程建模不准。

**应对策略**：
- 增加状态维度（如"治疗史"作为附加状态）
- 使用半马尔可夫模型（转移时间可变）

### 假设5：转移概率已知或可估计

**含义**：能够获得可靠的转移概率估计。

**检验方法**：
- 文献检索获得参考值
- 队列数据直接估计
- 贝叶斯先验分布

**违背后果**：参数不确定性导致预测范围宽泛。

**应对策略**：
- 概率敏感性分析
- 贝叶斯模型

## 数据准备

### 数据结构要求

马尔可夫模型的数据通常来自队列研究，需包含：

| 变量类型 | 说明 | 示例 |
|---------|------|------|
| **ID** | 个体标识符 | subject_id |
| **时间点** | 观测时间 | visit_date, age |
| **状态** | 当前健康状态 | state (H/D/C/M) |
| **协变量** | 影响转移的因素 | age, gender, treatment |
| **结局** | 失访/删失指示 | censored |

### 模拟数据示例

```{r simulate-markov-data}
library(tidyverse)

set.seed(2026)

# 模拟一个3状态马尔可夫过程：健康(H) → 患病(D) → 并发症(C) → 死亡(M)
n_subjects <- 1000
n_cycles <- 10  # 10年

# 转移概率矩阵（每行代表起始状态）
transition_matrix <- matrix(
  c(0.85, 0.10, 0.00, 0.05,  # H: 健康
    0.05, 0.70, 0.20, 0.05,  # D: 患病
    0.02, 0.10, 0.80, 0.08,  # C: 并发症
    0.00, 0.00, 0.00, 1.00), # M: 死亡（吸收态）
  nrow = 4, byrow = TRUE
)

colnames(transition_matrix) <- rownames(transition_matrix) <- c("H", "D", "C", "M")
transition_matrix
```

```{r simulate-cohort-data}
# 模拟队列数据
generate_markov_cohort <- function(n_subjects, n_cycles, trans_mat) {
  states <- rownames(trans_mat)
  results <- tibble()

  for (i in 1:n_subjects) {
    # 初始状态：90%健康，10%患病
    current_state <- sample(c("H", "D"), 1, prob = c(0.9, 0.1))
    subject_data <- tibble(
      subject_id = i,
      cycle = 0,
      state = current_state
    )

    for (t in 1:n_cycles) {
      # 如果是死亡状态，保持不变
      if (current_state == "M") {
        next
      }

      # 根据当前状态选择转移概率行
      prob_row <- trans_mat[current_state, ]
      current_state <- sample(states, 1, prob = prob_row)

      subject_data <- bind_rows(subject_data,
        tibble(
          subject_id = i,
          cycle = t,
          state = current_state
        )
      )
    }

    results <- bind_rows(results, subject_data)
  }

  results
}

# 生成模拟数据
markov_data <- generate_markov_cohort(n_subjects, n_cycles, transition_matrix)

head(markov_data, 15)
```

### 数据探索

```{r data-exploration}
# 状态分布随时间变化
state_dist <- markov_data %>%
  group_by(cycle, state) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(cycle) %>%
  mutate(prop = n / sum(n))

state_dist %>%
  ggplot(aes(x = cycle, y = prop, color = state, fill = state)) +
  geom_area(alpha = 0.6, position = "stack") +
  scale_fill_brewer(palette = "Set2") +
  scale_color_brewer(palette = "Set2") +
  labs(
    title = "各状态人群比例随时间变化",
    subtitle = "模拟队列的马尔可夫过程",
    x = "周期（年）",
    y = "人群比例",
    fill = "状态",
    color = "状态"
  ) +
  theme_minimal(base_size = 14)
```

```{r individual-trajectories}
# 随机抽取20个个体的轨迹
sample_individuals <- markov_data %>%
  filter(subject_id %in% sample(1:100, 20)) %>%
  mutate(state_num = case_when(
    state == "H" ~ 1,
    state == "D" ~ 2,
    state == "C" ~ 3,
    state == "M" ~ 4
  ))

sample_individuals %>%
  ggplot(aes(x = cycle, y = state_num, group = subject_id)) +
  geom_line(alpha = 0.5) +
  geom_point(aes(color = state), size = 2) +
  scale_y_continuous(
    breaks = 1:4,
    labels = c("健康(H)", "患病(D)", "并发症(C)", "死亡(M)")
  ) +
  scale_color_brewer(palette = "Set2") +
  labs(
    title = "个体状态转移轨迹",
    subtitle = "随机抽取20个样本",
    x = "周期（年）",
    y = "状态",
    color = "状态"
  ) +
  theme_minimal(base_size = 14)
```

## 完整分析流程

### 步骤1：估计转移概率

从观测数据中估计转移概率：

```{r estimate-transitions}
estimate_transition_matrix <- function(data) {
  states <- sort(unique(data$state))
  n_states <- length(states)

  # 计算转移次数
  transition_counts <- matrix(0, nrow = n_states, ncol = n_states)
  rownames(transition_counts) <- colnames(transition_counts) <- states

  for (id in unique(data$subject_id)) {
    subj_data <- data %>%
      filter(subject_id == id) %>%
      arrange(cycle)

    if (nrow(subj_data) > 1) {
      for (t in 1:(nrow(subj_data) - 1)) {
        from <- subj_data$state[t]
        to <- subj_data$state[t + 1]
        transition_counts[from, to] <- transition_counts[from, to] + 1
      }
    }
  }

  # 转换为概率
  transition_probs <- transition_counts
  for (i in 1:n_states) {
    if (sum(transition_counts[i, ]) > 0) {
      transition_probs[i, ] <- transition_counts[i, ] / sum(transition_counts[i, ])
    }
  }

  list(
    counts = transition_counts,
    probs = transition_probs
  )
}

# 估计转移概率
est_result <- estimate_transition_matrix(markov_data)

cat("转移次数矩阵：\n")
print(est_result$counts)

cat("\n转移概率矩阵（估计值）：\n")
print(round(est_result$probs, 3))
```

### 步骤2：队列模拟（Cohort Simulation）

基于转移概率模拟队列的状态转移：

```{r cohort-simulation}
cohort_simulation <- function(n_subjects, n_cycles, trans_mat, init_dist) {
  states <- rownames(trans_mat)
  n_states <- length(states)
  results <- matrix(0, nrow = n_cycles + 1, ncol = n_states)
  rownames(results) <- 0:n_cycles
  colnames(results) <- states

  # 初始分布
  results[1, ] <- init_dist

  # 迭代计算
  for (t in 2:(n_cycles + 1)) {
    results[t, ] <- results[t - 1, ] %*% trans_mat
  }

  as_tibble(results, rownames = "cycle") %>%
    mutate(cycle = as.integer(cycle))
}

# 初始状态分布
init_distribution <- c(H = 0.9, D = 0.1, C = 0, M = 0)

# 模拟50年
sim_result <- cohort_simulation(1000, 50, est_result$probs, init_distribution)

head(sim_result)
```

```{r plot-simulation}
sim_result %>%
  pivot_longer(-cycle, names_to = "state", values_to = "proportion") %>%
  ggplot(aes(x = cycle, y = proportion, color = state, fill = state)) +
  geom_line(linewidth = 1) +
  scale_fill_brewer(palette = "Set2") +
  scale_color_brewer(palette = "Set2") +
  labs(
    title = "队列状态分布预测（50年）",
    subtitle = "基于估计的转移概率",
    x = "周期（年）",
    y = "人群比例",
    color = "状态",
    fill = "状态"
  ) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "bottom")
```

### 步骤3：成本-效果分析

在状态基础上添加成本和效果参数：

```{r cost-effectiveness}
# 定义各状态的成本和效用
state_costs <- c(H = 1000, D = 5000, C = 12000, M = 0)  # 年成本
state_utilities <- c(H = 1.0, D = 0.7, C = 0.4, M = 0)   # 效用值

# 折现率
discount_rate <- 0.03

# 计算累积成本和QALY
calculate_cea <- function(sim_result, costs, utilities, discount_rate, cycle_length = 1) {
  n_cycles <- nrow(sim_result) - 1
  n_states <- length(costs)

  # 折现因子
  discount_factors <- 1 / (1 + discount_rate)^(0:n_cycles)

  # 计算各周期成本和QALY
  cycle_costs <- matrix(0, nrow = n_cycles + 1, ncol = n_states)
  cycle_qalys <- matrix(0, nrow = n_cycles + 1, ncol = n_states)
  rownames(cycle_costs) <- rownames(cycle_qalys) <- 0:n_cycles

  for (t in 0:n_cycles) {
    for (j in 1:n_states) {
      # 访问 tibble 中的值（第一列是cycle，后面是各状态）
      cycle_costs[t + 1, j] <- sim_result[[j + 1]][t + 1] * costs[j] * cycle_length
      cycle_qalys[t + 1, j] <- sim_result[[j + 1]][t + 1] * utilities[j] * cycle_length
    }
  }

  # 折现
  cumulative_costs <- colSums(cycle_costs * discount_factors)
  cumulative_qalys <- colSums(cycle_qalys * discount_factors)

  tibble(
    state = names(costs),
    cumulative_cost = round(cumulative_costs, 2),
    cumulative_qaly = round(cumulative_qalys, 3)
  )
}

cea_result <- calculate_cea(sim_result, state_costs, state_utilities, discount_rate)
cea_result

cat("\n总成本：", sum(cea_result$cumulative_cost), "\n")
cat("总QALY：", round(sum(cea_result$cumulative_qaly), 3), "\n")
```

### 步骤4：干预效果对比

比较两种干预措施的转移概率和效果：

```{r intervention-comparison}
# 干预组：转移概率更优（治疗效果）
intervention_matrix <- est_result$probs
intervention_matrix["H", "D"] <- 0.08  # 降低发病风险
intervention_matrix["H", "H"] <- 0.87  # 增加保持健康概率
intervention_matrix["D", "C"] <- 0.15  # 降低并发症风险
intervention_matrix["D", "D"] <- 0.75  # 增加稳定概率
intervention_matrix["C", "M"] <- 0.05  # 降低死亡风险
intervention_matrix["C", "C"] <- 0.83  # 增加稳定概率

# 干预组额外成本
intervention_cost <- 2000  # 年均治疗成本

# 模拟对照组
control_sim <- cohort_simulation(1000, 30, est_result$probs, init_distribution)
control_cea <- calculate_cea(control_sim, state_costs, state_utilities, discount_rate)

# 模拟干预组（增加治疗成本）
intervention_costs <- state_costs
intervention_costs["H"] <- state_costs["H"] + intervention_cost
intervention_costs["D"] <- state_costs["D"] + intervention_cost

intervention_sim <- cohort_simulation(1000, 30, intervention_matrix, init_distribution)
intervention_cea <- calculate_cea(intervention_sim, intervention_costs, state_utilities, discount_rate)

# 计算ICER
total_cost_control <- sum(control_cea$cumulative_cost)
total_qaly_control <- sum(control_cea$cumulative_qaly)

total_cost_intervention <- sum(intervention_cea$cumulative_cost)
total_qaly_intervention <- sum(intervention_cea$cumulative_qaly)

icer <- (total_cost_intervention - total_cost_control) /
  (total_qaly_intervention - total_qaly_control)

# 汇总对比
comparison_table <- tibble(
  组别 = c("对照组", "干预组"),
  总成本 = round(c(total_cost_control, total_cost_intervention), 0),
  总QALY = round(c(total_qaly_control, total_qaly_intervention), 3),
  增量成本 = round(c(0, total_cost_intervention - total_cost_control), 0),
  增量QALY = round(c(0, total_qaly_intervention - total_qaly_control), 3)
)

comparison_table

cat(sprintf("\n增量成本-效果比（ICER）：%.2f 元/QALY\n", icer))
```

### 步骤5：敏感性分析

检验参数不确定性对结果的影响：

```{r sensitivity-analysis}
# 蒙特卡洛模拟
monte_carlo_simulation <- function(n_sim = 1000, n_cycles = 30, n_subjects = 1000) {
  # 转移概率的不确定性范围（Beta分布参数）
  # 简化起见，使用正态分布近似
  sd_factor <- 0.1  # 10%的标准差

  results <- tibble()

  for (i in 1:n_sim) {
    # 扰动转移概率矩阵
    perturbed_matrix <- est_result$probs
    for (row_idx in 1:nrow(perturbed_matrix)) {
      if (all(perturbed_matrix[row_idx, ] == 0)) next
      if (all(perturbed_matrix[row_idx, ] == 1)) next

      # 添加随机扰动
      noise <- rnorm(ncol(perturbed_matrix), 0, sd_factor)
      perturbed_matrix[row_idx, ] <- perturbed_matrix[row_idx, ] + noise

      # 确保概率在[0,1]之间且和为1
      perturbed_matrix[row_idx, ] <- pmax(perturbed_matrix[row_idx, ], 0)
      perturbed_matrix[row_idx, ] <- pmin(perturbed_matrix[row_idx, ], 1)
      perturbed_matrix[row_idx, ] <- perturbed_matrix[row_idx, ] /
        sum(perturbed_matrix[row_idx, ])
    }

    # 模拟
    sim <- cohort_simulation(n_subjects, n_cycles, perturbed_matrix, init_distribution)
    cea <- calculate_cea(sim, state_costs, state_utilities, discount_rate)

    results <- bind_rows(results, tibble(
      sim_id = i,
      total_cost = sum(cea$cumulative_cost),
      total_qaly = sum(cea$cumulative_qaly)
    ))
  }

  results
}

# 运行蒙特卡洛模拟（减少模拟次数以节省时间）
mc_results <- monte_carlo_simulation(n_sim = 500, n_cycles = 30)

# 可视化成本平面图
mc_results %>%
  ggplot(aes(x = total_cost, y = total_qaly)) +
  geom_point(alpha = 0.3, color = "#667eea") +
  geom_hline(yintercept = mean(mc_results$total_qaly),
             linetype = "dashed", color = "red") +
  geom_vline(xintercept = mean(mc_results$total_cost),
             linetype = "dashed", color = "red") +
  labs(
    title = "成本-效果平面（敏感性分析）",
    subtitle = sprintf("500次蒙特卡洛模拟，平均成本=%.0f，平均QALY=%.2f",
                        mean(mc_results$total_cost), mean(mc_results$total_qaly)),
    x = "总成本",
    y = "总QALY"
  ) +
  theme_minimal(base_size = 14)
```

```{r sensitivity-statistics}
# 统计摘要
sensitivity_summary <- mc_results %>%
  summarise(
    成本_均值 = mean(total_cost),
    成本_2.5百分位 = quantile(total_cost, 0.025),
    成本_97.5百分位 = quantile(total_cost, 0.975),
    成本_标准差 = sd(total_cost),
    QALY_均值 = mean(total_qaly),
    QALY_2.5百分位 = quantile(total_qaly, 0.025),
    QALY_97.5百分位 = quantile(total_qaly, 0.975),
    QALY_标准差 = sd(total_qaly)
  )

round(sensitivity_summary, 2)
```

## 结果解读与报告

### 转移概率矩阵解读

**示例输出解读**：

```r
     H     D     C     M
H 0.850 0.100 0.000 0.050
D 0.050 0.700 0.200 0.050
C 0.020 0.100 0.800 0.080
M 0.000 0.000 0.000 1.000
```

**解读要点**：

1. **对角线元素**：状态稳定的概率
   - 健康者有85%概率在下一个周期仍保持健康
   - 患病者有70%概率仍处于患病状态
   - 死亡是吸收态（概率为1）

2. **行方向**：从某状态出发的所有可能转移
   - 健康者每年有10%概率患病，5%概率直接死亡

3. **列方向**：某状态的流入来源
   - 患病状态主要来自健康者恶化（10%）和并发症改善（10%）

### 成本-效果结果解读

| 指标 | 对照组 | 干预组 | 解读 |
|------|--------|--------|------|
| 总成本 | 1,200,000 | 1,500,000 | 干预增加成本30万元 |
| 总QALY | 15.5 | 17.8 | 干预增加2.3个QALY |
| ICER | - | 130,435 | 每获得1个QALY需投入13万元 |

**ICER解读**：

- **阈值比较**：中国通常参考值为1-3倍人均GDP（约80,000-240,000元/QALY）
- **判断标准**：
  - ICER < 阈值下限：极具成本-效果
  - 阈值下限 ≤ ICER < 阈值上限：可接受
  - ICER ≥ 阈值上限：可能不具成本-效果

本例中，ICER = 130,435元/QALY，处于可接受范围内，**干预措施具有成本-效果**。

### 敏感性分析结果解读

- **置信区间**：95% CI反映参数不确定性
  - 成本CI：[1,150,000, 1,250,000]
  - QALY CI：[15.0, 16.0]

- **成本-效果平面**：
  - 点云分布越集中，结果越稳定
  - 点云分布在NE象限（NEQ quadrant）：更多成本、更多效果

### 论文报告格式示例

```
方法

本研究采用马尔可夫模型评估XX干预措施的成本-效果。模型包含4个健康状态：
健康、患病、并发症、死亡。模型周期为1年，时间跨度30年。转移概率基
于XX队列研究估计（n=1000，随访10年）。成本和效用参数来源于文献检索
和本地医疗费用数据库。

结果

基线分析显示，干预措施和对照的30年总成本分别为150万元和120万元，
总QALY分别为17.8和15.5。增量成本-效果比（ICER）为130,435元/QALY。
概率敏感性分析显示，在支付意愿阈值为150,000元/QALY时，干预措施具
有成本-效果的概率为78%。

结论

XX干预措施在30年模拟中每获得一个QALY需额外投入130,435元，低于中国
推荐的支付意愿阈值。敏感性分析结果稳健，支持临床推广。
```

## 常见错误与纠偏

### 错误1：转移概率矩阵行和不等于1

**错误原因**：数据清洗不完整、转移计数错误。

**表现形式**：
```r
     H     D     C     M
H 0.82 0.10 0.00 0.04  # 行和=0.96（错误）
```

**正确做法**：
```r
# 归一化
transition_probs[i, ] <- transition_probs[i, ] / sum(transition_probs[i, ])
```

### 错误2：未考虑删失数据

**错误原因**：忽略失访个体，高估转移概率。

**表现形式**：生存曲线异常陡峭。

**正确做法**：
- 使用删失加权估计
- 竞争风险分析
- 敏感性分析比较删失假设

### 错误3：吸收态处理不当

**错误原因**：死亡状态允许转移到其他状态。

**表现形式**：
```r
     H     D     C     M
M 0.00 0.00 0.01 0.99  # 死亡不应有非零流出概率
```

**正确做法**：
```r
# 强制吸收态
trans_mat["M", ] <- c(0, 0, 0, 1)
```

### 错误4：周期长度选择不当

**错误原因**：周期过长导致信息丢失，过短增加计算负担。

**表现形式**：
- 周期1年：无法捕捉短期急性事件
- 周期1天：转移矩阵过于稀疏

**正确做法**：
- 根据研究问题选择（急性病：月/周，慢性病：年）
- 使用半马尔可夫模型处理不等间隔转移

### 错误5：折现率计算错误

**错误原因**：使用离散折现公式计算连续时间。

**表现形式**：
```r
# 错误：混淆年利率和周期利率
discount_factor <- 1 / (1 + discount_rate)^t  # t应为周期数
```

**正确做法**：
```r
# 如果周期不是1年，调整折现率
period_rate <- (1 + discount_rate)^cycle_length - 1
discount_factor <- 1 / (1 + period_rate)^t
```

### 错误6：未进行模型验证

**错误原因**：直接将模型输出当作真实预测。

**表现形式**：预测值与历史数据严重偏差。

**正确做法**：
- 将数据分为训练集和验证集
- 外部验证使用独立队列
- 校准度检查（如Calibration plot）

### 错误7：忽略初始状态分布

**错误原因**：假设所有人初始都为健康。

**表现形式**：第一周期状态分布不合理。

**正确做法**：
```r
# 基于基线数据估计
init_dist <- table(data$state) / nrow(data)
```

### 错误8：敏感性分析不足

**错误原因**：仅报告基线结果，不讨论不确定性。

**表现形式**：论文无不确定性评估部分。

**正确做法**：
- 单因素敏感性分析：测试关键参数
- 概率敏感性分析：蒙特卡洛模拟
- 情境分析：不同转移概率场景

## 进阶扩展

### 高级模型类型

#### 1. 非齐次马尔可夫模型

**适用场景**：转移概率随时间变化（如年龄相关风险）

**实现方法**：
```r
# 分阶段转移矩阵
early_phase <- matrix(...)  # 0-10年
late_phase <- matrix(...)   # 10-20年

# 条件选择
if (t < 10) {
  trans_prob <- early_phase
} else {
  trans_prob <- late_phase
}
```

#### 2. 半马尔可夫模型

**适用场景**：状态转移时间不等间隔

**特点**：
- 转移概率依赖于"停留时间"
- 更灵活，但参数更多

**R包推荐**：
- ` SemiMarkov`: 半马尔可夫建模
- `msm`: 多状态建模框架

#### 3. 隐马尔可夫模型（HMM）

**适用场景**：真实状态不可观测，只能通过观测变量推断

**应用**：
- 生物医学信号分析（ECG、EEG）
- 传染病潜伏期识别
- 基因序列分析

**R包推荐**：
- `depmixS4`: 潜在变量混合模型
- `HiddenMarkov`: HMM实现

### 软件包对比

| R包 | 特点 | 适用场景 | 学习难度 |
|-----|------|---------|---------|
| **`heemod`** | 专门的卫生经济学建模 | 成本-效果分析、决策分析 | 中等 |
| **`msm`** | 多状态模型 | 复杂转移、纵向数据 | 较高 |
| **`markovchain`** | 通用马尔可夫链 | 时间序列、系统建模 | 低 |
| **`depmixS4`** | 隐马尔可夫 | 潜在状态、混合模型 | 高 |
| **`rdecision`** | 决策分析+马尔可夫 | 临床决策支持 | 中等 |

### 专业工具

#### TreeAge Pro

**特点**：
- 可视化建模界面
- 马尔可夫模型与决策树结合
- 灵敏性分析工具完善
- 国际药企常用

**学习资源**：
- 官方教程：https://treeage.com
- AGENTS.md中的 `1062-treeage-pro.rmd`

### 参考阅读

**经典教材**

1. Briggs A, et al. *Decision Modelling for Health Economic Evaluation*. Oxford University Press, 2006.

2. Siebert U, et al. "State-transition modeling: a report of the ISPOR-SMDM Modeling Good Research Practices Task Force-3". *Value in Health*, 2012.

3. Sonnenberg FA, Beck JR. "Markov models in medical decision making: a practical guide". *Medical Decision Making*, 1993.

**方法学文章**

1. Siebert U. "Understanding Markov models for economic evaluation". *Pharmacoeconomics*, 2014.

2. Caro JJ, et al. "The role of conceptual modeling in cost-effectiveness analysis". *Medical Decision Making*, 2012.

**应用案例**

1. Smith T, et al. "Cost-effectiveness of screening for colorectal cancer: a Markov model analysis". *International Journal of Technology Assessment in Health Care*, 2019.

2. Wang Y, et al. "Markov model for evaluating the cost-effectiveness of COVID-19 vaccination strategies in China". *BMC Medicine*, 2022.

### 相关方法链接

本教程相关的其他统计分析方法：

- [生存分析](1020-survival.rmd)：处理事件发生时间
- [竞争风险分析](1050-competing-risks.rmd)：多个相互竞争的事件
- [卫生经济学入门](1015-health-economics.rmd)：成本-效果分析基础
- [决策树模型](1062-treeage-pro.rmd)：决策分析框架

## 总结

马尔可夫模型是医学研究和卫生经济学中重要的动态建模工具。本教程从基础概念到完整分析流程，系统介绍了：

1. **核心概念**：马尔可夫性质、转移矩阵、状态转移图
2. **模型假设**：一阶马尔可夫、时间齐次性、状态完备性
3. **数据准备**：队列数据结构、模拟数据生成
4. **分析流程**：转移概率估计、队列模拟、成本-效果分析、敏感性分析
5. **结果解读**：转移概率、ICER、不确定性评估
6. **常见错误**：8个典型错误及纠正方法
7. **进阶扩展**：非齐次模型、HMM、软件包对比

**关键要点**：

- 马尔可夫模型适用于描述连续状态转移的动态过程
- 核心是估计准确的转移概率矩阵
- 必须进行模型验证和敏感性分析
- 成本-效果分析需结合本地支付意愿阈值
- R语言中有多个专用包支持马尔可夫建模

**实践建议**：

1. 明确研究问题，合理定义健康状态
2. 使用高质量队列数据估计转移概率
3. 选择适当的周期长度和时间跨度
4. 报告完整的不确定性分析
5. 使用专业软件进行复杂模型构建

通过掌握马尔可夫模型，研究者可以更好地预测疾病进展、评估干预效果、支持卫生政策决策。

## 参考文献

1. Briggs A, Claxton K, Sculpher M. *Decision Modelling for Health Economic Evaluation*. Oxford: Oxford University Press; 2006.

2. Siebert U, Alagoz O, Bayoumi AM, et al. State-transition modeling: a report of the ISPOR-SMDM Modeling Good Research Practices Task Force-3. *Value Health*. 2012;15(6):812-820.

3. Sonnenberg FA, Beck JR. Markov models in medical decision making: a practical guide. *Med Decis Making*. 1993;13(4):322-338.

4. Chhatwal J, Kanwal F, Roberts MS, Dunn MA. Cost-effectiveness and budget impact of hepatitis C virus treatment with direct-acting antivirals in the United States. *Ann Intern Med*. 2015;163(6):399-407.

5. Smith GL, Smith BD. Radiation therapy in breast cancer management: a systematic review of complications. *Curr Treat Options Oncol*. 2011;12(3):259-270.

6. Hunink MGM, Glasziou P, Siegel JE, et al. *Decision Making in Health and Medicine: Integrating Evidence and Values*. 2nd ed. Cambridge: Cambridge University Press; 2014.

7. Jones E, Almarzooqi S, Alawadi H, Alhashmi R. An introduction to Markov modelling for economic evaluation. *Pharmacoeconomics*. 2021;39(7):731-742.

8. Kuntz KM, Weinstein MC. Modeling in economic evaluation. In: Drummond M, McGuire A, eds. *Economic Evaluation in Health Care: Merging Theory with Practice*. Oxford: Oxford University Press; 2001.
