{
  "hash": "ed68e711495953f81ca8a6603f45154d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"热图绑制完全指南\"\ndate: \"2025-01-10\"\ncategories: [可视化, 热图, ComplexHeatmap]\nimage: \"figure/heatmap-cover.png\"\ndraft: true\n---\n\n\n\n热图是展示矩阵数据的强大工具，广泛用于基因表达、相关性分析、聚类结果展示等场景。本文从基础到高级，全面介绍 R 语言热图绑制。\n\n## 热图包概览\n\n| 包名 | 特点 | 适用场景 |\n|------|------|----------|\n| `pheatmap` | 简单易用，自动聚类 | 快速出图、基础需求 |\n| `ComplexHeatmap` | 功能最强大，可高度定制 | 复杂注释、多热图组合 |\n| `heatmaply` | 交互式热图 | 网页展示、数据探索 |\n| `ggplot2 + geom_tile` | 与ggplot生态兼容 | 简单热图、自定义样式 |\n\n## 数据准备\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ComplexHeatmap)  # 最强大的热图包\nlibrary(circlize)        # 配色工具\nlibrary(RColorBrewer)    # 经典配色\nlibrary(viridis)         # 现代配色\n\n# 模拟基因表达数据：30个基因 × 20个样本\nset.seed(42)\nmat <- matrix(rnorm(600), nrow = 30, ncol = 20)\nrownames(mat) <- paste0(\"Gene\", 1:30)\ncolnames(mat) <- paste0(\"Sample\", 1:20)\n\n# 添加一些模式（模拟差异表达）\nmat[1:10, 1:10] <- mat[1:10, 1:10] + 3      # 组1高表达\nmat[11:20, 11:20] <- mat[11:20, 11:20] + 3  # 组2高表达\n```\n:::\n\n\n## 基础热图\n\n### ComplexHeatmap 基础\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 最简单的热图\nHeatmap(mat, name = \"表达量\")\n```\n\n::: {.cell-output-display}\n![](2020-heatmap_files/figure-html/unnamed-chunk-2-1.png){width=100%}\n:::\n:::\n\n\n### 关闭聚类\n\n\n::: {.cell}\n\n```{.r .cell-code}\nHeatmap(mat, \n        name = \"表达量\",\n        cluster_rows = FALSE,    # 关闭行聚类\n        cluster_columns = FALSE) # 关闭列聚类\n```\n\n::: {.cell-output-display}\n![](2020-heatmap_files/figure-html/unnamed-chunk-3-1.png){width=100%}\n:::\n:::\n\n\n## 配色方案\n\n配色是热图最重要的元素之一。\n\n### 连续型配色\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 蓝-白-红（经典差异表达配色）\ncol_bwr <- colorRamp2(c(-3, 0, 3), c(\"blue\", \"white\", \"red\"))\n\n# 紫-白-橙（对比更强）\ncol_pwo <- colorRamp2(c(-3, 0, 3), c(\"purple\", \"white\", \"orange\"))\n\n# viridis（色盲友好）\ncol_viridis <- colorRamp2(seq(-3, 3, length = 100), viridis(100))\n\n# 对比展示\np1 <- Heatmap(mat, name = \"蓝白红\", col = col_bwr, \n              show_row_names = FALSE, show_column_names = FALSE)\np2 <- Heatmap(mat, name = \"viridis\", col = col_viridis,\n              show_row_names = FALSE, show_column_names = FALSE)\np1 + p2\n```\n\n::: {.cell-output-display}\n![](2020-heatmap_files/figure-html/unnamed-chunk-4-1.png){width=100%}\n:::\n:::\n\n\n### 预设配色方案\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# RColorBrewer 调色板\ndisplay.brewer.all(type = \"div\")  # 查看分歧型调色板\n```\n\n::: {.cell-output-display}\n![](2020-heatmap_files/figure-html/unnamed-chunk-5-1.png){width=100%}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 使用 RColorBrewer\ncol_rdbu <- colorRamp2(seq(-3, 3, length = 11), \n                       rev(brewer.pal(11, \"RdBu\")))\n\nHeatmap(mat, name = \"RdBu\", col = col_rdbu,\n        column_title = \"RColorBrewer: RdBu\")\n```\n\n::: {.cell-output-display}\n![](2020-heatmap_files/figure-html/unnamed-chunk-6-1.png){width=100%}\n:::\n:::\n\n\n## 聚类设置\n\n### 聚类方法\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 不同聚类方法对比\nHeatmap(mat, name = \"ward.D2\",\n        clustering_method_rows = \"ward.D2\",    # Ward法\n        clustering_method_columns = \"complete\", # 完全连接法\n        column_title = \"Ward.D2 行聚类 + Complete 列聚类\")\n```\n\n::: {.cell-output-display}\n![](2020-heatmap_files/figure-html/unnamed-chunk-7-1.png){width=100%}\n:::\n:::\n\n\n常用聚类方法：\n\n- `ward.D2`：方差最小化，产生紧凑聚类\n- `complete`：最远邻法，产生紧凑聚类\n- `average`：平均连接法，折中选择\n- `single`：最近邻法，易产生链式聚类\n\n### 距离度量\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 使用相关距离（基因表达常用）\nHeatmap(mat, name = \"相关距离\",\n        clustering_distance_rows = \"pearson\",   # 皮尔逊相关\n        clustering_distance_columns = \"spearman\", # 斯皮尔曼相关\n        column_title = \"基于相关性的聚类\")\n```\n\n::: {.cell-output-display}\n![](2020-heatmap_files/figure-html/unnamed-chunk-8-1.png){width=100%}\n:::\n:::\n\n\n距离选项：`euclidean`, `pearson`, `spearman`, `kendall`, `manhattan`\n\n### 树状图美化\n\n\n::: {.cell}\n\n```{.r .cell-code}\nHeatmap(mat, name = \"表达量\",\n        row_dend_width = unit(2, \"cm\"),      # 行树状图宽度\n        column_dend_height = unit(2, \"cm\"),  # 列树状图高度\n        row_dend_gp = gpar(col = \"#4f46e5\"), # 树状图颜色\n        column_dend_gp = gpar(col = \"#ef4444\", lwd = 2))\n```\n\n::: {.cell-output-display}\n![](2020-heatmap_files/figure-html/unnamed-chunk-9-1.png){width=100%}\n:::\n:::\n\n\n## 行列注释\n\n注释是 ComplexHeatmap 最强大的功能。\n\n### 简单注释\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 样本分组注释\nsample_group <- rep(c(\"Treatment\", \"Control\"), each = 10)\ngene_cluster <- rep(c(\"Cluster1\", \"Cluster2\", \"Cluster3\"), each = 10)\n\n# 顶部注释\ntop_anno <- HeatmapAnnotation(\n  Group = sample_group,\n  col = list(Group = c(\"Treatment\" = \"#e63946\", \"Control\" = \"#457b9d\"))\n)\n\n# 左侧注释\nleft_anno <- rowAnnotation(\n  Cluster = gene_cluster,\n  col = list(Cluster = c(\"Cluster1\" = \"#f4a261\", \n                         \"Cluster2\" = \"#2a9d8f\", \n                         \"Cluster3\" = \"#264653\"))\n)\n\nHeatmap(mat, name = \"表达量\",\n        top_annotation = top_anno,\n        left_annotation = left_anno)\n```\n\n::: {.cell-output-display}\n![](2020-heatmap_files/figure-html/unnamed-chunk-10-1.png){width=100%}\n:::\n:::\n\n\n### 多类型注释\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 丰富的注释类型\nset.seed(42)\ntop_anno <- HeatmapAnnotation(\n  # 分类变量\n  Group = sample_group,\n  # 连续变量（条形图）\n  Age = anno_barplot(runif(20, 20, 60), height = unit(1, \"cm\")),\n  # 连续变量（点图）\n  Score = anno_points(rnorm(20, 50, 10)),\n  # 自定义颜色\n  col = list(Group = c(\"Treatment\" = \"#e63946\", \"Control\" = \"#457b9d\")),\n  # 间距\n  gap = unit(2, \"mm\")\n)\n\nHeatmap(mat, name = \"表达量\", \n        top_annotation = top_anno,\n        column_title = \"多类型注释示例\")\n```\n\n::: {.cell-output-display}\n![](2020-heatmap_files/figure-html/unnamed-chunk-11-1.png){width=100%}\n:::\n:::\n\n\n### 行注释（右侧）\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 基因功能注释\npathway <- sample(c(\"Metabolism\", \"Signaling\", \"Cell Cycle\"), 30, replace = TRUE)\nlog2fc <- rnorm(30, 0, 2)\n\nright_anno <- rowAnnotation(\n  Pathway = pathway,\n  Log2FC = anno_barplot(log2fc, \n                        gp = gpar(fill = ifelse(log2fc > 0, \"#e63946\", \"#457b9d\")),\n                        width = unit(2, \"cm\")),\n  col = list(Pathway = c(\"Metabolism\" = \"#f4a261\", \n                         \"Signaling\" = \"#2a9d8f\", \n                         \"Cell Cycle\" = \"#e9c46a\"))\n)\n\nHeatmap(mat, name = \"表达量\",\n        right_annotation = right_anno,\n        show_row_names = FALSE)\n```\n\n::: {.cell-output-display}\n![](2020-heatmap_files/figure-html/unnamed-chunk-12-1.png){width=100%}\n:::\n:::\n\n\n## 分割热图\n\n### 按聚类分割\n\n\n::: {.cell}\n\n```{.r .cell-code}\nHeatmap(mat, name = \"表达量\",\n        row_split = 3,      # 行分成3组\n        column_split = 2,   # 列分成2组\n        row_title = \"基因组 %s\",\n        column_title = \"样本组 %s\")\n```\n\n::: {.cell-output-display}\n![](2020-heatmap_files/figure-html/unnamed-chunk-13-1.png){width=100%}\n:::\n:::\n\n\n### 按变量分割\n\n\n::: {.cell}\n\n```{.r .cell-code}\nHeatmap(mat, name = \"表达量\",\n        row_split = gene_cluster,\n        column_split = sample_group,\n        row_gap = unit(3, \"mm\"),\n        column_gap = unit(3, \"mm\"))\n```\n\n::: {.cell-output-display}\n![](2020-heatmap_files/figure-html/unnamed-chunk-14-1.png){width=100%}\n:::\n:::\n\n\n## 热图组合\n\nComplexHeatmap 支持多个热图的灵活组合。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 准备第二个数据\nmat2 <- matrix(rnorm(150), nrow = 30, ncol = 5)\ncolnames(mat2) <- paste0(\"Feature\", 1:5)\nrownames(mat2) <- rownames(mat)\n\n# 水平组合\nht1 <- Heatmap(mat, name = \"表达量\", col = col_bwr,\n               show_column_names = FALSE, width = unit(8, \"cm\"))\nht2 <- Heatmap(mat2, name = \"特征\", col = viridis(100),\n               width = unit(3, \"cm\"))\n\nht1 + ht2  # 使用 + 水平组合\n```\n\n::: {.cell-output-display}\n![](2020-heatmap_files/figure-html/unnamed-chunk-15-1.png){width=100%}\n:::\n:::\n\n\n### 垂直组合\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmat3 <- matrix(rnorm(200), nrow = 10, ncol = 20)\nrownames(mat3) <- paste0(\"Protein\", 1:10)\ncolnames(mat3) <- colnames(mat)\n\nht_main <- Heatmap(mat, name = \"mRNA\", col = col_bwr,\n                   show_row_names = FALSE)\nht_protein <- Heatmap(mat3, name = \"Protein\", col = col_bwr,\n                      height = unit(3, \"cm\"))\n\nht_main %v% ht_protein  # 使用 %v% 垂直组合\n```\n\n::: {.cell-output-display}\n![](2020-heatmap_files/figure-html/unnamed-chunk-16-1.png){width=100%}\n:::\n:::\n\n\n## 文字与标签\n\n### 行列名样式\n\n\n::: {.cell}\n\n```{.r .cell-code}\nHeatmap(mat[1:15, 1:10], name = \"表达量\",\n        # 行名设置\n        row_names_side = \"left\",           # 行名位置\n        row_names_gp = gpar(fontsize = 10, # 字体大小\n                           fontface = \"italic\", # 斜体\n                           col = \"#333333\"),\n        # 列名设置  \n        column_names_side = \"top\",\n        column_names_rot = 45,             # 旋转角度\n        column_names_gp = gpar(fontsize = 9))\n```\n\n::: {.cell-output-display}\n![](2020-heatmap_files/figure-html/unnamed-chunk-17-1.png){width=100%}\n:::\n:::\n\n\n### 在单元格内显示数值\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsmall_mat <- mat[1:8, 1:6]\n\nHeatmap(small_mat, name = \"表达量\",\n        # 显示数值\n        cell_fun = function(j, i, x, y, width, height, fill) {\n          grid.text(sprintf(\"%.1f\", small_mat[i, j]), x, y, \n                    gp = gpar(fontsize = 8, col = \"black\"))\n        })\n```\n\n::: {.cell-output-display}\n![](2020-heatmap_files/figure-html/unnamed-chunk-18-1.png){width=100%}\n:::\n:::\n\n\n### 只显示显著值\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 只在 |值| > 2 时显示\nHeatmap(small_mat, name = \"表达量\",\n        cell_fun = function(j, i, x, y, width, height, fill) {\n          val <- small_mat[i, j]\n          if (abs(val) > 2) {\n            grid.text(sprintf(\"%.1f\", val), x, y,\n                      gp = gpar(fontsize = 8, \n                                col = ifelse(abs(val) > 2.5, \"white\", \"black\"),\n                                fontface = \"bold\"))\n          }\n        })\n```\n\n::: {.cell-output-display}\n![](2020-heatmap_files/figure-html/unnamed-chunk-19-1.png){width=100%}\n:::\n:::\n\n\n## 图例定制\n\n\n::: {.cell}\n\n```{.r .cell-code}\nHeatmap(mat, name = \"表达量\", col = col_bwr,\n        # 图例设置\n        heatmap_legend_param = list(\n          title = \"Log2 表达量\",\n          title_position = \"topleft\",\n          legend_height = unit(4, \"cm\"),\n          labels_gp = gpar(fontsize = 10),\n          title_gp = gpar(fontsize = 12, fontface = \"bold\"),\n          at = c(-3, 0, 3),        # 刻度位置\n          labels = c(\"低\", \"中\", \"高\")  # 刻度标签\n        ),\n        show_row_names = FALSE,\n        show_column_names = FALSE)\n```\n\n::: {.cell-output-display}\n![](2020-heatmap_files/figure-html/unnamed-chunk-20-1.png){width=100%}\n:::\n:::\n\n\n## pheatmap 快速出图\n\n如果只需要快速出图，`pheatmap` 更简洁：\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(pheatmap)\n\n# 一行代码快速热图\npheatmap(mat, \n         color = colorRampPalette(c(\"blue\", \"white\", \"red\"))(100),\n         scale = \"row\",                    # 按行标准化\n         clustering_method = \"ward.D2\",\n         show_rownames = FALSE,\n         annotation_col = data.frame(\n           Group = sample_group,\n           row.names = colnames(mat)\n         ),\n         main = \"pheatmap 快速热图\")\n```\n\n::: {.cell-output-display}\n![](2020-heatmap_files/figure-html/unnamed-chunk-21-1.png){width=100%}\n:::\n:::\n\n\n## ggplot2 热图\n\n对于简单热图，ggplot2 也是好选择：\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nlibrary(tidyr)\nlibrary(dplyr)\n\n# 转换为长格式\nmat_long <- mat[1:15, 1:10] |> \n  as.data.frame() |> \n  mutate(Gene = rownames(mat)[1:15]) |> \n  pivot_longer(-Gene, names_to = \"Sample\", values_to = \"Expression\")\n\nggplot(mat_long, aes(x = Sample, y = Gene, fill = Expression)) +\n  geom_tile(color = \"white\", linewidth = 0.5) +\n  scale_fill_gradient2(low = \"#457b9d\", mid = \"white\", high = \"#e63946\",\n                       midpoint = 0, name = \"表达量\") +\n  theme_minimal() +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +\n  labs(title = \"ggplot2 热图\", x = NULL, y = NULL)\n```\n\n::: {.cell-output-display}\n![](2020-heatmap_files/figure-html/unnamed-chunk-22-1.png){width=100%}\n:::\n:::\n\n\n## 相关性热图\n\n常见应用：展示变量间相关性。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 计算相关矩阵\ncor_mat <- cor(mat)\n\n# 只显示下三角\ncor_mat[upper.tri(cor_mat)] <- NA\n\nHeatmap(cor_mat, name = \"相关系数\",\n        col = colorRamp2(c(-1, 0, 1), c(\"#2166ac\", \"white\", \"#b2182b\")),\n        na_col = \"white\",  # NA显示为白色\n        cluster_rows = FALSE,\n        cluster_columns = FALSE,\n        cell_fun = function(j, i, x, y, width, height, fill) {\n          val <- cor_mat[i, j]\n          if (!is.na(val) && abs(val) > 0.5) {\n            grid.text(sprintf(\"%.2f\", val), x, y, \n                      gp = gpar(fontsize = 6))\n          }\n        },\n        column_title = \"相关性热图（下三角）\")\n```\n\n::: {.cell-output-display}\n![](2020-heatmap_files/figure-html/unnamed-chunk-23-1.png){width=100%}\n:::\n:::\n\n\n## 实战：基因表达热图\n\n完整的基因表达热图示例：\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 模拟完整数据\nset.seed(123)\nexpr_mat <- matrix(rnorm(500), nrow = 50, ncol = 10)\nrownames(expr_mat) <- paste0(\"Gene\", 1:50)\ncolnames(expr_mat) <- paste0(\"S\", 1:10)\nexpr_mat[1:20, 1:5] <- expr_mat[1:20, 1:5] + 2  # 添加差异\n\n# 样本注释\nsample_info <- data.frame(\n  Condition = rep(c(\"Case\", \"Control\"), each = 5),\n  Batch = rep(c(\"B1\", \"B2\"), 5)\n)\n\n# 基因注释\ngene_info <- data.frame(\n  Type = sample(c(\"Up\", \"Down\", \"NS\"), 50, replace = TRUE,\n                prob = c(0.3, 0.3, 0.4)),\n  Pathway = sample(c(\"KEGG1\", \"KEGG2\", \"KEGG3\"), 50, replace = TRUE)\n)\n\n# 构建完整热图\nht <- Heatmap(\n  expr_mat,\n  name = \"Z-score\",\n  col = colorRamp2(c(-2, 0, 2), c(\"#2166ac\", \"white\", \"#b2182b\")),\n  \n  # 聚类\n  clustering_distance_rows = \"pearson\",\n  clustering_method_rows = \"ward.D2\",\n  row_split = 3,\n  column_split = sample_info$Condition,\n  \n  # 注释\n  top_annotation = HeatmapAnnotation(\n    Condition = sample_info$Condition,\n    Batch = sample_info$Batch,\n    col = list(\n      Condition = c(\"Case\" = \"#e63946\", \"Control\" = \"#457b9d\"),\n      Batch = c(\"B1\" = \"#f4a261\", \"B2\" = \"#2a9d8f\")\n    ),\n    annotation_name_side = \"left\"\n  ),\n  \n  left_annotation = rowAnnotation(\n    Type = gene_info$Type,\n    col = list(Type = c(\"Up\" = \"#e63946\", \"Down\" = \"#457b9d\", \"NS\" = \"grey\"))\n  ),\n  \n  right_annotation = rowAnnotation(\n    Pathway = gene_info$Pathway,\n    col = list(Pathway = c(\"KEGG1\" = \"#264653\", \"KEGG2\" = \"#e9c46a\", \n                           \"KEGG3\" = \"#f4a261\"))\n  ),\n  \n  # 外观\n  show_row_names = FALSE,\n  column_names_rot = 45,\n  row_title_gp = gpar(fontsize = 10),\n  column_title_gp = gpar(fontsize = 10),\n  \n  # 图例\n  heatmap_legend_param = list(\n    title = \"Z-score\",\n    legend_height = unit(4, \"cm\")\n  )\n)\n\ndraw(ht, heatmap_legend_side = \"right\", annotation_legend_side = \"right\")\n```\n\n::: {.cell-output-display}\n![](2020-heatmap_files/figure-html/unnamed-chunk-24-1.png){width=100%}\n:::\n:::\n\n\n## 保存热图\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 保存为PDF（推荐，矢量格式）\npdf(\"heatmap.pdf\", width = 10, height = 8)\ndraw(ht)\ndev.off()\n\n# 保存为PNG\npng(\"heatmap.png\", width = 10, height = 8, units = \"in\", res = 300)\ndraw(ht)\ndev.off()\n\n# 使用 ComplexHeatmap 内置函数\nht <- draw(ht)\nsave_pdf(ht, \"heatmap.pdf\", width = 10, height = 8)\n```\n:::\n\n\n## 总结\n\n| 任务 | 推荐方案 |\n|------|----------|\n| 快速出图 | `pheatmap` |\n| 复杂注释 | `ComplexHeatmap` |\n| 交互式 | `heatmaply` |\n| ggplot生态 | `geom_tile()` |\n\n:::{.callout-tip}\n**最佳实践**：\n\n1. 标准化数据（scale by row/column）后再绑图\n2. 配色选择对比度高的发散型调色板\n3. 聚类前考虑数据特点选择合适的距离和方法\n4. 注释要简洁明了，不要过度堆砌\n5. 导出时使用矢量格式（PDF）保证清晰度\n:::\n",
    "supporting": [
      "2020-heatmap_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}