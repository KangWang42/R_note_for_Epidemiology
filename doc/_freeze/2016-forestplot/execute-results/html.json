{
  "hash": "858828746dc46d7adfb0515ea16ed15f",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"R语言绘制森林图详细教程-forestplot\"\ndate: \"2024-10-20\"\ncategories: [可视化, 森林图]\nimage: \"figure/forestplot-cover.png\"\n---\n\n\n\n> 本期主要介绍如何使用forestplot包绘制森林图，常用于meta分析的可视化\n>\n> 根据我的教程书写体验来看forestplot包**还很不好用**，基于gpar包来设置样式，使用体验极不好，不过写都写了，发一点东西\n> \n> 根据实际体验来看还是**forestploter包绘制森林图更好看**，代码更合理，样式也更好看，之后会介绍\n> \n> 这期不建议看，这个**包也不建议用**，连教程文档很多都跑不动\n> \n\n## R包介绍\n\nforestplot包是R语言中用于绘制森林图的包，其主要功能是将数据整理成适合绘制森林图的格式，并提供了丰富的绘图选项，使得用户可以轻松地绘制出各种类型的森林图。\n\n[更多教程](https://cran.r-project.org/web//packages/forestplot/vignettes/forestplot.html)\n\n## R包安装\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages(\"forestplot\")\n```\n:::\n\n\n## R包教程\n\n### 载入包\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(forestplot)\nlibrary(dplyr)\n```\n:::\n\n\n### 导入数据\n\n- mean: OR区间的平均值\n- lower/upper：置信区间上下限\n- study：标签\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- tibble::tibble(\n  mean = c(0.578, 0.165, 0.246, 0.700, 0.348, 0.139, 1.017),\n  lower = c(0.372, 0.018, 0.072, 0.333, 0.083, 0.016, 0.365),\n  upper = c(0.898, 1.517, 0.833, 1.474, 1.455, 1.209, 2.831),\n  study = c(\n    \"Auckland\", \"Block\", \"Doran\", \"Gamsu\",\n    \"Morrison\", \"Papageorgiou\", \"Tauesch\"\n  ),\n  deaths_steroid = c(\"36\", \"1\", \"4\", \"14\", \"3\", \"1\", \"8\"),\n  deaths_placebo = c(\"60\", \"5\", \"11\", \"20\", \"7\", \"7\", \"10\"),\n  OR = c(\"0.58\", \"0.16\", \"0.25\", \"0.70\", \"0.35\", \"0.14\", \"1.02\")\n)\n```\n:::\n\n\n### 基础绘图\n\n可以看出forestplot包绘制森林图主体为`forestplot`函数，后续增加`fp_xxx`函数来完善内容\n\n- fp_set_style：设置样式\n- fp_add_header：添加表头\n- fp_append_row：额外添加行\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata |>\n  forestplot(\n    labeltext = c(study, deaths_steroid, deaths_placebo, OR),\n    clip = c(0.1, 2.5),\n    xlog = TRUE\n  ) |>\n  fp_set_style(\n    box = \"royalblue\",\n    line = \"darkblue\",\n    summary = \"royalblue\"\n  ) |>\n  fp_add_header(\n    study = c(\"\", \"Study\"),\n    deaths_steroid = c(\"Deaths\", \"(steroid)\"),\n    deaths_placebo = c(\"Deaths\", \"(placebo)\"),\n    OR = c(\"\", \"OR\")\n  ) |>\n  fp_append_row(\n    mean = 0.531,\n    lower = 0.386,\n    upper = 0.731,\n    study = \"Summary\",\n    OR = \"0.53\",\n    is.summary = TRUE\n  ) |>\n  fp_set_zebra_style(\"#EFEFEF\")\n```\n\n::: {.cell-output-display}\n![](2016-forestplot_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n## 样式美化\n\n### 修改样式\n\n- 使用`fp_set_style`来修改各内容的样式\n- 使用`fp_add_lines`来添加线条\n- 更多参数大家需要多看help文档\n\n![](https://pic-go-42.oss-cn-guangzhou.aliyuncs.com/img/202410280846517.webp)\n\n主要参考的是设置是`gpar`包样式\n \n\n::: {.cell}\n\n```{.r .cell-code}\ndata |>\n  forestplot(\n    labeltext = c(study, deaths_steroid, deaths_placebo, OR),\n    clip = c(0.1, 2.5),\n    xlog = TRUE\n  ) |>\n  fp_add_lines() |>\n  fp_set_style(\n    box = \"royalblue\",\n    line = \"darkblue\",\n    summary = \"royalblue\",\n    align = \"lrrr\",\n    hrz_lines = \"#999999\"\n  ) |>\n  fp_add_header(\n    study = c(\"\", \"Study\"),\n    deaths_steroid = c(\"Deaths\", \"(steroid)\") |>\n      fp_align_center(),\n    deaths_placebo = c(\"Deaths\", \"(placebo)\") |>\n      fp_align_center(),\n    OR = c(\"\", fp_align_center(\"OR\"))\n  ) |>\n  fp_append_row(\n    mean = 0.531,\n    lower = 0.386,\n    upper = 0.731,\n    study = \"Summary\",\n    OR = \"0.53\",\n    is.summary = TRUE\n  )\n```\n\n::: {.cell-output-display}\n![](2016-forestplot_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n### 对线条自定义\n\n使用fp_add_lines来添加辅助线，lty是线形，lwd是线宽，col是颜色\n\nf_n代表对第几列添加线条，columns设置线条有多宽\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata |>\n  forestplot(\n    labeltext = c(study, deaths_steroid, deaths_placebo, OR),\n    clip = c(0.1, 2.5),\n    vertices = TRUE,\n    xlog = TRUE\n  ) |>\n  fp_add_lines(\n    h_3 = gpar(lty = 2),\n    h_11 = gpar(lwd = 1, columns = 1:4, col = \"#000044\")\n  ) |>\n  fp_set_style(\n    box = \"royalblue\",\n    line = \"darkblue\",\n    summary = \"royalblue\",\n    align = \"lrrr\",\n    hrz_lines = \"#999999\"\n  ) |>\n  fp_add_header(\n    study = c(\"\", \"Study\"),\n    deaths_steroid = c(\"Deaths\", \"(steroid)\") |>\n      fp_align_center(),\n    deaths_placebo = c(\"Deaths\", \"(placebo)\") |>\n      fp_align_center(),\n    OR = c(\"\", fp_align_center(\"OR\"))\n  ) |>\n  fp_append_row(\n    mean = 0.531,\n    lower = 0.386,\n    upper = 0.731,\n    study = \"Summary\",\n    OR = \"0.53\",\n    is.summary = TRUE\n  )\n```\n\n::: {.cell-output-display}\n![](2016-forestplot_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n### 减小固定box（就是平均值的那个盒子）大小\n\n强制boxsize的大小，使用函数forestplot的参数`boxsize`,但是设置之后大小也不会随着OR增大而增大\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata |>\n  forestplot(\n    labeltext = c(study, deaths_steroid, deaths_placebo, OR),\n    clip = c(0.1, 2.5),\n    vertices = TRUE,\n    boxsize = 0.2,\n    xlog = TRUE\n  ) |>\n  fp_add_lines(\n    h_3 = gpar(lty = 2),\n    h_11 = gpar(lwd = 1, columns = 1:4, col = \"#000044\")\n  ) |>\n  fp_set_style(\n    box = \"royalblue\",\n    line = \"darkblue\",\n    summary = \"royalblue\",\n    align = \"lrrr\",\n    hrz_lines = \"#999999\"\n  ) |>\n  fp_add_header(\n    study = c(\"\", \"Study\"),\n    deaths_steroid = c(\"Deaths\", \"(steroid)\") |>\n      fp_align_center(),\n    deaths_placebo = c(\"Deaths\", \"(placebo)\") |>\n      fp_align_center(),\n    OR = c(\"\", fp_align_center(\"OR\"))\n  ) |>\n  fp_append_row(\n    mean = 0.531,\n    lower = 0.386,\n    upper = 0.731,\n    study = \"Summary\",\n    OR = \"0.53\",\n    is.summary = TRUE\n  )\n```\n\n::: {.cell-output-display}\n![](2016-forestplot_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n### 分组OR\n\n垃圾包，已经跑不了分组了，应该是groupby更新后没适配上。浪费我一个小时\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata(dfHRQoL)\n\ndfHRQoL  |> group_by(group)|>\n  forestplot(\n    labeltext = c(labeltext),\n    boxsize = 0.1,\n    lineheight = \"lines\",\n    xlab = \"EQ-5D index\"\n  ) |>\n  fp_add_lines(\"steelblue\") |>\n  fp_add_header(\"Variable\") \n\n  |>\n  fp_set_style(\n    box = c(\"blue\", \"darkred\") |>\n      lapply(function(x) gpar(fill = x, col = \"#555555\")),\n    default = gpar(vertices = TRUE)\n  )\n```\n:::\n",
    "supporting": [
      "2016-forestplot_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}