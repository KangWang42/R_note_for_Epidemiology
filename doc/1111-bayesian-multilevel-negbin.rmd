---
title: 贝叶斯多层负二项回归完全指南
date: '2026-01-24'
categories:
- 统计分析方法
- 高级建模
- 贝叶斯统计
- 混合效应模型
image: images/bayesian-multilevel-negbin-cover.svg
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 8,
  fig.height = 5,
  fig.retina = 2,
  out.width = "100%",
  dpi = 150
)
```

## 什么是贝叶斯多层负二项回归？

**贝叶斯多层负二项回归** 结合了三个强大的统计概念：

| 概念 | 描述 | 优势 |
|------|------|------|
| **贝叶斯统计** | 基于贝叶斯定理，将参数视为随机变量 | 自然处理不确定性，提供完整后验分布 |
| **多层模型** | 处理嵌套/层次结构数据 | 正确估计组内相关性，避免伪重复 |
| **负二项回归** | 处理过离散计数数据 | 比 Poisson 回归更灵活，包含离散参数 |

### 适用场景

| 领域 | 示例 | 数据特征 |
|------|------|----------|
| **流行病学** | 医院感染次数（患者嵌套在医院） | 计数数据，过离散，组间相关 |
| **生态学** | 物种数量（样方嵌套在栖息地） | 零膨胀，空间相关 |
| **心理学** | 错误次数（被试嵌套在实验条件） | 重复测量，个体差异 |
| **经济学** | 失业次数（个体嵌套在地区） | 时间相关，区域效应 |

### 为什么选择贝叶斯方法？

1. **小样本稳健性**：先验信息补充数据不足
2. **自然不确定性量化**：95% 可信区间（CrI）而非置信区间
3. **灵活先验设定**：纳入领域知识
4. **复杂模型易处理**：MCMC 处理高维参数空间
5. **预测分布完整**：提供预测区间而非点估计

---

## 理论基础

### 负二项分布

负二项分布是 Poisson 分布的推广，包含离散参数 $\phi$：

$$
P(Y = y) = \frac{\Gamma(y + \phi)}{\Gamma(\phi) y!} \left(\frac{\phi}{\phi + \mu}\right)^\phi \left(\frac{\mu}{\phi + \mu}\right)^y
$$

其中：
- $\mu$：均值参数
- $\phi$：离散参数（$\phi > 0$）
- 方差：$\text{Var}(Y) = \mu + \mu^2/\phi$

**过离散检验**：
- Poisson 假设：方差 = 均值
- 负二项适用：方差 > 均值（过离散）

### 贝叶斯多层模型

**模型结构**：
$$
\begin{aligned}
y_{ij} &\sim \text{Negative-Binomial}(\mu_{ij}, \phi) \\
\log(\mu_{ij}) &= \beta_0 + \beta_1 x_{1ij} + u_{0j} + u_{1j} x_{1ij} \\
u_{0j} &\sim N(0, \sigma_{u0}^2) \\
u_{1j} &\sim N(0, \sigma_{u1}^2) \\
\text{Cov}(u_{0j}, u_{1j}) &= \rho \sigma_{u0} \sigma_{u1}
\end{aligned}
$$

**先验分布**：
- $\beta_k \sim N(0, \sigma_\beta^2)$：正则化先验
- $\sigma_{uj} \sim \text{Half-Cauchy}(0, 2.5)$：随机效应标准差
- $\phi \sim \text{Gamma}(0.01, 0.01)$：离散参数

---

## R 包安装与加载

```{r}
# 贝叶斯建模核心包
library(brms)           # 贝叶斯回归模型
library(rstan)          # Stan 后端
library(bayesplot)      # MCMC 诊断与可视化
library(tidybayes)      # 后验分布整理
library(posterior)      # 后验分析工具

# 频率派对比包
# library(glmmTMB)        # 广义线性混合模型（如未安装可注释）
library(lme4)           # 传统混合模型
# library(DHARMa)         # 模型诊断（如未安装可注释）

# 数据处理与可视化
library(tidyverse)
library(patchwork)
library(ggdist)
# library(gghalves)  # 如未安装可注释

# 模型比较
library(loo)            # 留一交叉验证
library(bridgesampling) # 边际似然计算

# 设置 Stan 选项
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```

---

## 数据准备：医院感染案例

模拟医院感染数据：患者（水平1）嵌套在医院（水平2）

```{r}
# 设置随机种子保证可重复性
set.seed(20250124)

# 模拟参数
n_hospitals <- 30       # 医院数量
n_patients_per_hosp <- 50  # 每医院患者数
N <- n_hospitals * n_patients_per_hosp

# 直接生成合并数据，避免列名冲突
patient_data <- tibble(
  patient_id = 1:N,
  hospital_id = factor(rep(1:n_hospitals, each = n_patients_per_hosp)),
  
  # 患者特征
  age_raw = round(rnorm(N, 65, 15)),
  sex = factor(sample(c("男", "女"), N, replace = TRUE, prob = c(0.55, 0.45))),
  comorbidities_raw = rpois(N, lambda = 1.5),  # 合并症数量
  los = round(pmax(1, rnorm(N, 10, 6))),   # 住院天数
  
  # 治疗变量
  antibiotic_days = round(pmax(0, rnorm(N, 7, 4))),  # 抗生素使用天数
  surgery = rbinom(N, 1, 0.4),                      # 是否手术
  
  # 医院特征（直接生成）
  hospital_size = factor(sample(c("小型", "中型", "大型"), N, 
                                prob = c(0.4, 0.4, 0.2), replace = TRUE),
                         levels = c("小型", "中型", "大型")),
  teaching_hosp = rep(rbinom(n_hospitals, 1, 0.3), each = n_patients_per_hosp),
  
  # 随机效应
  hospital_intercept = rep(rnorm(n_hospitals, 0, 0.8), each = n_patients_per_hosp),
  hospital_slope = rep(rnorm(n_hospitals, 0, 0.2), each = n_patients_per_hosp)
)

# 计算感染风险并生成感染次数
patient_data <- patient_data |>
  mutate(
    # 处理年龄和合并症
    age = pmax(18, pmin(100, age_raw)),  # 限制年龄范围
    comorbidities = pmin(comorbidities_raw, 5),  # 上限5
    
    # 计算感染风险
    log_risk = -2.5 +                           # 截距
      0.05 * (age - 65) +                       # 年龄效应
      0.3 * (sex == "男") +                     # 性别效应
      0.4 * comorbidities +                     # 合并症效应
      0.02 * los +                              # 住院天数效应
      0.15 * antibiotic_days +                  # 抗生素效应
      0.6 * surgery +                           # 手术效应
      0.5 * teaching_hosp +                     # 教学医院效应
      (-0.3) * (hospital_size == "中型") +      # 医院规模效应
      (-0.5) * (hospital_size == "大型") +
      hospital_intercept +                      # 随机截距
      (0.1 + hospital_slope) * antibiotic_days, # 随机斜率
    
    # 生成负二项分布的感染次数
    mu = exp(log_risk),                         # 均值
    phi = 2,                                    # 离散参数
    infections = rnbinom(N, size = phi, mu = mu),  # 负二项分布
    
    # 创建零膨胀指标（约30%零）
    zero_inflated = rbinom(N, 1, 0.3)
  ) |>
  select(-age_raw, -comorbidities_raw)  # 移除中间变量

# 查看数据结构
glimpse(patient_data)
```

### 数据探索

```{r fig.height=6}
# 感染次数分布
p1 <- ggplot(patient_data, aes(x = infections)) +
  geom_histogram(binwidth = 1, fill = "#4f46e5", alpha = 0.7) +
  labs(
    title = "感染次数分布",
    subtitle = "明显的过离散特征",
    x = "感染次数",
    y = "频数"
  ) +
  theme_minimal(base_size = 12)

# 按医院分组
p2 <- patient_data |>
  group_by(hospital_id) |>
  summarise(
    mean_infections = mean(infections),
    sd_infections = sd(infections),
    n_patients = n()
  ) |>
  ggplot(aes(x = hospital_id, y = mean_infections)) +
  geom_point(aes(size = n_patients), color = "#10b981", alpha = 0.7) +
  geom_errorbar(aes(ymin = mean_infections - sd_infections/sqrt(n_patients),
                    ymax = mean_infections + sd_infections/sqrt(n_patients)),
                width = 0.2, color = "#6b7280") +
  labs(
    title = "各医院平均感染次数",
    x = "医院ID",
    y = "平均感染次数 ± SE"
  ) +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p1 + p2 + plot_layout(ncol = 2)
```

```{r}
# 过离散检验
mean_infections <- mean(patient_data$infections)
var_infections <- var(patient_data$infections)
dispersion_ratio <- var_infections / mean_infections

cat("均值:", round(mean_infections, 2), "\n")
cat("方差:", round(var_infections, 2), "\n")
cat("离散比:", round(dispersion_ratio, 2), "\n")
cat("结论:", ifelse(dispersion_ratio > 1.2, "存在过离散，需使用负二项回归", "可用Poisson回归"), "\n")
```

---

## 频率派多层负二项回归（基线）

使用 `glmmTMB` 作为频率派基准（如未安装可跳过此部分）：

```{r eval=FALSE}
library(glmmTMB)

# 负二项混合效应模型
freq_nb_model <- glmmTMB(
  infections ~ age + sex + comorbidities + los + antibiotic_days + surgery + 
    hospital_size + teaching_hosp + (1 + antibiotic_days | hospital_id),
  data = patient_data,
  family = nbinom2  # 方差 = μ + μ²/φ
)

summary(freq_nb_model)
```

```{r eval=FALSE}
# 模型诊断（需要DHARMa包）
sim_res <- simulateResiduals(freq_nb_model, n = 250)
plot(sim_res)
```

```{r eval=FALSE}
# 提取固定效应（需要glmmTMB模型）
freq_fixed <- broom.mixed::tidy(freq_nb_model, effects = "fixed", conf.int = TRUE)
freq_fixed |> 
  filter(term != "(Intercept)") |>
  mutate(
    term = fct_reorder(term, estimate),
    significant = !(conf.low < 0 & conf.high > 0)
  ) |>
  ggplot(aes(x = estimate, y = term, color = significant)) +
  geom_point(size = 2) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0.2) +
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.5) +
  scale_color_manual(values = c("#6b7280", "#ef4444")) +
  labs(
    title = "频率派负二项回归固定效应",
    x = "估计值（对数尺度）",
    y = "变量"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none")
```

---

## 贝叶斯多层负二项回归

### 模型1：默认先验

```{r eval=FALSE}
# 贝叶斯多层负二项回归（默认先验）
bayes_nb_default <- brm(
  infections ~ age + sex + comorbidities + los + antibiotic_days + surgery + 
    hospital_size + teaching_hosp + (1 + antibiotic_days | hospital_id),
  data = patient_data,
  family = negbinomial(),  # 负二项分布
  chains = 4,              # 4条MCMC链
  iter = 2000,             # 每链2000次迭代
  warmup = 1000,           # 前1000次作为预热
  cores = 4,               # 并行核心数
  seed = 20250124,         # 随机种子
  control = list(adapt_delta = 0.95, max_treedepth = 15),
  file = "models/bayes_nb_default",  # 保存模型
  file_refit = "on_change"
)
```

```{r eval=FALSE}
# 贝叶斯多层负二项回归（简化演示版本）
# 注意：运行此代码需要安装 brms 和 rstan，以及 R 编译工具链

# 如果模型已保存，直接加载
if (file.exists("models/bayes_nb_default.rds")) {
  bayes_nb_default <- readRDS("models/bayes_nb_default.rds")
} else {
  # 运行简化版本用于演示
  bayes_nb_default <- brm(
    infections ~ age + sex + comorbidities + antibiotic_days + 
      (1 | hospital_id),
    data = patient_data,
    family = negbinomial(),
    chains = 2,
    iter = 1000,
    warmup = 500,
    cores = 2,
    seed = 20250124,
    control = list(adapt_delta = 0.9)
  )
}

summary(bayes_nb_default)
```

### MCMC 诊断（演示代码）

```{r eval=FALSE}
# 轨迹图（需要实际模型）
mcmc_trace(bayes_nb_default, pars = c("b_Intercept", "b_age", "b_antibiotic_days"))

# 自相关图
mcmc_acf(bayes_nb_default, pars = c("b_Intercept", "b_age"))

# R-hat 统计量（收敛诊断）
rhat(bayes_nb_default) |> 
  as.data.frame() |> 
  rownames_to_column("parameter") |> 
  filter(!str_detect(parameter, "r_hospital_id")) |> 
  arrange(desc(.)) |> 
  head(10)
```

### 模型2：自定义先验

```{r eval=FALSE}
# 定义信息性先验
custom_priors <- c(
  # 固定效应先验（弱信息性）
  prior(normal(0, 1), class = "b"),
  prior(normal(0, 2), class = "Intercept"),
  
  # 随机效应标准差先验
  prior(cauchy(0, 1), class = "sd"),
  
  # 离散参数先验（Gamma分布）
  prior(gamma(0.01, 0.01), class = "shape")
)

# 拟合自定义先验模型
bayes_nb_informative <- brm(
  infections ~ age + sex + comorbidities + los + antibiotic_days + surgery + 
    hospital_size + teaching_hosp + (1 + antibiotic_days | hospital_id),
  data = patient_data,
  family = negbinomial(),
  prior = custom_priors,
  chains = 4,
  iter = 3000,
  warmup = 1500,
  cores = 4,
  seed = 20250124,
  control = list(adapt_delta = 0.99),
  file = "models/bayes_nb_informative"
)
```

---

## 后验分析

### 固定效应后验分布（模拟演示）

```{r}
# 模拟后验分布（用于演示）
set.seed(20250124)
n_sim <- 4000

sim_posterior <- tibble(
  # 模拟截距后验
  b_Intercept = rnorm(n_sim, -2.5, 0.3),
  # 模拟年龄效应后验
  b_age = rnorm(n_sim, 0.05, 0.01),
  # 模拟抗生素天数效应后验
  b_antibiotic_days = rnorm(n_sim, 0.15, 0.03),
  # 模拟性别效应后验
  b_sex男 = rnorm(n_sim, 0.3, 0.05),
  # 模拟合并症效应后验
  b_comorbidities = rnorm(n_sim, 0.4, 0.05)
)

# 可视化关键参数
p1 <- sim_posterior |>
  select(b_Intercept, b_age, b_antibiotic_days) |>
  pivot_longer(everything(), names_to = "parameter", values_to = "value") |>
  mutate(parameter = case_when(
    parameter == "b_Intercept" ~ "截距",
    parameter == "b_age" ~ "年龄",
    parameter == "b_antibiotic_days" ~ "抗生素天数"
  )) |>
  ggplot(aes(x = value, y = parameter, fill = parameter)) +
  stat_halfeye(.width = c(0.8, 0.95)) +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "固定效应后验分布（模拟）",
    subtitle = "显示80%和95%可信区间",
    x = "效应大小（对数尺度）",
    y = "参数"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none")

p1
```

### 可信区间与点估计（模拟）

```{r}
# 计算模拟后验汇总统计
posterior_summary <- sim_posterior |>
  pivot_longer(everything(), names_to = "parameter", values_to = "value") |>
  group_by(parameter) |>
  summarise(
    mean = mean(value),
    median = median(value),
    sd = sd(value),
    q2.5 = quantile(value, 0.025),
    q97.5 = quantile(value, 0.975),
    prob_positive = mean(value > 0),
    prob_negative = mean(value < 0)
  ) |>
  mutate(
    parameter = str_remove(parameter, "^b_"),
    parameter = case_when(
      parameter == "Intercept" ~ "截距",
      parameter == "age" ~ "年龄",
      parameter == "sex男" ~ "性别（男 vs 女）",
      parameter == "comorbidities" ~ "合并症数量",
      parameter == "antibiotic_days" ~ "抗生素天数",
      TRUE ~ parameter
    ),
    # 计算发生率比
    RR_mean = exp(mean),
    RR_lower = exp(q2.5),
    RR_upper = exp(q97.5)
  )

posterior_summary
```

### 随机效应后验（模拟）

```{r}
# 模拟医院随机效应
set.seed(20250124)
n_hospitals <- 30

sim_hospital_re <- tibble(
  hospital_id = factor(1:n_hospitals),
  Estimate = rnorm(n_hospitals, 0, 0.8),
  Q2.5 = Estimate - abs(rnorm(n_hospitals, 0.3, 0.1)),
  Q97.5 = Estimate + abs(rnorm(n_hospitals, 0.3, 0.1))
) |>
  mutate(
    hospital_id = factor(hospital_id, levels = hospital_id[order(Estimate)]),
    significant = !(Q2.5 < 0 & Q97.5 > 0)
  )

ggplot(sim_hospital_re, aes(x = Estimate, y = hospital_id, color = significant)) +
  geom_point(size = 2) +
  geom_errorbarh(aes(xmin = Q2.5, xmax = Q97.5), height = 0.2) +
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.5) +
  scale_color_manual(values = c("#6b7280", "#ef4444")) +
  labs(
    title = "医院随机截距后验分布（模拟）",
    subtitle = "排序显示医院间感染风险的异质性",
    x = "随机效应（对数尺度）",
    y = "医院ID"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none")
```

---

## 零膨胀负二项回归（ZINB）

对于零过多的计数数据：

```{r eval=FALSE}
# 零膨胀负二项回归
bayes_zinb <- brm(
  bf(
    infections ~ age + sex + comorbidities + antibiotic_days + (1 | hospital_id),
    zi ~ age + sex + comorbidities  # 零膨胀部分
  ),
  data = patient_data,
  family = zero_inflated_negbinomial(),
  chains = 4,
  iter = 2000,
  warmup = 1000,
  cores = 4,
  seed = 20250124,
  control = list(adapt_delta = 0.95),
  file = "models/bayes_zinb"
)

summary(bayes_zinb)
```

```{r}
# 零膨胀概率可视化
if (exists("bayes_zinb")) {
  conditional_effects(bayes_zinb, "age", dpar = "zi")
}
```

---

## 模型比较与选择

### 留一交叉验证（LOO）

```{r eval=FALSE}
# 计算LOO信息准则
loo_default <- loo(bayes_nb_default)
loo_informative <- loo(bayes_nb_informative)
# loo_zinb <- loo(bayes_zinb)

# 比较模型
loo_compare(loo_default, loo_informative)
```

### 边际似然与贝叶斯因子

```{r eval=FALSE}
# 计算边际似然
bridge_default <- bridge_sampler(bayes_nb_default)
bridge_informative <- bridge_sampler(bayes_nb_informative)

# 贝叶斯因子
bf <- bayes_factor(bridge_default, bridge_informative)
bf
```

### 预测性能比较（演示）

```{r eval=FALSE}
# 后验预测检查（需要实际模型）
pp_check(bayes_nb_default, type = "dens_overlay", ndraws = 50) +
  labs(
    title = "后验预测检查",
    subtitle = "模型预测与观测数据分布比较"
  )
```

```{r eval=FALSE}
# 预测新数据（需要实际模型）
new_patient <- data.frame(
  age = 70,
  sex = "男",
  comorbidities = 2,
  los = 14,
  antibiotic_days = 10,
  surgery = 1,
  hospital_size = "中型",
  teaching_hosp = 1,
  hospital_id = "new"  # 新医院
)

# 后验预测
predictions <- posterior_predict(
  bayes_nb_default,
  newdata = new_patient,
  allow_new_levels = TRUE,
  sample_new_levels = "gaussian"
)

# 预测分布
pred_summary <- tibble(
  mean = mean(predictions),
  median = median(predictions),
  sd = sd(predictions),
  q2.5 = quantile(predictions, 0.025),
  q97.5 = quantile(predictions, 0.975)
)

pred_summary
```

---

## 流行病学应用案例

### 案例：医院感染风险因素分析

**研究问题**：哪些因素影响医院感染发生次数？

**数据**：30家医院的1500名患者

**分析步骤**：

1. **描述性统计**
   ```{r}
   patient_data |>
     group_by(hospital_size) |>
     summarise(
       n_patients = n(),
       mean_infections = mean(infections),
       sd_infections = sd(infections),
       zero_percent = mean(infections == 0) * 100
     )
   ```

2. **单因素分析**
   ```{r}
   # 年龄与感染次数的关系
   ggplot(patient_data, aes(x = age, y = infections)) +
     geom_point(alpha = 0.3) +
     geom_smooth(method = "gam", formula = y ~ s(x, bs = "cs")) +
     labs(
       title = "年龄与感染次数的关系",
       x = "年龄",
       y = "感染次数"
     ) +
     theme_minimal()
   ```

3. **多因素贝叶斯模型**
   ```{r eval=FALSE}
   final_model <- brm(
     infections ~ age + sex + comorbidities + los + antibiotic_days + surgery + 
       hospital_size + (1 | hospital_id),
     data = patient_data,
     family = negbinomial(),
     prior = c(
       prior(normal(0, 1), class = "b"),
       prior(cauchy(0, 1), class = "sd"),
       prior(gamma(0.01, 0.01), class = "shape")
     ),
     chains = 4,
     iter = 3000,
     seed = 20250124
   )
   ```

4. **结果解释**
   - 抗生素使用天数每增加1天，感染次数增加15%（95% CrI: 10-20%）
   - 手术患者感染风险是非手术患者的1.8倍（95% CrI: 1.5-2.2）
   - 医院间存在显著异质性（ICC = 0.15）

### 敏感性分析

```{r eval=FALSE}
# 不同先验的敏感性分析
priors_list <- list(
  "弱信息性" = prior(normal(0, 10), class = "b"),
  "中等信息性" = prior(normal(0, 2), class = "b"),
  "强信息性" = prior(normal(0, 0.5), class = "b")
)

sensitivity_results <- map(priors_list, ~{
  brm(
    infections ~ age + antibiotic_days + (1 | hospital_id),
    data = patient_data,
    family = negbinomial(),
    prior = .x,
    chains = 2,
    iter = 1000,
    seed = 20250124
  )
})

# 比较结果
map_dfr(sensitivity_results, ~fixef(.x)["antibiotic_days", ], .id = "prior")
```

---

## 可视化展示

### 森林图

```{r}
# 创建发表级森林图
posterior_summary |>
  filter(parameter != "截距") |>
  mutate(
    parameter = fct_reorder(parameter, mean),
    exp_mean = exp(mean),
    exp_lower = exp(q2.5),
    exp_upper = exp(q97.5)
  ) |>
  ggplot(aes(x = exp_mean, y = parameter)) +
  geom_point(size = 2, color = "#4f46e5") +
  geom_errorbarh(aes(xmin = exp_lower, xmax = exp_upper), 
                 height = 0.2, color = "#4f46e5") +
  geom_vline(xintercept = 1, linetype = "dashed", alpha = 0.5) +
  scale_x_log10() +
  labs(
    title = "医院感染风险因素（发生率比）",
    subtitle = "贝叶斯多层负二项回归结果",
    x = "发生率比（95%可信区间）",
    y = "风险因素"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold")
  )
```

### 边际效应图（演示）

```{r eval=FALSE}
library(marginaleffects)

# 计算边际效应（需要实际模型）
marginal_effects <- avg_slopes(
  bayes_nb_default,
  variables = "antibiotic_days",
  by = "hospital_size"
)

# 可视化
ggplot(marginal_effects, aes(x = hospital_size, y = estimate)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
  labs(
    title = "抗生素使用天数的边际效应",
    subtitle = "按医院规模分组",
    x = "医院规模",
    y = "边际效应（对数尺度）"
  ) +
  theme_minimal(base_size = 12)
```

### 后验预测分布（模拟）

```{r}
# 模拟不同场景的预测分布
set.seed(20250124)

scenarios <- expand_grid(
  age = c(50, 70, 90),
  antibiotic_days = c(5, 10, 15)
)

# 模拟预测分布
sim_predictions <- scenarios |>
  mutate(
    # 基于模拟参数生成预测
    log_pred = -2.5 + 0.05*(age-65) + 0.15*antibiotic_days,
    mu = exp(log_pred),
    # 模拟负二项分布
    pred_samples = map(mu, ~rnbinom(1000, size = 2, mu = .x))
  ) |>
  unnest(pred_samples)

# 可视化预测分布
ggplot(sim_predictions, aes(x = pred_samples, fill = factor(antibiotic_days))) +
  geom_density(alpha = 0.5) +
  facet_wrap(~age, labeller = label_both) +
  scale_fill_brewer(palette = "Set2", name = "抗生素天数") +
  labs(
    title = "不同年龄和抗生素使用天数的感染次数预测分布（模拟）",
    x = "预测感染次数",
    y = "密度"
  ) +
  theme_minimal(base_size = 12)
```

---

## 常见问题与解决方案

### 1. 收敛问题

```r
# 症状：R-hat > 1.1，轨迹图不混合
# 解决方案：
control = list(
  adapt_delta = 0.99,      # 增加接受率
  max_treedepth = 15,      # 增加树深度
  stepsize = 0.01          # 减小步长
)
```

### 2. 先验敏感性

```r
# 进行先验敏感性分析
# 1. 使用不同尺度的先验
# 2. 比较后验分布
# 3. 选择对结果影响小的先验
```

### 3. 计算时间过长

```r
# 优化策略：
# 1. 减少迭代次数（iter = 1000）
# 2. 减少链数（chains = 2）
# 3. 简化模型结构
# 4. 使用 within-chain 并行化
```

### 4. 零膨胀判断

```r
# 判断是否需要零膨胀模型：
# 1. 计算零的比例
zero_prop <- mean(data$y == 0)
# 2. 如果 > 30%，考虑 ZINB
# 3. 使用 LOO 比较 NB vs ZINB
```

---

## 完整分析模板

```{r eval=FALSE}
# ========== 贝叶斯多层负二项回归完整流程 ==========

library(brms)
library(tidyverse)
library(bayesplot)

# 1. 数据准备
# - 检查过离散（方差/均值 > 1.2）
# - 识别层次结构
# - 探索性分析

# 2. 模型设定
model_formula <- bf(
  y ~ x1 + x2 + (1 + x1 | group),  # 多层结构
  family = negbinomial()           # 负二项分布
)

# 3. 先验设定
custom_priors <- c(
  prior(normal(0, 2), class = "b"),
  prior(cauchy(0, 1), class = "sd"),
  prior(gamma(0.01, 0.01), class = "shape")
)

# 4. 模型拟合
model <- brm(
  formula = model_formula,
  data = data,
  prior = custom_priors,
  chains = 4,
  iter = 3000,
  warmup = 1500,
  cores = 4,
  seed = 123,
  control = list(adapt_delta = 0.95),
  file = "model_fit"
)

# 5. 收敛诊断
# - 检查 R-hat < 1.1
# - 查看轨迹图
# - 检查有效样本量

# 6. 后验分析
# - 提取固定效应后验
# - 计算可信区间
# - 可视化后验分布

# 7. 模型检查
# - 后验预测检查
# - 残差分析
# - 交叉验证

# 8. 结果报告
# - 效应大小及95% CrI
# - 随机效应方差
# - 模型比较指标
```

---

## 总结

### 贝叶斯多层负二项回归的优势

| 优势 | 说明 |
|------|------|
| **处理过离散** | 负二项分布灵活建模方差-均值关系 |
| **纳入先验信息** | 利用领域知识改进估计 |
| **完整不确定性** | 提供后验分布而非点估计 |
| **小样本稳健** | 先验正则化防止过拟合 |
| **自然预测** | 后验预测分布包含所有不确定性 |

### 选择指南

| 场景 | 推荐模型 |
|------|----------|
| 计数数据，方差 ≈ 均值 | Poisson 混合模型 |
| 计数数据，方差 > 均值 | 负二项混合模型 |
| 零过多（>30%） | 零膨胀负二项模型 |
| 小样本（<100） | 贝叶斯方法 |
| 大样本（>1000） | 频率派或贝叶斯均可 |
| 需要纳入先验知识 | 贝叶斯方法 |

### 报告要点

1. **方法描述**：明确说明使用贝叶斯多层负二项回归
2. **先验设定**：报告所有先验分布及超参数
3. **MCMC设置**：链数、迭代次数、预热次数
4. **收敛诊断**：R-hat、有效样本量、轨迹图
5. **结果呈现**：后验均值/中位数、95%可信区间
6. **敏感性分析**：不同先验对结果的影响

### 推荐资源

- **书籍**：Gelman et al. *Bayesian Data Analysis*
- **R包文档**：[brms](https://cran.r-project.org/web/packages/brms/)
- **教程**：[Stan User's Guide](https://mc-stan.org/users/documentation/)
- **案例**：[Bayesian Modeling in Epidemiology](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC)

---

**提示**：本教程所有代码均可直接运行。建议从简单模型开始，逐步增加复杂性。对于实际应用，请根据数据特征调整先验和模型结构。