{
  "hash": "cb60f5beacd8d2482502d3697b2fcf64",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: DAG 因果图与混杂控制\ndate: '2026-01-14'\ncategories:\n- 统计分析方法\n- 因果推断\n- DAG\nimage: images/dag_cover.svg\ndescription: 使用DAG（有向无环图）识别混杂、中介与碰撞偏倚，确定变量调整策略，满足高水平期刊要求。\n---\n\n\n\n## 什么是DAG\n\n**DAG（Directed Acyclic Graph，有向无环图）** 是表示变量间因果关系的图形工具。在流行病学和因果推断中，DAG 用于：\n\n- 清晰表达因果假设\n- 识别混杂因素、中介变量、碰撞因素\n- 确定需要调整的最小变量集\n- 发现潜在的偏倚来源\n\n### 为什么需要DAG\n\n| 传统方法 | DAG方法 |\n|----------|---------|\n| 基于统计学显著性选择协变量 | 基于因果理论选择协变量 |\n| 可能过度调整或调整不足 | 精确识别最小充分调整集 |\n| 难以识别碰撞偏倚 | 明确避免调整碰撞因素 |\n| 主观性强 | 假设透明可讨论 |\n\n> **JAMA、BMJ、Lancet** 等高水平期刊越来越要求报告研究的因果假设DAG\n\n---\n\n## 安装与加载\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 安装必要的包\n# install.packages(c(\"dagitty\", \"ggdag\"))\n\nlibrary(dagitty)\nlibrary(ggdag)\nlibrary(ggplot2)\nlibrary(dplyr)\n```\n:::\n\n\n---\n\n## DAG基础概念\n\n### 节点类型\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](1056-dag_files/figure-html/unnamed-chunk-2-1.png){width=100%}\n:::\n:::\n\n\n| 节点类型 | 定义 | 示例 |\n|----------|------|------|\n| **暴露 (Exposure)** | 研究的主要自变量 | 吸烟 |\n| **结局 (Outcome)** | 研究的因变量 | 肺癌 |\n| **混杂 (Confounder)** | 同时影响暴露和结局的变量 | 年龄 |\n| **中介 (Mediator)** | 暴露通过它影响结局的变量 | 肺功能 |\n| **碰撞 (Collider)** | 同时被两个变量影响的变量 | 住院 |\n\n### 路径类型\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 创建包含不同路径的DAG\npath_dag <- dagify(\n    Y ~ X + U,\n    X ~ U,\n    M ~ X,\n    Y ~ M,\n    labels = c(X = \"暴露\", Y = \"结局\", U = \"混杂\", M = \"中介\"),\n    exposure = \"X\",\n    outcome = \"Y\"\n)\n\n# 识别所有路径\npaths(path_dag)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$paths\n[1] \"X -> M -> Y\" \"X -> Y\"      \"X <- U -> Y\"\n\n$open\n[1] TRUE TRUE TRUE\n```\n\n\n:::\n:::\n\n\n---\n\n## 使用 dagitty 创建DAG\n\n### 基础语法\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 方法1：使用 dagify 函数\ndag1 <- dagify(\n    outcome ~ exposure + confounder,\n    exposure ~ confounder,\n    exposure = \"exposure\",\n    outcome = \"outcome\"\n)\n\n# 方法2：使用 dagitty 语法\ndag2 <- dagitty(\"dag {\n  exposure -> outcome\n  confounder -> exposure\n  confounder -> outcome\n}\")\n\n# 查看DAG结构\ndag1\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ndag {\nconfounder\nexposure [exposure]\noutcome [outcome]\nconfounder -> exposure\nconfounder -> outcome\nexposure -> outcome\n}\n```\n\n\n:::\n:::\n\n\n### 实际研究案例\n\n创建一个研究\"体力活动与心血管疾病\"关系的DAG：\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncvd_dag <- dagify(\n    cvd ~ activity + age + bmi + smoking + ses + genetics,\n    activity ~ age + ses + bmi,\n    bmi ~ age + ses + genetics,\n    smoking ~ ses + age,\n    labels = c(\n        cvd = \"心血管疾病\",\n        activity = \"体力活动\",\n        age = \"年龄\",\n        bmi = \"BMI\",\n        smoking = \"吸烟\",\n        ses = \"社会经济地位\",\n        genetics = \"遗传因素\"\n    ),\n    exposure = \"activity\",\n    outcome = \"cvd\"\n)\n\n# 绑制DAG\nggdag(cvd_dag, text = FALSE, use_labels = \"label\") +\n    theme_dag() +\n    labs(title = \"体力活动与心血管疾病的因果图\")\n```\n\n::: {.cell-output-display}\n![](1056-dag_files/figure-html/unnamed-chunk-5-1.png){width=100%}\n:::\n:::\n\n\n---\n\n## 识别混杂路径\n\n### 后门路径\n\n**后门路径**是从暴露到结局的非因果路径（从暴露的\"后门\"出发）。这些路径会造成混杂偏倚。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 识别后门路径\nggdag_paths(cvd_dag) +\n    theme_dag() +\n    labs(title = \"暴露到结局的所有路径\")\n```\n\n::: {.cell-output-display}\n![](1056-dag_files/figure-html/unnamed-chunk-6-1.png){width=100%}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 查看具体路径\npaths(cvd_dag)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$paths\n [1] \"activity -> cvd\"                                            \n [2] \"activity <- age -> bmi -> cvd\"                              \n [3] \"activity <- age -> bmi <- genetics -> cvd\"                  \n [4] \"activity <- age -> bmi <- ses -> cvd\"                       \n [5] \"activity <- age -> bmi <- ses -> smoking -> cvd\"            \n [6] \"activity <- age -> cvd\"                                     \n [7] \"activity <- age -> smoking -> cvd\"                          \n [8] \"activity <- age -> smoking <- ses -> bmi -> cvd\"            \n [9] \"activity <- age -> smoking <- ses -> bmi <- genetics -> cvd\"\n[10] \"activity <- age -> smoking <- ses -> cvd\"                   \n[11] \"activity <- bmi -> cvd\"                                     \n[12] \"activity <- bmi <- age -> cvd\"                              \n[13] \"activity <- bmi <- age -> smoking -> cvd\"                   \n[14] \"activity <- bmi <- age -> smoking <- ses -> cvd\"            \n[15] \"activity <- bmi <- genetics -> cvd\"                         \n[16] \"activity <- bmi <- ses -> cvd\"                              \n[17] \"activity <- bmi <- ses -> smoking -> cvd\"                   \n[18] \"activity <- bmi <- ses -> smoking <- age -> cvd\"            \n[19] \"activity <- ses -> bmi -> cvd\"                              \n[20] \"activity <- ses -> bmi <- age -> cvd\"                       \n[21] \"activity <- ses -> bmi <- age -> smoking -> cvd\"            \n[22] \"activity <- ses -> bmi <- genetics -> cvd\"                  \n[23] \"activity <- ses -> cvd\"                                     \n[24] \"activity <- ses -> smoking -> cvd\"                          \n[25] \"activity <- ses -> smoking <- age -> bmi -> cvd\"            \n[26] \"activity <- ses -> smoking <- age -> bmi <- genetics -> cvd\"\n[27] \"activity <- ses -> smoking <- age -> cvd\"                   \n\n$open\n [1]  TRUE  TRUE FALSE FALSE FALSE  TRUE  TRUE FALSE FALSE FALSE  TRUE  TRUE\n[13]  TRUE FALSE  TRUE  TRUE  TRUE FALSE  TRUE FALSE FALSE FALSE  TRUE  TRUE\n[25] FALSE FALSE FALSE\n```\n\n\n:::\n:::\n\n\n### 识别混杂因素\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 绘制混杂因素\nggdag_adjustment_set(cvd_dag, shadow = TRUE) +\n    theme_dag() +\n    labs(title = \"需要调整的混杂因素（蓝色）\")\n```\n\n::: {.cell-output-display}\n![](1056-dag_files/figure-html/unnamed-chunk-8-1.png){width=100%}\n:::\n:::\n\n\n---\n\n## 确定调整集\n\n### 最小充分调整集\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 计算最小充分调整集\nadjustmentSets(cvd_dag, effect = \"total\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n{ age, bmi, ses }\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 可视化调整集\nggdag_adjustment_set(cvd_dag) +\n    theme_dag() +\n    scale_color_manual(values = c(\"#4f46e5\", \"#ef4444\")) +\n    labs(title = \"最小充分调整集\")\n```\n\n::: {.cell-output-display}\n![](1056-dag_files/figure-html/unnamed-chunk-10-1.png){width=100%}\n:::\n:::\n\n\n### 总效应 vs 直接效应\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 总效应：activity -> cvd 的所有路径\ntotal_adj <- adjustmentSets(cvd_dag, effect = \"total\")\ncat(\"总效应调整集:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n总效应调整集:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(total_adj)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n{ age, bmi, ses }\n```\n\n\n:::\n\n```{.r .cell-code}\n# 直接效应：排除中介路径\ndirect_adj <- adjustmentSets(cvd_dag, effect = \"direct\")\ncat(\"\\n直接效应调整集:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n直接效应调整集:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(direct_adj)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n{ age, bmi, ses }\n```\n\n\n:::\n:::\n\n\n---\n\n## 碰撞偏倚\n\n### 什么是碰撞\n\n当一个变量同时被两个变量影响时，它就是**碰撞因素（Collider）**。调整碰撞因素会**打开**原本关闭的路径，造成偏倚。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 创建包含碰撞的DAG\ncollider_dag <- dagify(\n    C ~ X + Y,\n    Y ~ X,\n    labels = c(X = \"暴露\", Y = \"结局\", C = \"碰撞\"),\n    exposure = \"X\",\n    outcome = \"Y\"\n)\n\n# 标记碰撞\nggdag_collider(collider_dag, text = FALSE, use_labels = \"label\") +\n    theme_dag() +\n    labs(title = \"碰撞因素示例\")\n```\n\n::: {.cell-output-display}\n![](1056-dag_files/figure-html/unnamed-chunk-12-1.png){width=100%}\n:::\n:::\n\n\n### 经典案例：出生体重悖论\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 出生体重悖论\nbirthweight_dag <- dagify(\n    death ~ smoking + lowbw + defect,\n    lowbw ~ smoking + defect,\n    labels = c(\n        death = \"婴儿死亡\",\n        smoking = \"母亲吸烟\",\n        lowbw = \"低出生体重\",\n        defect = \"先天缺陷\"\n    ),\n    exposure = \"smoking\",\n    outcome = \"death\"\n)\n\nggdag(birthweight_dag, text = FALSE, use_labels = \"label\") +\n    theme_dag() +\n    labs(\n        title = \"出生体重悖论\",\n        subtitle = \"低出生体重是碰撞因素，调整后会产生偏倚\"\n    )\n```\n\n::: {.cell-output-display}\n![](1056-dag_files/figure-html/unnamed-chunk-13-1.png){width=100%}\n:::\n:::\n\n\n---\n\n## d-分离规则\n\n**d-分离（d-separation）** 是判断两变量在给定条件下是否独立的规则。\n\n### 三条基本规则\n\n\n::: {.cell}\n::: {.cell-output-display}\n\n\nTable: d-分离规则\n\n|结构                 |形式      |自然状态 |调整B后 |\n|:--------------------|:---------|:--------|:-------|\n|链 (Chain)           |A → B → C |关联     |独立    |\n|叉 (Fork)            |A ← B → C |关联     |独立    |\n|碰撞 (Inverted Fork) |A → B ← C |独立     |关联    |\n\n\n:::\n:::\n\n\n### 检验d-分离\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 创建测试DAG\ntest_dag <- dagitty(\"dag {\n  X -> M -> Y\n  X -> Y\n  C -> X\n  C -> Y\n}\")\n\n# 检验条件独立性\nimpliedConditionalIndependencies(test_dag)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nC _||_ M | X\n```\n\n\n:::\n:::\n\n\n---\n\n## DAG的验证\n\n### 检验可测试的蕴含\n\n如果DAG正确，某些条件独立关系应该在数据中成立：\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 模拟数据\nset.seed(42)\nn <- 1000\nC <- rnorm(n)\nX <- 0.5 * C + rnorm(n)\nM <- 0.7 * X + rnorm(n)\nY <- 0.3 * X + 0.6 * M + 0.4 * C + rnorm(n)\n\nsim_data <- data.frame(C, X, M, Y)\n\n# 根据DAG，调整C后，X和Y在给定M时应该条件独立\n# 简化测试：偏相关应该接近0\npartial_cor <- cor(\n    residuals(lm(X ~ M + C, data = sim_data)),\n    residuals(lm(Y ~ M + C, data = sim_data))\n)\ncat(\"调整M和C后，X与Y的偏相关:\", round(partial_cor, 3), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n调整M和C后，X与Y的偏相关: 0.298 \n```\n\n\n:::\n:::\n\n\n---\n\n## 论文中的DAG报告\n\n### 报告格式\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 创建论文级别的DAG\npublication_dag <- dagify(\n    outcome ~ exposure + age + sex + ses + comorbidity,\n    exposure ~ age + sex + ses,\n    comorbidity ~ age + sex,\n    labels = c(\n        outcome = \"主要结局\",\n        exposure = \"暴露因素\",\n        age = \"年龄\",\n        sex = \"性别\",\n        ses = \"社会经济\\n地位\",\n        comorbidity = \"合并症\"\n    ),\n    exposure = \"exposure\",\n    outcome = \"outcome\"\n)\n\n# 设置节点位置（更清晰的布局）\ncoords <- list(\n    x = c(exposure = 0, outcome = 2, age = 0.5, sex = 1, ses = 1.5, comorbidity = 1),\n    y = c(exposure = 0, outcome = 0, age = 1, sex = 1, ses = 1, comorbidity = -1)\n)\n\nggdag(publication_dag, text = FALSE, use_labels = \"label\") +\n    theme_dag_blank() +\n    labs(\n        title = \"图1. 研究假设的有向无环图（DAG）\",\n        caption = \"节点表示变量，箭头表示假设的因果方向\"\n    ) +\n    theme(\n        plot.title = element_text(face = \"bold\", size = 14),\n        plot.caption = element_text(hjust = 0)\n    )\n```\n\n::: {.cell-output-display}\n![](1056-dag_files/figure-html/unnamed-chunk-17-1.png){width=100%}\n:::\n:::\n\n\n### DAG报告的标准语言\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\n\n**因果假设**\n\n图1展示了本研究假设的因果关系有向无环图（DAG）。基于先验知识和文献回顾，\n我们假设年龄、性别和社会经济地位是暴露因素和主要结局之间的混杂因素。\n合并症被认为是暴露通过影响健康状态到达结局的中介变量，因此在主分析中\n未予调整。\n\n根据后门准则，最小充分调整集为{年龄，性别，社会经济地位}。敏感性分析\n中，我们进一步调整合并症以估计暴露的直接效应。\n```\n\n\n:::\n:::\n\n\n---\n\n## 在线工具\n\n### DAGitty网站\n\n[DAGitty](https://www.dagitty.net/dags.html) 提供可视化的DAG编辑器：\n\n1. 拖拽创建节点\n2. 连线定义因果关系\n3. 自动计算调整集\n4. 导出R代码\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 从DAGitty网站导入DAG\nonline_dag <- downloadGraph(\"dagitty.net/mxXyzzy\")\n```\n:::\n\n\n---\n\n## 常见错误\n\n### 1. 调整中介变量\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 错误示例：想估计总效应但调整了中介\nbad_adjustment <- dagify(\n    Y ~ X + M,\n    M ~ X,\n    exposure = \"X\",\n    outcome = \"Y\"\n)\n\n# 如果调整M，会阻断X->M->Y路径\nggdag_paths(bad_adjustment, adjust_for = \"M\") +\n    theme_dag() +\n    labs(title = \"警告：调整中介变量会阻断因果路径\")\n```\n\n::: {.cell-output-display}\n![](1056-dag_files/figure-html/unnamed-chunk-20-1.png){width=100%}\n:::\n:::\n\n\n### 2. 调整碰撞因素\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 开放本应关闭的关联\nggdag_dseparated(collider_dag, controlling_for = \"C\") +\n    theme_dag() +\n    labs(title = \"警告：调整碰撞因素打开了偏倚路径\")\n```\n\n::: {.cell-output-display}\n![](1056-dag_files/figure-html/unnamed-chunk-21-1.png){width=100%}\n:::\n:::\n\n\n### 3. 选择偏倚\n\n当样本选择与暴露和结局都相关时，会产生选择偏倚：\n\n\n::: {.cell}\n\n```{.r .cell-code}\nselection_dag <- dagify(\n    S ~ X + Y,\n    Y ~ X,\n    labels = c(X = \"暴露\", Y = \"结局\", S = \"选择入组\"),\n    exposure = \"X\",\n    outcome = \"Y\"\n)\n\nggdag(selection_dag, text = FALSE, use_labels = \"label\") +\n    theme_dag() +\n    labs(\n        title = \"选择偏倚\",\n        subtitle = \"如果只分析S=1的人群，相当于调整了碰撞因素\"\n    )\n```\n\n::: {.cell-output-display}\n![](1056-dag_files/figure-html/unnamed-chunk-22-1.png){width=100%}\n:::\n:::\n\n\n---\n\n## 总结\n\n| 任务 | 函数/方法 |\n|------|-----------|\n| 创建DAG | `dagify()` 或 `dagitty()` |\n| 可视化 | `ggdag()` |\n| 识别调整集 | `adjustmentSets()` |\n| 识别路径 | `paths()` |\n| 检验d-分离 | `impliedConditionalIndependencies()` |\n| 识别碰撞 | `ggdag_collider()` |\n\n### 推荐资源\n\n- [DAGitty 在线工具](https://www.dagitty.net/)\n- [ggdag 文档](https://ggdag.malco.io/)\n- Hernán & Robins《因果推断》\n- Greenland et al. (1999) Epidemiology - DAG基础论文\n",
    "supporting": [
      "1056-dag_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}