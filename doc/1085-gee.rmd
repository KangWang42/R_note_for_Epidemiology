---
title: 广义估计方程 (GEE) 完整教程
subtitle: "处理重复测量与相关数据的稳健回归"
date: "2026-01-18"
image: images/1085-gee-cover.svg
categories:
- 统计分析方法
- 高级建模
- GEE
- longitudinal
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 7.4,
  fig.height = 4.8,
  dpi = 150,
  out.width = "100%",
  fig.path = "figure/1085-gee-"
)
```

```{r packages}
library(dplyr)
library(tidyr)
library(ggplot2)
library(geepack)
library(broom)
```

## 方法背景与适用场景

GEE（广义估计方程）是处理重复测量与相关数据的常用方法。
它不要求完整的随机效应分布假设，而是关注总体平均效应，
适合队列随访、聚类试验、医院/社区分层等“相关观测”场景。

它常用于纵向随访的重复测量数据、医院/班级等聚类数据，以及希望获得稳健标准误的广义线性模型场景。在这些研究里，同一簇内的观测不再独立，因此需要 GEE 来修正相关性带来的偏差。

## 模型入门与核心概念

GEE 可以理解为“广义线性模型 + 相关结构修正”。它先用和 GLM 类似的均值模型描述结局与协变量的关系，再引入工作相关结构来刻画同一簇内的相关性，最后通过稳健标准误保证推断可靠。这样做的结果是，GEE 更关注总体平均效应，而不是个体层面的随机效应，因此适合回答群体平均结局的变化。

## 模型假设与前提

GEE 假设簇内相关、簇间独立，均值模型结构合理。即使工作相关结构指定不完全准确，也可以依赖稳健标准误维持推断的可靠性，但前提是协变量与结局的均值关系设置正确。

## 通俗举例：为什么需要 GEE

想象我们对 100 名患者在 4 次随访中重复测量血压。
如果直接把 400 条记录当成独立样本，会忽略同一患者
之间的“相似性”，导致标准误被低估，结论看起来过于显著。
GEE 的价值就在于：它承认“同一患者的记录更接近”，
从而修正标准误，让结论更稳健。

## 方法对比：GEE vs 混合效应模型

GEE 关注总体平均效应，适合回答群体平均差异或政策效果问题；混合效应模型强调个体差异，更适合研究个体轨迹是否不同。换句话说，如果你的目标是“治疗是否改善了总体平均结局”，GEE 更合适；如果你关心的是“每个人变化是否一样”，混合效应模型更合适。

## 数据准备与变量定义

这里模拟一个随访数据：每位受试者在 4 个时间点测量连续结局。

```{r gee-data}
set.seed(2026)
subjects <- 120
visits <- 4

long_data <- tidyr::crossing(
  subject_id = 1:subjects,
  time = 1:visits
) |>
  mutate(
    treatment = if_else(subject_id %% 2 == 0, 1, 0),
    subject_effect = rnorm(subjects)[subject_id],
    time_effect = 0.4 * time,
    outcome = 5 + 1.2 * treatment + time_effect + subject_effect + rnorm(n())
  ) |>
  select(subject_id, time, treatment, outcome)

long_data
```

## 分析流程步骤

分析流程可以概括为四步：先建立忽略相关性的基线模型，再指定工作相关结构拟合 GEE，之后比较不同相关结构下的结果，最后解读稳健标准误与总体平均效应是否一致。这一流程强调“先理解，再修正，再解释”，避免一开始就陷入模型细节。

## 参数讲解与使用要点

`id` 用于标记聚类或受试者编号，决定哪些样本彼此相关；`corstr` 用于描述相关结构，常见的有 `independence`、`exchangeable` 和 `ar1`；`family` 与 GLM 类似，用来定义结局类型（连续、二分类、计数）。实际操作时，若你对相关性结构不了解，可先从 `independence` 作为基线，再尝试 `exchangeable` 或 `ar1` 看结果是否稳定。

## 代码实现

### 1. 基线模型（忽略相关）

```{r gee-glm}
glm_fit <- glm(outcome ~ treatment + time, data = long_data)
summary(glm_fit)
```

### 2. GEE：独立相关结构

```{r gee-independence}
gee_ind <- geeglm(
  outcome ~ treatment + time,
  id = subject_id,
  data = long_data,
  family = gaussian,
  corstr = "independence"
)

summary(gee_ind)
```

### 3. GEE：交换相关结构

```{r gee-exchangeable}
gee_exch <- geeglm(
  outcome ~ treatment + time,
  id = subject_id,
  data = long_data,
  family = gaussian,
  corstr = "exchangeable"
)

summary(gee_exch)
```

## 结果解读与报告

```{r gee-compare}
comparison <- bind_rows(
  tidy(glm_fit) |> mutate(model = "GLM"),
  tidy(gee_ind) |> mutate(model = "GEE (independence)"),
  tidy(gee_exch) |> mutate(model = "GEE (exchangeable)")
)

comparison
```

```{r gee-plot}
comparison |>
  filter(term != "(Intercept)") |>
  ggplot(aes(x = estimate, y = model, color = term)) +
  geom_point(size = 3) +
  geom_errorbarh(aes(xmin = estimate - 1.96 * std.error, xmax = estimate + 1.96 * std.error), height = 0.2) +
  labs(
    title = "GEE 与 GLM 参数对比",
    x = "估计值 (95% CI)",
    y = NULL
  ) +
  theme_minimal(base_size = 12)
```

报告时建议明确说明使用的相关结构（independence 或 exchangeable），并给出稳健标准误与置信区间。解读时强调 GEE 的系数代表总体平均效应，而不是个体层面的随机效应。
## 常见错误与纠偏

常见错误包括忽略相关性直接使用 GLM、随意选择相关结构、簇 ID 标记错误以及缺失值未处理。实践中建议通过比较不同相关结构的结果做敏感性分析，并在建模前明确簇定义与缺失处理策略。

## 进阶扩展

进阶应用可以尝试 `corstr = "ar1"` 处理时间序列相关，或在二分类结局下使用 `family = binomial`。若研究关注个体差异，也可以与混合效应模型并行分析，用来比较总体效应与个体效应的差异。
## 总结

GEE 是处理相关数据的稳健方法，强调总体平均效应。
对于纵向与聚类数据，建议以 GEE 作为基线模型，
并通过不同相关结构进行敏感性分析。